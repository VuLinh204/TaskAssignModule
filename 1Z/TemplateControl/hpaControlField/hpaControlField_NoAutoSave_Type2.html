<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>hpaControlField - Không AutoSave Type 2 (Textarea Batch)</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            body {
                padding: 40px;
                background: #fff3e0;
                font-family: system-ui, sans-serif;
            }
            h2 {
                color: #e65100;
            }
            .table {
                table-layout: fixed;
                width: 100%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            pre {
                background: #fff;
                border: 1px solid #ffcc80;
                border-radius: 8px;
            }
            th.col-id {
                width: 80px;
            }
            th.col-desc {
                width: calc(100% - 80px);
            }
        </style>
    </head>
    <body>
        <h2 class="mb-4">hpaControlField - Không AutoSave - Type 2 (Textarea Batch)</h2>
        <p>Sửa nhiều mô tả → bấm nút lưu batch</p>

        <button id="saveAll" class="btn btn-warning btn-lg mb-4">Lưu tất cả thay đổi</button>
        <button id="clearChanges" class="btn btn-secondary btn-lg mb-4 ms-2">Hủy thay đổi</button>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-warning">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-desc">Mô tả chi tiết</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>

        <div class="mt-5">
            <h5>Dữ liệu mẫu hiện tại:</h5>
            <pre id="dataPreview" class="p-3 rounded shadow-sm"></pre>
        </div>

        <script>
            let records = [
                { TaskID: 1, Description: 'Trang chủ mới với chart realtime, dark mode, responsive' },
                { TaskID: 2, Description: '' },
                { TaskID: 3, Description: 'API user: CRUD, JWT, refresh token, phân quyền' },
                { TaskID: 4, Description: '' },
            ];

            let pendingChanges = {};

            function renderTasks() {
                const $body = $('#taskBody').empty();
                records.forEach((record) => {
                    $body.append(`
                        <tr>
                            <td>${record.TaskID}</td>
                            <td class="field" data-field="Description">${record.Description || ''}</td>
                        </tr>
                    `);
                });
                applyFields();
                $('#dataPreview').text(JSON.stringify(records, null, 2));
            }

            // CONTROL NO AUTOSAVE TYPE 2 - TEXTAREA
            function hpaControlField(el) {
                const $el = $(el);
                const curVal = $el.text().trim();
                const $textarea = $(`<textarea class="form-control form-control-sm" rows="4" placeholder="Nhập mô tả...">${curVal}</textarea>`);
                $el.empty().append($textarea);

                $textarea.on('blur', () => {
                    const newVal = $textarea.val().trim();
                    if (newVal !== curVal) {
                        const rowId = $el.closest('tr').find('td:first').text();
                        if (!pendingChanges[rowId]) pendingChanges[rowId] = {};
                        pendingChanges[rowId].Description = newVal;
                        $el.css('background', '#fff8e1'); // Đánh dấu có thay đổi
                    }
                });

                $el.on('click', () => $textarea.focus());
            }

            function applyFields() {
                $('.field').each(function () {
                    hpaControlField(this);
                });
            }

            $('#saveAll').click(() => {
                if (Object.keys(pendingChanges).length === 0) return alert('Không có thay đổi nào!');
                Object.keys(pendingChanges).forEach((id) => {
                    const record = records.find((r) => r.TaskID == id);
                    if (record) Object.assign(record, pendingChanges[id]);
                });
                alert('Đã lưu batch tất cả mô tả!');
                pendingChanges = {};
                renderTasks();
            });

            $('#clearChanges').click(() => {
                if (Object.keys(pendingChanges).length === 0) return alert('Không có thay đổi để hủy!');
                pendingChanges = {};
                renderTasks();
                alert('Đã hủy thay đổi.');
            });

            $(document).ready(renderTasks);
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>hpaControlField - AutoSave Type 1 (Single Select)</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            body {
                padding: 40px;
                background: #e3f2fd;
                font-family: system-ui, sans-serif;
            }
            h2 {
                color: #01579b;
            }
            .table {
                table-layout: fixed;
                width: 100%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            pre {
                background: #fff;
                border: 1px solid #bbdefb;
                border-radius: 8px;
            }
            :root {
                --border-color: #cfd8dc;
                --task-primary: #0277bd;
                --text-muted: #78909c;
            }
            th.col-id {
                width: 80px;
            }
            th.col-status {
                width: calc(100% - 80px);
            }
        </style>
    </head>
    <body>
        <h2 class="mb-4">hpaControlField - Có AutoSave - Type 1 (Single Select + Search Local)</h2>
        <p>Single select • Search local • Tạo mới • Lưu ngay vào mảng</p>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-primary">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-status">Trạng thái</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>

        <div class="mt-5">
            <h5>Dữ liệu mẫu hiện tại:</h5>
            <pre id="dataPreview" class="p-3 rounded shadow-sm"></pre>
        </div>

        <script>
            // DỮ LIỆU MẪU
            let records = [
                { TaskID: 1, Status: 'Đang làm' },
                { TaskID: 2, Status: '' },
                { TaskID: 3, Status: 'Hoàn thành' },
                { TaskID: 4, Status: '' },
            ];

            let statuses = [
                { value: 'Đang làm', text: 'Đang làm' },
                { value: 'Chưa làm', text: 'Chưa làm' },
                { value: 'Hoàn thành', text: 'Hoàn thành' },
                { value: 'Tạm dừng', text: 'Tạm dừng' },
                { value: 'Hủy', text: 'Hủy' },
            ];

            function renderTasks() {
                const $body = $('#taskBody').empty();
                records.forEach((record) => {
                    $body.append(`
                        <tr>
                            <td>${record.TaskID}</td>
                            <td class="field" data-field="Status"></td>
                        </tr>
                    `);
                });
                applyFields();
                $('#dataPreview').text(JSON.stringify(records, null, 2));
            }

            // CONTROL AUTOSAVE TYPE 1
            function hpaControlField(el) {
                const $el = $(el);

                if (!window.__hpaControlFieldCSS) {
                    window.__hpaControlFieldCSS = true;
                    const style = document.createElement('style');
                    style.textContent = `
                        .hpa-field-wrapper { position: relative; width: 100%; }
                        .hpa-field-display { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; background: #fff; min-height: 38px; }
                        .hpa-field-display.focused { border-color: var(--task-primary); box-shadow: 0 0 0 4px rgba(2,119,189,0.1); }
                        .hpa-field-display.searching { padding: 0; }
                        .hpa-field-display.searching .hpa-field-inline-search { width: 100%; padding: 8px 12px; border: none; outline: none; background: transparent; font-size: inherit; }
                        .hpa-field-placeholder { color: var(--text-muted); }
                        .hpa-field-dropdown { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); max-height: 320px; overflow: auto; display: none; z-index: 3000; padding: 8px; }
                        .hpa-field-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; }
                        .hpa-field-item:hover { background: #e3f2fd; }
                        .hpa-field-item.selected { background: var(--task-primary); color: white; font-weight: 600; }
                        .hpa-field-create-row { font-weight: 600; color: var(--task-primary); }
                    `;
                    document.head.appendChild(style);
                }

                const wrapper = $(`<div class="hpa-field-wrapper"></div>`);
                const display = $(`<div class="hpa-field-display"><div class="hpa-field-text"></div><i class="bi bi-chevron-down ms-auto"></i></div>`);
                const dropdown = $(`<div class="hpa-field-dropdown"><div class="hpa-field-items"></div></div>`);
                wrapper.append(display).append(dropdown);
                $el.empty().append(wrapper);

                let selected = [];

                function renderDisplay() {
                    const $t = display.find('.hpa-field-text').empty();
                    if (selected.length === 0) {
                        $t.html(`<span class="hpa-field-placeholder">Chọn trạng thái...</span>`);
                    } else {
                        const item = statuses.find((o) => o.value === selected[0]);
                        $t.text(item ? item.text : selected[0]);
                    }
                }

                function renderList(filter = '') {
                    const container = dropdown.find('.hpa-field-items').empty();
                    let filtered = statuses;
                    if (filter) {
                        const q = filter.toLowerCase();
                        filtered = statuses.filter((o) => o.text.toLowerCase().includes(q));
                    }

                    filtered.forEach((o) => {
                        const isSel = selected.includes(o.value);
                        const item = $(`<div class="hpa-field-item ${isSel ? 'selected' : ''}">${o.text}</div>`);
                        item.on('click', () => {
                            selected = [o.value];
                            renderDisplay();
                            dropdown.hide();
                            display.removeClass('focused searching');

                            // AutoSave
                            const rowId = $el.closest('tr').find('td:first').text();
                            const record = records.find((r) => r.TaskID == rowId);
                            if (record) record.Status = o.value;
                            renderTasks();
                            alert('Cập nhật trạng thái thành công!');
                        });
                        container.append(item);
                    });

                    if (filter) {
                        const create = $(`<div class="hpa-field-item hpa-field-create-row">+ Thêm mới: "${filter}"</div>`);
                        create.on('click', () => {
                            const newItem = { value: filter, text: filter };
                            statuses.unshift(newItem);
                            selected = [filter];
                            renderDisplay();
                            renderList(filter);
                            renderTasks();
                            alert('Đã tạo trạng thái mới!');
                        });
                        container.prepend(create);
                    }
                }

                display.on('click', (e) => {
                    e.stopPropagation();
                    $('.hpa-field-dropdown').not(dropdown).hide();
                    display.addClass('focused searching');
                    const $search = $(`<input type="text" class="hpa-field-inline-search" placeholder="Tìm hoặc thêm mới...">`);
                    display.find('.hpa-field-text').html($search);
                    dropdown.show();
                    $search.focus();

                    renderList('');

                    $search.on('input', () => renderList($search.val()));
                    $search.on('keydown', (e) => {
                        if (e.key === 'Escape') {
                            display.removeClass('focused searching');
                            renderDisplay();
                            dropdown.hide();
                        }
                    });
                });

                $(document).on('click.hpaFieldClose', (e) => {
                    if (!wrapper.is(e.target) && wrapper.has(e.target).length === 0) {
                        display.removeClass('focused searching');
                        renderDisplay();
                        dropdown.hide();
                    }
                });

                // Load giá trị hiện tại
                const rowId = $el.closest('tr').find('td:first').text();
                const record = records.find((r) => r.TaskID == rowId);
                if (record && record.Status) selected = [record.Status];
                renderDisplay();
            }

            function applyFields() {
                $('.field').each(function () {
                    hpaControlField(this);
                });
            }

            $(document).ready(renderTasks);
        </script>
    </body>
</html>

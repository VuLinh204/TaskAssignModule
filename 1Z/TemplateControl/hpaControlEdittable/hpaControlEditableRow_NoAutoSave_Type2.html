<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Không AutoSave - Type 2 (Textarea)</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            body {
                padding: 40px;
                background: #fff3e0;
                font-family: system-ui, sans-serif;
            }
            h2 {
                color: #e65100;
            }
            .table {
                table-layout: fixed;
                width: 100%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            pre {
                background: #fff;
                border: 1px solid #ffcc80;
            }
            th.col-id {
                width: 80px;
            }
            th.col-desc {
                width: calc(100% - 80px);
            }
        </style>
    </head>
    <body>
        <h2 class="mb-4">Không AutoSave - Type = 2 (Textarea cho mô tả dài)</h2>
        <p>Sửa nhiều dòng mô tả → bấm "Lưu tất cả" để áp dụng batch</p>

        <button id="saveAll" class="btn btn-warning btn-lg mb-4">Lưu tất cả thay đổi</button>
        <button id="clearChanges" class="btn btn-secondary btn-lg mb-4 ms-2">Hủy thay đổi</button>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-warning">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-desc">Mô tả chi tiết (textarea)</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>

        <div class="mt-5">
            <h5>Dữ liệu mẫu hiện tại:</h5>
            <pre id="dataPreview" class="p-3 rounded shadow-sm"></pre>
        </div>

        <script>
            // DỮ LIỆU MẪU & CHANGES
            let tasks = [
                { TaskID: 1, Description: 'Trang chủ mới với chart realtime, dark mode, responsive trên mobile và desktop' },
                { TaskID: 2, Description: 'API user: đăng ký, đăng nhập JWT, refresh token, phân quyền admin/user, quên mật khẩu' },
                { TaskID: 3, Description: 'Test thanh toán VNPay: checkout, callback, refund, xử lý lỗi mạng' },
                { TaskID: 4, Description: '' },
            ];

            let pendingChanges = {};

            function renderTasks() {
                const $body = $('#taskBody').empty();
                tasks.forEach((task) => {
                    $body.append(`
                        <tr>
                            <td>${task.TaskID}</td>
                            <td class="editable" data-id="${task.TaskID}" data-col="Description">${task.Description || ''}</td>
                        </tr>
                    `);
                });
                applyControls();
                $('#dataPreview').text(JSON.stringify(tasks, null, 2));
            }

            // CONTROL KHÔNG AUTOSAVE - TYPE 2 (TEXTAREA)
            function hpaControlEditableRow(el) {
                const $el = $(el);

                if (!window.__cssInjected) {
                    const style = document.createElement('style');
                    style.textContent = `
            .hpa-editable-row { cursor: pointer; padding: 8px 4px; border-radius: 4px; transition: all 0.2s; display: table-cell !important; vertical-align: middle; min-height: 1.5em; width: 100%; }
            .hpa-editable-row:hover { background: #ffe0b2; }
            .hpa-editable-row.editing { padding: 4px 8px; z-index: 100 !important; background: white; display: table-cell !important; }
            .hpa-editable-row.editing textarea { width: 100% !important; padding: 6px 10px; border: 1px solid #ef6c00 !important; box-sizing: border-box; min-height: 100px; font-size: inherit; }
            .hpa-editable-row .edit-actions { position: absolute; top: 110%; left: 0; right: 0; display: flex; justify-content: flex-end; gap: 4px; background: white; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 101; }
            .hpa-editable-row .btn-edit { width: 28px; height: 28px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #e8eaed; background: white; cursor: pointer; transition: all 0.2s; }
            .hpa-editable-row .btn-edit:hover { transform: scale(1.1); }
            .hpa-editable-row .btn-save { background: #ef6c00; color: white; }
            .hpa-editable-row .btn-cancel { color: #676879; }
            .hpa-editable-row:not(.editing) { white-space: normal; line-height: 1.5; }
        `;
                    document.head.appendChild(style);
                    window.__cssInjected = true;
                }

                $el.addClass('hpa-editable-row');

                $el.off('click.ed').on('click.ed', function (e) {
                    $('.hpa-editable-row.editing').not($el).find('.btn-save').click();
                    e.stopPropagation();
                    e.preventDefault();
                    if ($el.hasClass('editing')) return;

                    const curVal = $el.text().trim();
                    $el.css({ 'white-space': 'normal', overflow: 'visible' });

                    const $input = $(`<textarea class="form-control form-control-sm" rows="5">`).val(curVal);

                    const $save = $(`<button class="btn-edit btn-save"><i class="bi bi-check-lg"></i></button>`);
                    const $cancel = $(`<button class="btn-edit btn-cancel"><i class="bi bi-x-lg"></i></button>`);

                    const $actions = $(`<div class="edit-actions"></div>`).append($save).append($cancel);
                    const $wrap = $(`<div class="position-relative w-100"></div>`).append($input).append($actions);

                    $el.addClass('editing').html('').append($wrap);
                    setTimeout(() => $input[0].focus(), 50);

                    const finish = (saveIt) => {
                        const newVal = $input.val().trim();
                        $save.off();
                        $cancel.off();
                        $input.off();
                        $(document).off('click.ed');
                        $el.removeClass('editing');

                        if (!saveIt || newVal === curVal) {
                            $el.text(curVal);
                            return;
                        }

                        // Chỉ cập nhật UI + lưu tạm
                        $el.text(newVal);
                        const id = $el.data('id');
                        if (!pendingChanges[id]) pendingChanges[id] = {};
                        pendingChanges[id].Description = newVal;
                    };

                    $save.click((e) => {
                        e.stopPropagation();
                        finish(true);
                    });
                    $cancel.click((e) => {
                        e.stopPropagation();
                        finish(false);
                    });
                    $(document).one('click.ed', (e) => !$(e.target).closest($el).length && finish(true));
                });
            }

            function applyControls() {
                $('.editable').each(function () {
                    hpaControlEditableRow(this);
                });
            }

            $('#saveAll').click(() => {
                if (Object.keys(pendingChanges).length === 0) return alert('Không có thay đổi nào!');
                Object.keys(pendingChanges).forEach((id) => {
                    const task = tasks.find((t) => t.TaskID == id);
                    if (task) Object.assign(task, pendingChanges[id]);
                });
                alert('Đã lưu batch tất cả mô tả!');
                pendingChanges = {};
                renderTasks();
            });

            $('#clearChanges').click(() => {
                if (Object.keys(pendingChanges).length === 0) return alert('Không có thay đổi để hủy!');
                pendingChanges = {};
                renderTasks();
                alert('Đã hủy tất cả thay đổi.');
            });

            $(renderTasks);
        </script>
    </body>
</html>

<script>
    window['DataSource_EmployeeID'] = window['DataSource_EmployeeID'] || [];
    let EmployeeIDDataSourceLoaded = false;

    let spNameDSEEmployeeID = 'EmployeeListAll_DataSetting_Custom';

    function loadDataSourceEmployeeID() {
        if (EmployeeIDDataSourceLoaded || !spNameDSEEmployeeID) return;

        AjaxHPAParadise({
            data: {
                name: spNameDSEEmployeeID,
                param: ['LoginID', LoginID, 'LanguageID', LanguageID],
            },
            success: function (res) {
                const json = typeof res === 'string' ? JSON.parse(res) : res;
                window['DataSource_EmployeeID'] = (json.data && json.data[0]) || [];
                EmployeeIDDataSourceLoaded = true;
                if (InstanceEmployeeID && typeof InstanceEmployeeID.setDataSource === 'function') {
                    InstanceEmployeeID.setDataSource(window['DataSource_EmployeeID']);
                }
            },
            error: function (err) {
                console.error('Failed to load datasource:', err);
            },
        });
    }

    loadDataSourceEmployeeID();

    let InstanceEmployeeID,
        EmployeeIDSelectedIds = [];
    let EmployeeIDAvatarCache = {};
    const MAX_VISIBLE_EmployeeID = 3;

    function getInitialsEmployeeID(name) {
        if (!name) return '?';
        const words = name.trim().split(/\s+/);
        if (words.length >= 2) return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        return name.substring(0, 2).toUpperCase();
    }

    function getColorForIdEmployeeID(id) {
        const colors = [
            { bg: '#e3f2fd', text: '#1976d2' },
            { bg: '#f3e5f5', text: '#7b1fa2' },
            { bg: '#e8f5e9', text: '#388e3c' },
            { bg: '#fff3e0', text: '#f57c00' },
            { bg: '#fce4ec', text: '#c2185b' },
        ];
        return colors[Math.abs(id) % colors.length];
    }

    function renderDisplayBoxEmployeeID() {
        const $displayBox = $('#EmployeeID_display');
        if (!$displayBox.length) return;
        $displayBox.empty();

        const $wrapper = $('<div>')
            .css({
                border: '1px solid #dee2e6',
                borderRadius: '8px',
                padding: '10px 12px',
                backgroundColor: '#fff',
                minHeight: '44px',
                display: 'flex',
                alignItems: 'center',
                cursor: 'pointer',
            })
            .hover(
                () => $wrapper.css({ borderColor: '#0d6efd', boxShadow: '0 0 0 0.2rem rgba(13,110,253,.15)' }),
                () => $wrapper.css({ borderColor: '#dee2e6', boxShadow: 'none' })
            );

        if (EmployeeIDSelectedIds.length === 0) {
            $wrapper.append($('<span>').addClass('text-muted').html('<i class="bi bi-person-plus me-2"></i>Chọn nhân viên...'));
        } else {
            const displayIds = EmployeeIDSelectedIds.slice(0, MAX_VISIBLE_EmployeeID);
            const $group = $('<div>').css({ display: 'flex', alignItems: 'center' });

            displayIds.forEach((id, index) => {
                const item = window['DataSource_EmployeeID'].find((e) => String(e.ID) === String(id));
                if (!item) return;

                const $chip = $('<div>')
                    .css({
                        width: '36px',
                        height: '36px',
                        borderRadius: '50%',
                        background: '#f8f9fa',
                        border: '3px solid #fff',
                        boxShadow: '0 2px 6px rgba(0,0,0,0.15)',
                        marginLeft: index === 0 ? '0' : '-10px',
                        zIndex: MAX_VISIBLE_EmployeeID - index,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontWeight: '600',
                        fontSize: '13px',
                        position: 'relative',
                        overflow: 'hidden',
                    })
                    .attr('title', item.Name || item.FullName || '');

                const cacheKey = (item.storeImgName || '') + '|' + (item.paramImg || '');
                const cachedUrl = EmployeeIDAvatarCache[cacheKey];

                if (cachedUrl) {
                    $chip.append(
                        $('<img>').attr('src', cachedUrl).css({
                            width: '100%',
                            height: '100%',
                            objectFit: 'cover',
                        })
                    );
                } else if (item.storeImgName) {
                    let paramArray = [];
                    if (item.paramImg) {
                        const decoded = decodeURIComponent(item.paramImg);
                        paramArray = JSON.parse(decoded);
                    }
                    AjaxHPAParadise({
                        data: {
                            name: item.storeImgName,
                            param: paramArray,
                        },
                        xhrFields: { responseType: 'blob' },
                        cache: true,
                        success: function (blob) {
                            if (!blob || blob.size === 0) {
                                renderFallback();
                            } else {
                                const url = URL.createObjectURL(blob);
                                EmployeeIDAvatarCache[cacheKey] = url;
                                $chip.empty().append(
                                    $('<img>').attr('src', url).css({
                                        width: '100%',
                                        height: '100%',
                                        objectFit: 'cover',
                                    })
                                );
                            }
                        },
                        error: renderFallback,
                    });
                } else {
                    renderFallback();
                }

                function renderFallback() {
                    const color = getColorForIdEmployeeID(id);
                    const initials = getInitialsEmployeeID(item.Name || item.FullName);
                    $chip.css({ background: color.bg, color: color.text }).text(initials);
                }

                $group.append($chip);
            });

            if (EmployeeIDSelectedIds.length > MAX_VISIBLE_EmployeeID) {
                const remaining = EmployeeIDSelectedIds.length - MAX_VISIBLE_EmployeeID;
                $group.append(
                    $('<div>')
                        .css({
                            width: '36px',
                            height: '36px',
                            borderRadius: '50%',
                            background: '#6c757d',
                            color: '#fff',
                            border: '3px solid #fff',
                            marginLeft: '-10px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontWeight: '700',
                            fontSize: '12px',
                        })
                        .text('+' + remaining)
                        .attr('title', 'Còn ' + remaining + ' người nữa')
                );
            }

            $wrapper.append($group);
        }

        $displayBox.append($wrapper);
        $wrapper.off('click').on('click', () => {
            if (!popupEmployeeID) {
                initPopupEmployeeID();
            }
            popupEmployeeID.show();
        });
    }

    const $container = $('#F2A868A2EDEE4D5F934B2319533483AA');
    $container.empty();
    const $displayBox = $('<div>').attr('id', 'EmployeeID_display');
    $container.append($displayBox);

    let popupEmployeeID;

    function initPopupEmployeeID() {
        popupEmployeeID = $('<div>')
            .attr('id', 'EmployeeID_popup')
            .appendTo($container)
            .dxPopup({
                width: 750,
                height: 600,
                showTitle: true,
                title: 'Chọn nhân viên',
                dragEnabled: true,
                closeOnOutsideClick: true,
                showCloseButton: true,
                toolbarItems: [
                    {
                        widget: 'dxButton',
                        location: 'after',
                        toolbar: 'bottom',
                        options: {
                            text: 'Xác nhận',
                            type: 'success',
                            onClick: () => {
                                popupEmployeeID.hide();
                            },
                        },
                    },
                ],
                contentTemplate: () => $('<div>').attr('id', 'EmployeeID_grid'),
                onShown: () => {
                    // Sort dataSource: selected items first, then others
                    const sortedData = window['DataSource_EmployeeID'].sort((a, b) => {
                        const aSelected = EmployeeIDSelectedIds.includes(String(a.ID));
                        const bSelected = EmployeeIDSelectedIds.includes(String(b.ID));
                        return bSelected - aSelected; // Selected items first (true=1, false=0)
                    });

                    $('#EmployeeID_grid').dxDataGrid({
                        dataSource: sortedData,
                        keyExpr: 'ID',
                        columnAutoWidth: true,
                        allowColumnResizing: true,
                        selection: { mode: 'multiple', showCheckBoxesMode: 'always' },
                        selectedRowKeys: EmployeeIDSelectedIds,
                        columns: [
                            {
                                caption: 'Ảnh',
                                width: 80,
                                alignment: 'center',
                                cellTemplate: function (container, options) {
                                    const item = options.data;
                                    const $cell = $('<div>').css({
                                        display: 'flex',
                                        justifyContent: 'center',
                                        alignItems: 'center',
                                        height: '100%',
                                    });

                                    const cacheKey = (item.storeImgName || '') + '|' + (item.paramImg || '');
                                    const cachedUrl = EmployeeIDAvatarCache[cacheKey];

                                    if (cachedUrl) {
                                        $cell.append(
                                            $('<img>').attr('src', cachedUrl).css({
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                objectFit: 'cover',
                                                border: '2px solid #fff',
                                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                            })
                                        );
                                    } else if (item.storeImgName) {
                                        let paramArray = [];
                                        if (item.paramImg) {
                                            const decoded = decodeURIComponent(item.paramImg);
                                            paramArray = JSON.parse(decoded);
                                        }
                                        AjaxHPAParadise({
                                            data: {
                                                name: item.storeImgName,
                                                param: paramArray,
                                            },
                                            xhrFields: { responseType: 'blob' },
                                            cache: true,
                                            success: function (blob) {
                                                if (!blob || blob.size === 0) {
                                                    console.warn('[EMPTY BLOB] Ảnh rỗng hoặc không hợp lệ');
                                                    return renderFallback();
                                                }

                                                const url = URL.createObjectURL(blob);
                                                EmployeeIDAvatarCache[cacheKey] = url;

                                                $cell.empty().append(
                                                    $('<img>').attr('src', url).css({
                                                        width: '40px',
                                                        height: '40px',
                                                        borderRadius: '50%',
                                                        objectFit: 'cover',
                                                        border: '2px solid #fff',
                                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                                    })
                                                );
                                            },
                                            error: function () {
                                                renderFallback();
                                            },
                                        });
                                    } else {
                                        renderFallback();
                                    }

                                    function renderFallback() {
                                        const initials = getInitialsEmployeeID(item.Name || item.FullName || '?');
                                        const color = getColorForIdEmployeeID(item.ID);
                                        $cell.empty().append(
                                            $('<div>').text(initials).css({
                                                width: '40px',
                                                height: '40px',
                                                borderRadius: '50%',
                                                background: color.bg,
                                                color: color.text,
                                                display: 'flex',
                                                justifyContent: 'center',
                                                alignItems: 'center',
                                                fontWeight: '600',
                                                fontSize: '14px',
                                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                            })
                                        );
                                    }

                                    container.append($cell);
                                },
                            },
                            { dataField: 'Name', caption: 'Họ tên' },
                            { dataField: 'Email', caption: 'Email' },
                            { dataField: 'Position', caption: 'Chức vụ' },
                        ],
                        searchPanel: { visible: true },
                        paging: { pageSize: 10 },
                        onSelectionChanged: (e) => (EmployeeIDSelectedIds = e.selectedRowKeys || []),
                    });
                },
                onHidden: () => renderDisplayBoxEmployeeID(),
            })
            .dxPopup('instance');
    }

    InstanceEmployeeID = {
        setValue: function (val) {
            if (typeof val === 'string' && val.trim()) {
                EmployeeIDSelectedIds = val
                    .split(',')
                    .map((v) => v.trim())
                    .filter((v) => v);
            } else if (Array.isArray(val)) {
                EmployeeIDSelectedIds = val.map(String);
            } else {
                EmployeeIDSelectedIds = [];
            }
            renderDisplayBoxEmployeeID();
        },
        getValue: () => EmployeeIDSelectedIds,
        getValueAsString: () => EmployeeIDSelectedIds.join(','),
        setDataSource: (data) => {
            window['DataSource_EmployeeID'] = data || [];
        },
        repaint: renderDisplayBoxEmployeeID,
        option: function (name, value) {
            if (arguments.length === 2) {
                if (name === 'value') {
                    this.setValue(value);
                }
            } else if (arguments.length === 1) {
                if (name === 'value') {
                    return this.getValueAsString();
                }
                if (name === 'dataSource') {
                    return window['DataSource_EmployeeID'];
                }
            }
            return undefined;
        },
        _suppressValueChangeAction: function () {},
        _resumeValueChangeAction: function () {},
    };

    renderDisplayBoxEmployeeID();
</script>

<script>
    function initializeGrid() {
            taskGridInstance = $("#taskGrid").dxDataGrid({
                dataSource: [],
                keyExpr: "TaskID",
                showBorders: true,
                showRowLines: true,
                showColumnLines: false,
                rowAlternationEnabled: false,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnResizingMode: "widget",
                wordWrapEnabled: true,

                // ===== ROW DRAGGING =====
                rowDragging: {
                    allowReordering: true,
                    showDragIcons: true,
                    dropFeedbackMode: "indicate",
                    onReorder: function(e) {
                        var visibleRows = e.component.getVisibleRows();
                        var toIndex = e.toIndex;
                        var fromIndex = visibleRows.findIndex(function(row) {
                            return row.data.TaskID === e.itemData.TaskID;
                        });
                        var tasksCopy = allTasks.slice();
                        var movedTask = tasksCopy.splice(fromIndex, 1)[0];
                        tasksCopy.splice(toIndex, 0, movedTask);
                        allTasks = tasksCopy;
                        saveTaskOrder(e.itemData, toIndex);
                        e.component.option("dataSource", allTasks);
                    }
                },

                // ===== TOOLBAR =====
                toolbar: {
                    items: [{
                            location: "before",
                            template: function() {
                                return $("<div>").css({
                                    fontWeight: "600",
                                    fontSize: "14px",
                                    color: "var(--text-secondary)"
                                }).text("Danh sách công việc");
                            }
                        },
                        "groupPanel",
                        "exportButton",
                        "columnChooserButton",
                        "searchPanel"
                    ]
                },

                // ===== SELECTION =====
                selection: {
                    mode: "multiple",
                    showCheckBoxesMode: "onClick",
                    allowSelectAll: true
                },

                // ===== PAGING =====
                paging: {
                    enabled: true,
                    pageSize: 50
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [10, 20, 50, 100],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },

                // ===== GROUPING =====
                grouping: {
                    autoExpandAll: true,
                    contextMenuEnabled: true
                },
                groupPanel: {
                    visible: true,
                    emptyPanelText: "Kéo cột vào đây để nhóm theo tiêu chí"
                },

                // ===== FILTERING =====
                filterRow: {
                    visible: false,
                    applyFilter: "auto"
                },
                searchPanel: {
                    visible: true,
                    width: 240,
                    placeholder: "Tìm kiếm công việc..."
                },
                headerFilter: {
                    visible: true
                },

                // ===== COLUMN CHOOSER =====
                columnChooser: {
                    enabled: true,
                    mode: "select",
                    title: "Chọn cột hiển thị"
                },

                // ===== EXPORT =====
                export: {
                    enabled: true,
                    fileName: "CongViecCuaToi",
                    allowExportSelectedData: true
                },

                // ===== STATE STORING =====
                stateStoring: {
                    enabled: true,
                    type: "localStorage",
                    storageKey: "taskGridState"
                },

                // ===== SORTING & SCROLLING =====
                sorting: {
                    mode: "multiple"
                },
                scrolling: {
                    mode: "virtual",
                    rowRenderingMode: "virtual",
                    showScrollbar: "onHover"
                },
                columnFixing: {
                    enabled: true
                },

                // ===== COLUMNS CONFIGURATION =====
                columns: [
                    // ===== DRAG HANDLE =====
                    {
                        type: "drag",
                        width: 50,
                        allowReordering: false,
                        allowGrouping: false,
                        allowSorting: false,
                        allowFiltering: false,
                        allowExporting: false,
                        fixed: true,
                        fixedPosition: "left",
                        cellTemplate: function(container, options) {
                            $("<i>").addClass("bi bi-grip-vertical drag-handle")
                                .attr("title", "Kéo để sắp xếp")
                                .appendTo(container);
                        }
                    },
                    // ===== TASK ID =====
                    {
                        dataField: "TaskID",
                        caption: "ID",
                        width: 80,
                        alignment: "center",
                        allowEditing: false,
                        fixed: false,
                        sortOrder: "desc"
                    },
                    // ===== GROUP ID =====
                    {
                        dataField: "GroupID",
                        caption: "Nhóm",
                        width: 120,
                        alignment: "center",
                        allowGrouping: true,
                        allowFiltering: true,
                        visible: true,
                        cellTemplate: function(container, options) {
                            var groupId = options.value;
                            if (groupId === null || groupId === undefined) {
                                $("<span>").css("color", "var(--text-muted)").text("-").appendTo(container);
                            } else {
                                $("<span>").text("#" + groupId).appendTo(container);
                            }
                        }
                    },
                    // ===== PARENT TASK ID =====
                    {
                        dataField: "ParentTaskID",
                        caption: "Task cha",
                        width: 100,
                        alignment: "center",
                        allowGrouping: false,
                        allowFiltering: true,
                        visible: true,
                        cellTemplate: function(container, options) {
                            var parentId = options.value;
                            if (parentId === null || parentId === undefined) {
                                $("<span>").css({
                                    color: "var(--success-color)",
                                    fontWeight: "600"
                                }).text("Parent").appendTo(container);
                            } else {
                                $("<span>").css({
                                    color: "var(--text-secondary)"
                                }).text("Child").appendTo(container);
                            }
                        }
                    },
                    // ===== TASK NAME (INLINE EDIT) =====
                    {
                        dataField: "TaskName",
                        caption: "Tên công việc",
                        minWidth: 250,
                        cellTemplate: function(container, options) {
                            var task = options.data;
                            var taskID = task.TaskID;
                            var containerId = "TaskNameDiv_" + taskID;
                            var $wrapper = $("<div>")
                                .attr("id", containerId)
                                .data("record", task)
                                .css({
                                    width: "100%",
                                    minHeight: "40px",
                                    cursor: "pointer"
                                });
                            var $displayDiv = $("<div>").addClass("task-name-cell");
                            $("<div>").addClass("task-name-title").text(task.TaskName).appendTo($displayDiv);
                            var $meta = $("<div>").addClass("task-name-meta");
                            if (task.CommentCount > 0) {
                                $("<span>").addClass("task-comment-badge")
                                    .html(`<i class="bi bi-chat-dots"></i> ${task.CommentCount} bình luận`)
                                    .appendTo($meta);
                            }
                            $("<span>").text("#" + taskID).appendTo($meta);
                            if (task.ParentTaskName) {
                                $("<span>").html(`<i class="bi bi-diagram-3"></i> ${task.ParentTaskName}`)
                                    .appendTo($meta);
                            }
                            $meta.appendTo($displayDiv);
                            $wrapper.append($displayDiv);
                            var textBoxInstance = null;
                            var $controlContainer = null;
                            var isEditing = false;
                            var originalValue = task.TaskName;
                            var animationFrameId = null;
                            var lastPosition = null;

                            function updatePopupPosition() {
                                if (!actionPopupInstance || !actionPopupInstance.option("visible") || !textBoxInstance) {
                                    return;
                                }
                                try {
                                    var $inputElement = $(textBoxInstance.element());
                                    if (!$inputElement.is('':visible'')) {
                                        return;
                                    }
                                    var rect = $inputElement[0].getBoundingClientRect();
                                    var currentPosition = {
                                        top: rect.top,
                                        left: rect.left,
                                        width: rect.width,
                                        height: rect.height
                                    };
                                    if (!lastPosition ||
                                        lastPosition.top !== currentPosition.top ||
                                        lastPosition.left !== currentPosition.left) {
                                        actionPopupInstance.option("position", {
                                            at: "bottom right",
                                            my: "top right",
                                            of: $inputElement,
                                            collision: "fit flip",
                                            offset: "0 4"
                                        });
                                        lastPosition = currentPosition;
                                    }
                                } catch (e) {
                                    // Ignore errors
                                }
                            }

                            function positionUpdateLoop() {
                                if (isEditing && textBoxInstance) {
                                    updatePopupPosition();
                                    animationFrameId = requestAnimationFrame(positionUpdateLoop);
                                }
                            }

                            function startPositionUpdates() {
                                if (animationFrameId) {
                                    cancelAnimationFrame(animationFrameId);
                                }
                                lastPosition = null;
                                positionUpdateLoop();
                            }

                            function stopPositionUpdates() {
                                if (animationFrameId) {
                                    cancelAnimationFrame(animationFrameId);
                                    animationFrameId = null;
                                }
                                lastPosition = null;
                            }

                            function exitEditMode(cancel) {
                                if (!isEditing) return;
                                isEditing = false;
                                stopPositionUpdates();
                                if (actionPopupInstance && actionPopupInstance.option("visible")) {
                                    actionPopupInstance.hide();
                                }
                                $(document).off("click.editTaskName" + taskID);
                                if (cancel) {
                                    if (textBoxInstance) {
                                        textBoxInstance.option("value", originalValue);
                                    }
                                    $displayDiv.find(".task-name-title").text(originalValue);
                                    task.TaskName = originalValue;
                                } else {
                                    if (textBoxInstance) {
                                        var newValue = textBoxInstance.option("value");
                                        originalValue = newValue;
                                        task.TaskName = newValue;
                                        $displayDiv.find(".task-name-title").text(newValue);
                                    }
                                }
                                if ($controlContainer) {
                                    $controlContainer.hide();
                                }
                                $displayDiv.show();
                            }

                            $wrapper.on("click", function(e) {
                                e.stopPropagation();
                                if (isEditing) return;
                                isEditing = true;
                                $displayDiv.hide();
                                if (!$controlContainer || !$controlContainer.length) {
                                    $controlContainer = $("<div>").css({
                                        width: "100%"
                                    });
                                    $wrapper.append($controlContainer);
                                    textBoxInstance = $controlContainer.dxTextBox({
                                        value: originalValue,
                                        width: "100%",
                                        inputAttr: {
                                            class: "form-control form-control-sm",
                                            style: "font-size: 14px;"
                                        },
                                        onFocusIn: function(e) {
                                            $(e.element).find("input").css("border", "1px solid #1c975e");
                                        },
                                        onFocusOut: function(e) {
                                            $(e.element).find("input").css("border", "");
                                        },
                                        onKeyDown: function(e) {
                                            if (e.event.key === "Enter") {
                                                e.event.preventDefault();
                                                saveValue();
                                            }
                                            if (e.event.key === "Escape") {
                                                e.event.preventDefault();
                                                exitEditMode(true);
                                            }
                                        }
                                    }).dxTextBox("instance");
                                } else {
                                    $controlContainer.show();
                                    if (textBoxInstance) {
                                        textBoxInstance.option("value", originalValue);
                                    }
                                }

                                setTimeout(function() {
                                    if (textBoxInstance) {
                                        var $inputElement = $(textBoxInstance.element());
                                        showActionPopup($inputElement, "TaskName_" + taskID,
                                            async () => {
                                                    await saveValue();
                                                },
                                                () => {
                                                    exitEditMode(true);
                                                }
                                        );
                                        startPositionUpdates();
                                    }
                                }, 100);

                                setTimeout(() => {
                                    $(document).on("click.editTaskName" + taskID, function(ev) {
                                        var $t = $(ev.target);
                                        if (!$t.closest($wrapper).length &&
                                            !$t.closest(".dx-popup-wrapper").length &&
                                            !$t.closest(".dx-texteditor").length) {
                                            exitEditMode(true);
                                        }
                                    });
                                }, 150);

                                setTimeout(() => {
                                    if (textBoxInstance) {
                                        textBoxInstance.focus();
                                    }
                                }, 120);
                            });

                            async function saveValue() {
                                if (!textBoxInstance) {
                                    exitEditMode(false);
                                    return;
                                }
                                var newVal = textBoxInstance.option("value");
                                if (newVal === originalValue) {
                                    exitEditMode(false);
                                    return;
                                }
                                try {
                                    await saveFunction(
                                        JSON.stringify([-99218308, ["TaskName"],
                                            [newVal]
                                        ]),
                                        [
                                            [taskID], "TaskID"
                                        ]
                                    );
                                    originalValue = newVal;
                                    task.TaskName = newVal;
                                    $displayDiv.find(".task-name-title").text(newVal);
                                    uiManager.showAlert({
                                        type: "success",
                                        message: "Lưu thành công"
                                    });
                                    exitEditMode(false);
                                } catch (err) {
                                    uiManager.showAlert({
                                        type: "error",
                                        message: "Có lỗi xảy ra khi lưu"
                                    });
                                }
                            }

                            container.append($wrapper);
                        }
                    },
                    // ===== ASSIGN PRIORITY (INLINE EDIT) =====
                    {
                        dataField: "AssignPriority",
                        caption: "Ưu tiên",
                        width: 100,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const task = options.data;
                            const taskID = task.TaskID;
                            const containerId = "PriorityDiv_" + taskID;
                            const $wrapper = $("<div>").attr("id", containerId).css({ width: "100%", cursor: "pointer" });

                            const priority = options.value || 3;
                            const prioMap = {
                                1: { text: "Cao", icon: "bi-flag-fill", colorClass: "text-danger" },
                                2: { text: "Trung bình", icon: "bi-flag", colorClass: "text-warning" },
                                3: { text: "Thấp", icon: "bi-flag", colorClass: "text-secondary" }
                            };
                            const info = prioMap[priority] || prioMap[3];

                            const $icon = $(`<i class="${info.icon} ${info.colorClass}" style="font-size:18px;" title="${info.text}"></i>`);
                            $wrapper.append($icon);

                            let isEditing = false;
                            let originalPrio = priority;

                            $wrapper.on("click", function(e) {
                                e.stopPropagation();
                                if (isEditing) return;
                                isEditing = true;
                                $icon.hide();

                                const $controlContainer = $("<div>").css({ width: "100%" });
                                $wrapper.append($controlContainer);

                                const prioDataSource = Object.keys(prioMap).map(k => ({
                                    ID: parseInt(k),
                                    Name: prioMap[k].text,
                                    Icon: prioMap[k].icon,
                                    ColorClass: prioMap[k].colorClass
                                }));

                                $controlContainer.dxSelectBox({
                                    dataSource: prioDataSource,
                                    valueExpr: "ID",
                                    displayExpr: "Name",
                                    value: priority,
                                    searchEnabled: true,
                                    showClearButton: true,
                                    width: "100%",
                                    dropDownOptions: {
                                        width: 200,
                                        maxHeight: 300,
                                        container: "#sp_Task_MyWork_html",
                                        position: { my: "top left", at: "bottom left", of: $wrapper, offset: "0 4", collision: "flip fit" }
                                    },
                                    itemTemplate: function(data) {
                                        return $("<div class='d-flex align-items-center gap-2 px-2 py-1'>")
                                            .append(
                                                $(`<i class="${data.Icon} ${data.ColorClass}" style="font-size:16px;"></i>`),
                                                $("<span class='fw-normal'>").text(data.Name)
                                            );
                                    },
                                    onValueChanged: async function(e) {
                                        if (e.value !== originalPrio) {
                                            try {
                                                await saveFunction(
                                                    JSON.stringify([-99218308, ["AssignPriority"], [e.value]]),
                                                    [[taskID], "TaskID"]
                                                );
                                                task.AssignPriority = e.value;
                                                originalPrio = e.value;
                                                const newInfo = prioMap[e.value] || prioMap[3];
                                                $icon.removeClass().addClass(newInfo.icon + " " + newInfo.colorClass).attr("title", newInfo.text);
                                                uiManager.showAlert({ type: "success", message: "Lưu ưu tiên" });
                                            } catch (err) {
                                                uiManager.showAlert({ type: "error", message: "Lỗi lưu ưu tiên" });
                                            }
                                        }
                                        exitEditMode(false);
                                    },
                                    onInitialized: function(e) {
                                        setTimeout(() => e.component.open(), 100);
                                    }
                                });

                                setTimeout(() => {
                                    $(document).on("click.outsidePrio" + taskID, function(ev) {
                                        if (!$(ev.target).closest($wrapper).length && !$(ev.target).closest(".dx-selectbox").length) {
                                            exitEditMode(true);
                                        }
                                    });
                                }, 150);

                                function exitEditMode(cancel) {
                                    isEditing = false;
                                    $(document).off("click.outsidePrio" + taskID);
                                    $controlContainer.remove();
                                    if (cancel) {
                                        const rollback = prioMap[originalPrio] || prioMap[3];
                                        $icon.removeClass().addClass(rollback.icon + " " + rollback.colorClass).attr("title", rollback.text);
                                    }
                                    $icon.show();
                                }
                            });

                            container.append($wrapper);
                        }
                    },
                    // ===== NGƯỜI THỰC HIỆN (CLICK TO OPEN POPUP) =====
                    {
                        dataField: "AssignedToEmployeeIDs",
                        caption: "Người thực hiện",
                        width: 200,
                        allowSorting: false,
                        cellTemplate: function(container, options) {
                            var task = options.data;
                            var taskID = task.TaskID;
                            var id = "EmployeeIDDiv_" + taskID;
                            var controlDiv = $("<div>").attr("id", id).data("record", task).on("click", function(e) {
                                e.stopPropagation();
                                AssignedToEmployeeIDsControl = loadUI_EmployeeID();
                                AssignedToEmployeeIDsControl.setValue(task.AssignedToEmployeeIDs);
                                AssignedToEmployeeIDsKey = {
                                    TaskID: task.TaskID
                                };
                            });
                            var empIds = task.AssignedToEmployeeIDs ? task.AssignedToEmployeeIDs.split(",") : [];
                            var empNames = task.AssignedToName ? task.AssignedToName.split(",") : [];
                            var empDiv = $("<div>").addClass("employee-list");
                            var maxVisible = 3;
                            empNames.slice(0, maxVisible).forEach(function(name, idx) {
                                var initials = getInitials(name.trim());
                                var colors = [
                                    "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                                    "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                                    "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                                    "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                                    "linear-gradient(135deg, #fa709a 0%, #fee140 100%)"
                                ];
                                $("<div>").addClass("employee-avatar")
                                    .attr("title", name.trim())
                                    .css("background", colors[idx % colors.length])
                                    .text(initials)
                                    .appendTo(empDiv);
                            });
                            if (empNames.length > maxVisible) {
                                $("<div>").addClass("employee-avatar employee-more")
                                    .attr("title", empNames.slice(maxVisible).join(", "))
                                    .text("+" + (empNames.length - maxVisible))
                                    .appendTo(empDiv);
                            }
                            if (empNames.length === 0) {
                                $("<span>").css({
                                    fontSize: "12px",
                                    color: "var(--text-muted)",
                                    fontStyle: "italic"
                                }).text("Chưa gán").appendTo(empDiv);
                            }
                            controlDiv.append(empDiv);
                            container.append(controlDiv);
                        }
                    },
                    // ===== TIẾN ĐỘ (READ ONLY) =====
                    {
                        dataField: "ProgressPct",
                        caption: "Tiến độ",
                        width: 200,
                        alignment: "left",
                        sortOrder: "desc",
                        cellTemplate: function(container, options) {
                            var task = options.data;
                            var taskID = task.TaskID;
                            var id = "ProgressDiv_" + taskID;
                            var controlDiv = $("<div>").attr("id", id).data("record", task);
                            var progress = options.value || 0;
                            var displayText = "";
                            if (task.TargetKPI > 0) {
                                displayText = (task.ActualKPI || 0) + "/" + task.TargetKPI;
                            } else if (task.TotalSubtasks > 0) {
                                displayText = (task.CompletedSubtasks || 0) + "/" + task.TotalSubtasks;
                            }
                            var div = $("<div>").addClass("progress-cell");
                            if (displayText) {
                                $("<div>").addClass("progress-info").text(displayText).appendTo(div);
                            }
                            var barContainer = $("<div>").addClass("progress-bar-container");
                            $("<div>").addClass("progress-bar-fill")
                                .css("width", Math.min(progress, 100) + "%")
                                .appendTo(barContainer);
                            barContainer.appendTo(div);
                            $("<div>").addClass("progress-text").text(progress + "%").appendTo(div);
                            controlDiv.append(div);
                            container.append(controlDiv);
                        }
                    },
                    // ===== TRẠNG THÁI (INLINE EDIT) =====
                    {
                        dataField: "StatusCode",
                        caption: "Trạng thái",
                        width: 140,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const task = options.data;
                            const taskID = task.TaskID;
                            const containerId = "StatusDiv_" + taskID;
                            const $wrapper = $("<div>")
                                .attr("id", containerId)
                                .data("record", task)
                                .css({ width: "100%", cursor: "pointer" });

                            const status = options.value || 1;
                            const statusMap = {
                                1: { text: "Chưa làm", bg: "bg-light", textClass: "text-secondary", dotColor: "#6c757d" },
                                2: { text: "Đang làm", bg: "bg-info", textClass: "text-white", dotColor: "#ffffff" },
                                3: { text: "Hoàn thành", bg: "bg-success", textClass: "text-white", dotColor: "#ffffff" }
                            };
                            const info = statusMap[status] || statusMap[1];

                            // Badge dùng Bootstrap + inline style
                            const $badge = $(`<span class="badge ${info.bg} ${info.textClass} px-2 py-1 fw-semibold rounded-pill d-inline-flex align-items-center gap-1" style="font-size:12px;">`)
                                .append(
                                    $("<span>").css({
                                        display: "inline-block",
                                        width: "6px",
                                        height: "6px",
                                        borderRadius: "50%",
                                        backgroundColor: info.dotColor
                                    }),
                                    $("<span>").text(info.text)
                                );
                            $wrapper.append($badge);

                            let isEditing = false;
                            let originalStatus = status;

                            $wrapper.on("click", function(e) {
                                e.stopPropagation();
                                if (isEditing) return;
                                isEditing = true;
                                $badge.hide();

                                const $controlContainer = $("<div>").css({ width: "100%" });
                                $wrapper.append($controlContainer);

                                const statusDataSource = Object.keys(statusMap).map(k => ({
                                    ID: parseInt(k),
                                    Name: statusMap[k].text,
                                    DotColor: statusMap[k].dotColor,
                                    BadgeClass: statusMap[k].bg + " " + statusMap[k].textClass
                                }));

                                $controlContainer.dxSelectBox({
                                    dataSource: statusDataSource,
                                    valueExpr: "ID",
                                    displayExpr: "Name",
                                    value: status,
                                    searchEnabled: true,
                                    showClearButton: true,
                                    width: "100%",
                                    // Popup nổi, rộng tự động
                                    dropDownOptions: {
                                        width: 220,
                                        maxHeight: 300,
                                        container: "#sp_Task_MyWork_html",
                                        position: { my: "top left", at: "bottom left", of: $wrapper, offset: "0 4", collision: "flip fit" }
                                    },
                                    itemTemplate: function(data) {
                                        return $("<div class='d-flex align-items-center gap-2 px-2 py-1'>")
                                            .append(
                                                $("<span>").css({
                                                    display: "inline-block",
                                                    width: "8px",
                                                    height: "8px",
                                                    borderRadius: "50%",
                                                    backgroundColor: data.DotColor
                                                }),
                                                $("<span class='fw-normal'>").text(data.Name)
                                            );
                                    },
                                    onValueChanged: async function(e) {
                                        if (e.value !== originalStatus) {
                                            try {
                                                await saveFunction(
                                                    JSON.stringify([-99218308, ["StatusCode"], [e.value]]),
                                                    [[taskID], "TaskID"]
                                                );
                                                task.StatusCode = e.value;
                                                originalStatus = e.value;
                                                const newInfo = statusMap[e.value] || statusMap[1];
                                                $badge.empty().append(
                                                    $("<span>").css({
                                                        display: "inline-block",
                                                        width: "6px",
                                                        height: "6px",
                                                        borderRadius: "50%",
                                                        backgroundColor: newInfo.dotColor
                                                    }),
                                                    $("<span>").text(newInfo.text)
                                                ).attr("class", `badge ${newInfo.bg} ${newInfo.textClass} px-2 py-1 fw-semibold rounded-pill d-inline-flex align-items-center gap-1`);
                                                uiManager.showAlert({ type: "success", message: "Lưu trạng thái" });
                                                loadTasks();
                                            } catch (err) {
                                                uiManager.showAlert({ type: "error", message: "Lỗi lưu trạng thái" });
                                            }
                                        }
                                        exitEditMode(false);
                                    },
                                    onInitialized: function(e) {
                                        setTimeout(() => e.component.open(), 100);
                                    }
                                });

                                setTimeout(() => {
                                    $(document).on("click.outsideStatus" + taskID, function(ev) {
                                        if (!$(ev.target).closest($wrapper).length && !$(ev.target).closest(".dx-selectbox").length) {
                                            exitEditMode(true);
                                        }
                                    });
                                }, 150);

                                function exitEditMode(cancel) {
                                    isEditing = false;
                                    $(document).off("click.outsideStatus" + taskID);
                                    $controlContainer.remove();
                                    if (cancel) {
                                        const rollback = statusMap[originalStatus] || statusMap[1];
                                        $badge.empty().append(
                                            $("<span>").css({
                                                display: "inline-block",
                                                width: "6px",
                                                height: "6px",
                                                borderRadius: "50%",
                                                backgroundColor: rollback.dotColor
                                            }),
                                            $("<span>").text(rollback.text)
                                        ).attr("class", `badge ${rollback.bg} ${rollback.textClass} px-2 py-1 fw-semibold rounded-pill d-inline-flex align-items-center gap-1`);
                                    }
                                    $badge.show();
                                }
                            });

                            container.append($wrapper);
                        }
                    },
                    // ===== NGÀY BẮT ĐẦU =====
                    {
                        dataField: "MyStartDate",
                        caption: "Ngày bắt đầu",
                        width: 130,
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            container.text(formatSimpleDate(options.value) || "-");
                        }
                    },
                    // ===== HẠN HOÀN THÀNH =====
                    {
                        dataField: "DueDate",
                        caption: "Hạn hoàn thành",
                        width: 140,
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            var task = options.data;
                            var dateStr = formatSimpleDate(options.value);
                            var dateDiv = $("<div>").addClass("date-cell");
                            if (task.IsOverdue === 1) {
                                dateDiv.addClass("overdue");
                                $("<i>").addClass("bi bi-exclamation-triangle-fill").appendTo(dateDiv);
                            }
                            $("<span>").text(dateStr || "-").appendTo(dateDiv);
                            container.append(dateDiv);
                        }
                    },
                    // ===== TRẠNG THÁI HẠN =====
                    {
                        dataField: "IsOverdue",
                        caption: "Trạng thái hạn",
                        width: 120,
                        alignment: "center",
                        allowEditing: false,
                        cellTemplate: function(container, options) {
                            var text = options.value === 1 ? "Quá hạn" : "Đúng hạn";
                            $("<span>").text(text).appendTo(container);
                        }
                    },
                    // ===== NHÃN (CLICK TO OPEN) =====
                    {
                        dataField: "Tags",
                        caption: "Nhãn",
                        width: 180,
                        cellTemplate: function(container, options) {
                            const task = options.data;
                            const taskID = task.TaskID;
                            const containerId = "TagsCell_" + taskID;
                            const $wrapper = $("<div>").attr("id", containerId).css({
                                width: "100%",
                                cursor: "pointer"
                            });

                            // Render tags as compact badges
                            const tagText = options.value || "";
                            const tagIds = tagText ? tagText.split(",").map(Number) : [];
                            const tagsMap = {
                                1: {
                                    name: "Khẩn cấp",
                                    icon: "exclamation-circle",
                                    color: "#dc3545"
                                },
                                2: {
                                    name: "Quan trọng",
                                    icon: "star",
                                    color: "#ffc107"
                                },
                                3: {
                                    name: "Backend",
                                    icon: "server",
                                    color: "#198754"
                                },
                                4: {
                                    name: "Frontend",
                                    icon: "display",
                                    color: "#0dcaf0"
                                },
                                5: {
                                    name: "Bug",
                                    icon: "bug",
                                    color: "#6c757d"
                                }
                            };

                            const $tagContainer = $("<div>").css({
                                display: "flex",
                                gap: "4px",
                                flexWrap: "wrap"
                            });

                            if (tagIds.length === 0) {
                                $tagContainer.append($("<span>").css({
                                    color: "#adb5bd",
                                    fontSize: "12px"
                                }).text("–"));
                            } else {
                                tagIds.slice(0, 3).forEach(id => {
                                    const tag = tagsMap[id];
                                    if (tag) {
                                        const $badge = $("<span>").css({
                                            fontSize: "11px",
                                            padding: "2px 6px",
                                            borderRadius: "4px",
                                            backgroundColor: tag.color + "20",
                                            color: tag.color,
                                            display: "inline-flex",
                                            alignItems: "center",
                                            gap: "4px"
                                        }).html(`<i class="bi bi-${tag.icon}" style="font-size:10px"></i> ${tag.name}`);
                                        $tagContainer.append($badge);
                                    }
                                });
                                if (tagIds.length > 3) {
                                    $tagContainer.append($("<span>").css({
                                        fontSize: "11px",
                                        color: "#6c757d"
                                    }).text(`+${tagIds.length - 3}`));
                                }
                            }

                            $wrapper.append($tagContainer);
                            container.append($wrapper);

                            // Không cho phép edit inline vì TagBox chiếm nhiều không gian → giữ nguyên hành vi cũ (mở popup toàn cục)
                            // → Giữ nguyên như hiện tại hoặc kích hoạt popup khi click
                            $wrapper.on("click", function(e) {
                                e.stopPropagation();
                                TagsControl = loadUI_Tags();
                                TagsControl.setValue(task.Tags);
                                TagsKey = {
                                    TaskID: taskID
                                };
                            });
                        }
                    },
                    // ===== THAO TÁC =====
                    {
                        caption: "Thao tác",
                        width: 120,
                        alignment: "center",
                        allowExporting: false,
                        allowSorting: false,
                        allowFiltering: false,
                        allowGrouping: false,
                        cellTemplate: function(container, options) {
                            $("<button>").addClass("action-btn")
                                .html(`<i class="bi bi-box-arrow-up-right"></i> Chi tiết`)
                                .attr("title", "Xem chi tiết công việc")
                                .on("click", function(e) {
                                    e.stopPropagation();
                                    openTaskDetail(options.data.TaskID);
                                })
                                .appendTo(container);
                        }
                    }
                ],

                // ===== SUMMARY =====
                summary: {
                    totalItems: [{
                            column: "TaskID",
                            summaryType: "count",
                            displayFormat: "Tổng: {0} công việc"
                        },
                        {
                            column: "ProgressPct",
                            summaryType: "avg",
                            valueFormat: "fixedPoint",
                            precision: 1,
                            displayFormat: "TB: {0}%"
                        }
                    ],
                    groupItems: [{
                            column: "TaskID",
                            summaryType: "count",
                            displayFormat: "{0} việc"
                        },
                        {
                            column: "ProgressPct",
                            summaryType: "avg",
                            valueFormat: "fixedPoint",
                            precision: 1,
                            displayFormat: "TB: {0}%"
                        }
                    ]
                },

                // ===== MASTER DETAIL =====
                masterDetail: {
                    enabled: false
                },

                // ===== EVENT HANDLERS =====
                onRowPrepared: function(e) {
                    if (e.rowType === "data") {
                        if (e.data.IsOverdue === 1) {
                            e.rowElement.css("background-color", "rgba(229, 57, 53, 0.03)");
                        }
                        if (e.data.StatusCode === 3) {
                            e.rowElement.css("opacity", "0.7");
                        }
                    }
                },
                onContextMenuPreparing: function(e) {
                    if (e.row && e.row.rowType === "data") {
                        e.items = [{
                                text: "Xem chi tiết",
                                icon: "info",
                                onItemClick: function() {
                                    openTaskDetail(e.row.data.TaskID);
                                }
                            },
                            {
                                text: "Chỉnh sửa",
                                icon: "edit",
                                onItemClick: function() {
                                    console.log("Edit task:", e.row.data.TaskID);
                                }
                            },
                            {
                                beginGroup: true
                            },
                            {
                                text: "Đánh dấu hoàn thành",
                                icon: "check",
                                disabled: e.row.data.StatusCode === 3,
                                onItemClick: function() {
                                    updateTaskStatus(e.row.data.TaskID, 3);
                                }
                            },
                            {
                                text: "Đánh dấu đang làm",
                                icon: "runner",
                                disabled: e.row.data.StatusCode === 2,
                                onItemClick: function() {
                                    updateTaskStatus(e.row.data.TaskID, 2);
                                }
                            },
                            {
                                beginGroup: true
                            },
                            {
                                text: "Xóa",
                                icon: "trash",
                                onItemClick: function() {
                                    if (confirm("Bạn có chắc chắn muốn xóa công việc này?")) {
                                        deleteTask(e.row.data.TaskID);
                                    }
                                }
                            }
                        ];
                    }
                },
                onRowClick: function(e) {
                    if (e.rowType === "data" && e.column && e.column.type !== "drag" && e.column.caption !== "Thao tác") {
                        var hasSubtasks = e.data.HasSubtasks || (e.data.TotalSubtasks && e.data.TotalSubtasks > 0);
                        if (hasSubtasks) {
                            if (e.component.isRowExpanded(e.key)) {
                                e.component.collapseRow(e.key);
                            } else {
                                e.component.expandRow(e.key);
                            }
                        }
                    }
                },
                onRowDblClick: function(e) {
                    if (e.rowType === "data") {
                        openTaskDetail(e.data.TaskID);
                    }
                },
                onToolbarPreparing: function(e) {
                    e.toolbarOptions.items.unshift({
                        location: "after",
                        widget: "dxButton",
                        options: {
                            icon: "refresh",
                            hint: "Tải lại dữ liệu",
                            onClick: function() {
                                loadTasks();
                            }
                        }
                    });
                }
            }).dxDataGrid("instance");
        }
</script>

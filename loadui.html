window["DataSource_Company"] = window["DataSource_Company"] || [];

let CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP = "sp_Sub_CRM_CompanyInfo_Get";
let CompanyP8DBE48299B124653B68EFF25360E901CIsLoading = false;
let CompanyP8DBE48299B124653B68EFF25360E901CIsDataLoaded = false;
let _autoSaveCompanyP8DBE48299B124653B68EFF25360E901C = false;
let _readOnlyCompanyP8DBE48299B124653B68EFF25360E901C = false;
let CompanyP8DBE48299B124653B68EFF25360E901CTableAddNew = "";
let CompanyP8DBE48299B124653B68EFF25360E901CColumnAddNew = "";
let CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch = "";
let CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue = "";
let InstanceCompanyP8DBE48299B124653B68EFF25360E901C = null;
const CompanyP8DBE48299B124653B68EFF25360E901CLastSearchClass = "hpa-last-search-P8DBE48299B124653B68EFF25360E901C";

function getDataSourceConfigCompanyP8DBE48299B124653B68EFF25360E901C(data) {
const idField = window["DataSourceIDField_Company"] || "ID";
return new DevExpress.data.DataSource({
store: new DevExpress.data.CustomStore({
key: idField,
load: function(loadOptions) {
let searchValue = CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch || "";

if (!searchValue && loadOptions && loadOptions.searchValue) {
searchValue = loadOptions.searchValue;
}

if (!searchValue && InstanceCompanyP8DBE48299B124653B68EFF25360E901C &&
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option) {
searchValue = InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue") || "";
}

let result = data || [];

if (searchValue && searchValue.trim()) {
result = result.filter(item => customSearchCompany(item, searchValue));
}

return Promise.resolve(result);
},
byKey: function(key) {
const idField = window["DataSourceIDField_Company"] || "ID";
return Promise.resolve((data || []).find(i => i[idField] === key));
}
})
});
}

async function processAddNewCompany(newValue) {
if (!newValue || !newValue.trim()) return;

InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("disabled", true);

const dataJSON = JSON.stringify([CompanyP8DBE48299B124653B68EFF25360E901CTableAddNew,
[CompanyP8DBE48299B124653B68EFF25360E901CColumnAddNew], [newValue.trim()]]);
const idValsJSON = JSON.stringify([[], []]);

try {
const json = await saveFunction(dataJSON, idValsJSON);
const dtError = json.data[json.data.length - 1] || [];
if (dtError.length > 0 && dtError[0].Status === "ERROR") {
if ("0" === "1") {
uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lỗi thêm mới" });
}
} else {
if ("0" === "1") {
uiManager.showAlert({ type: "success", message: "Đã thêm mới: " + newValue });
}

if (CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP && CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP !== "")
{
loadDataSourceCommon("Company", CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP, function(data) {
const idField = window["DataSourceIDField_Company"] || "ID";
const nameField = window["DataSourceNameField_Company"] || "Name";
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("dataSource",
getDataSourceConfigCompanyP8DBE48299B124653B68EFF25360E901C(data));
const newItem = data.find(x => x[nameField] === newValue.trim());
if (newItem) {
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value", newItem[idField]);
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue", "");
CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch = "";
}
});
}
}
} catch (e) {
console.error(e);
if ("0" === "1") uiManager.showAlert({ type: "error", message: "Có lỗi khi thêm mới" });
} finally {
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("disabled", false);
InstanceCompanyP8DBE48299B124653B68EFF25360E901C.close();
}
}

function highlightTextCompany(text, search) {
if (!search || !text) return text;
const regex = new RegExp("(" + search.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
return text.replace(regex, "<mark class=\"bg-warning fw-bold px-1 rounded\">$1</mark>");
}

function customSearchCompany(item, searchValue) {
if (!searchValue) return true;

// Chuẩn hóa searchValue - loại bỏ dấu và chuyển thành lowercase
let searchNormalized = searchValue.toLowerCase();

if (typeof RemoveToneMarks_Js === "function") {
searchNormalized = RemoveToneMarks_Js(searchValue).toLowerCase();
}

const idField = window["DataSourceIDField_Company"] || "ID";
const nameField = window["DataSourceNameField_Company"] || "Name";
const fields = [idField, nameField, "Code", "Description"];

for (let i = 0; i < fields.length; i++) { const fieldValue=item[fields[i]]; if (fieldValue) { // Chuẩn hóa fieldValue -
    loại bỏ dấu và chuyển thành lowercase let fieldNormalized=String(fieldValue).toLowerCase(); if (typeof
    RemoveToneMarks_Js==="function" ) { fieldNormalized=RemoveToneMarks_Js(String(fieldValue)).toLowerCase(); } const
    matchIndex=fieldNormalized.indexOf(searchNormalized); // So sánh sau khi đã chuẩn hóa if (matchIndex !==-1) { return
    true; } } } return false; } function renderLastSearchHintCompanyP8DBE48299B124653B68EFF25360E901C($popupContent) {
    if (!$popupContent || !$popupContent.length) return; const
    lastSearch=(CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue || "" ).trim(); let $hint=$popupContent.find("."
    + CompanyP8DBE48299B124653B68EFF25360E901CLastSearchClass); if (!lastSearch) { if ($hint.length) { $hint.remove(); }
    return; } if (!$hint.length) { $hint=$("<div>")
    .addClass(CompanyP8DBE48299B124653B68EFF25360E901CLastSearchClass + " d-flex align-items-center
    justify-content-between gap-2 px-3 py-2 border-bottom")
    .css({
    fontSize: "12px",
    background: "#f8f9fa"
    })
    .prependTo($popupContent);

    $("<span>")
        .addClass("flex-fill text-muted text-truncate")
        .appendTo($hint);

        $("<button>")
            .attr("type", "button")
            .addClass("btn btn-link p-0 text-decoration-none fw-semibold")
            .text("Áp dụng lại")
            .on("dxclick", function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            if (!CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue) return;
            CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch =
            CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue;
            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue",
            CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue);
            const $input = $("#P8DBE48299B124653B68EFF25360E901C").find(".dx-texteditor-input");
            if ($input && $input.length) {
            setTimeout(function() { $input.focus(); }, 0);
            }
            })
            .appendTo($hint);
            }

            $hint.find("span").text("Lần tìm trước: \"" + lastSearch + "\"");
            }

            InstanceCompanyP8DBE48299B124653B68EFF25360E901C = $("#P8DBE48299B124653B68EFF25360E901C").dxSelectBox({
            readOnly: _readOnlyCompanyP8DBE48299B124653B68EFF25360E901C,
            dataSource: getDataSourceConfigCompanyP8DBE48299B124653B68EFF25360E901C(window["DataSource_Company"]),
            valueExpr: window["DataSourceIDField_Company"] || "ID",
            displayExpr: window["DataSourceNameField_Company"] || "Name",
            onOptionChanged: function(e) {
            if (!e || !e.component) return;
            if (e.name === "searchValue") {

            const newVal = (e.value || "").toString();
            CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch = newVal;
            if (newVal && newVal.trim()) {
            CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue = newVal;
            }

            if (e.component.option("opened") && e.component._popup) {
            renderLastSearchHintCompanyP8DBE48299B124653B68EFF25360E901C($(e.component._popup.content()));
            }
            }
            },
            onContentReady: function(e) {},
            placeholder: "Tìm kiếm hoặc chọn...",
            searchEnabled: true,
            searchTimeout: 300,
            minSearchLength: 0,
            showDataBeforeSearch: true,
            showClearButton: false,
            stylingMode: "outlined",
            dropDownOptions: {
            showTitle: false,
            closeOnOutsideClick: true,
            height: "auto",
            maxHeight: 400,
            minWidth: 320,
            onShowing: function(e) {
            if (InstanceCompanyP8DBE48299B124653B68EFF25360E901C &&
            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option) {
            const pendingSearch = InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue") || "";
            if (pendingSearch && pendingSearch.trim()) {
            CompanyP8DBE48299B124653B68EFF25360E901CLastSearchValue = pendingSearch;
            }
            CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch = "";
            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue", "");
            }
            },
            onHidden: function() {
            CompanyP8DBE48299B124653B68EFF25360E901CCurrentSearch = "";
            if (InstanceCompanyP8DBE48299B124653B68EFF25360E901C &&
            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option) {
            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue", "");
            }
            }
            },
            itemTemplate: function(data, index) {
            if (data.IsAddNew) {
            const $item = $("<div>")
                .addClass("d-flex align-items-center gap-2 px-3 py-2 text-primary fw-bold")
                .css({ cursor: "pointer", borderTop: "1px dashed #dee2e6" });

                const nameField = window["DataSourceNameField_Company"] || "Name";
                $("<i>").addClass("bi bi-plus-circle-fill fs-5").appendTo($item);
                    $("<span>").text("Thêm mới: \"" + data[nameField] + "\"").appendTo($item);

                        $item.on("dxclick", async function(e) {
                        e.stopPropagation();
                        if (InstanceCompanyP8DBE48299B124653B68EFF25360E901C &&
                        InstanceCompanyP8DBE48299B124653B68EFF25360E901C.blur)
                        InstanceCompanyP8DBE48299B124653B68EFF25360E901C.blur();
                        await processAddNewCompany(data[nameField]);
                        });

                        return $item;
                        }

                        const $item = $("<div>")
                            .addClass("d-flex align-items-center gap-3 px-3 py-2 my-1 mx-2 rounded")
                            .css({
                            cursor: "pointer",
                            transition: "all 0.2s ease",
                            border: "1px solid transparent"
                            });

                            $item.on("mouseenter", function() {
                            $(this).css({
                            transform: "translateX(4px)",
                            borderColor: "#90caf9",
                            boxShadow: "0 2px 8px rgba(0,0,0,0.08)"
                            });
                            }).on("mouseleave", function() {
                            $(this).css({
                            background: "",
                            transform: "",
                            borderColor: "transparent",
                            boxShadow: ""
                            });
                            });

                            const $content = $("<div>").addClass("flex-fill").css("minWidth", "0");
                                const searchValue =
                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("searchValue") || "";

                                const idField = window["DataSourceIDField_Company"] || "ID";
                                const nameField = window["DataSourceNameField_Company"] || "Name";
                                const displayName = (data[idField] !== undefined ? data[idField] + " - " : "") +
                                (data[nameField] || "");
                                $("<div>")
                                    .addClass("fw-semibold")
                                    .css({
                                    fontSize: "14px",
                                    lineHeight: "1.4",
                                    overflow: "hidden",
                                    textOverflow: "ellipsis",
                                    whiteSpace: "nowrap"
                                    })
                                    .html(highlightTextCompany(displayName, searchValue))
                                    .appendTo($content);

                                    if (data.Description || data.Code) {
                                    $("<div>")
                                        .addClass("small text-muted")
                                        .css({
                                        fontSize: "12px",
                                        overflow: "hidden",
                                        textOverflow: "ellipsis",
                                        whiteSpace: "nowrap"
                                        })
                                        .text(data.Code || data.Description)
                                        .appendTo($content);
                                        }

                                        $content.appendTo($item);

                                        if (data.Status) {
                                        const badgeClass = data.Status === "Active" ? "bg-success" : "bg-secondary";
                                        $("<span>")
                                            .addClass("badge " + badgeClass + " text-uppercase")
                                            .css({
                                            fontSize: "9px",
                                            padding: "4px 8px",
                                            letterSpacing: "0.5px",
                                            flexShrink: "0"
                                            })
                                            .text(data.Status)
                                            .appendTo($item);
                                            }

                                            setTimeout(() => {
                                            $item.css({
                                            opacity: "0",
                                            transform: "translateX(-10px)"
                                            }).animate({
                                            opacity: 1
                                            }, {
                                            duration: 300,
                                            step: function(now) {
                                            $(this).css("transform", "translateX(" + (-10 + (now * 10)) + "px)");
                                            },
                                            delay: index * 30
                                            });
                                            }, 10);

                                            return $item;
                                            },
                                            onOpened: function(e) {
                                            // Style dropdown
                                            const $popupContent = $(e.component._popup.content());
                                            $popupContent.parent()
                                            .addClass("shadow-lg border rounded hpa-responsive")
                                            .css({
                                            borderRadius: "12px",
                                            padding: "8px 0",
                                            borderColor: "#dee2e6"
                                            });

                                            renderLastSearchHintCompanyP8DBE48299B124653B68EFF25360E901C($popupContent);
                                            },
                                            onFocusIn: function(e) {
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("showClearButton",
                                            true);
                                            },
                                            onFocusOut: function(e) {
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("showClearButton",
                                            false);
                                            },
                                            onKeyDown: function(e) {
                                            if (e.key === "Enter" || e.key === "Tab") {
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("showClearButton",
                                            false);
                                            }
                                            },
                                            onValueChanged: async function(e) {
                                            if (!e.event) return;

                                            // Feature: Check Instance AutoSave Flag
                                            if (_autoSaveCompanyP8DBE48299B124653B68EFF25360E901C) {
                                            // Nếu người dùng tìm kiếm rỗng và kết quả trả về là 0/empty/null (Copy from
                                            AutoSave mode)
                                            if (e.value === "" || e.value == null || e.value === 0 || e.value === "0") {
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value",
                                            _initialCompanyP8DBE48299B124653B68EFF25360E901C);
                                            return;
                                            }

                                            $("#P8DBE48299B124653B68EFF25360E901C").find(".dx-texteditor-input").blur();
                                            if (InstanceCompanyP8DBE48299B124653B68EFF25360E901C &&
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.blur)
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.blur();

                                            const $el = $(e.element);
                                            $el.css({
                                            transform: "scale(1.02)",
                                            boxShadow: "0 0 0 3px rgba(28, 151, 94, 0.2)",
                                            transition: "all 0.2s ease"
                                            });
                                            setTimeout(() => {
                                            $el.css({ transform: "", boxShadow: "" });
                                            }, 300);

                                            if (typeof window["onSelectBoxChanged_Company"] === "function") {
                                            window["onSelectBoxChanged_Company"](e.value,
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C, e);
                                            }

                                            const val = e.value;
                                            const dataJSON = JSON.stringify(["-1053964371", ["Company"], [val || ""]]);

                                            // Context-aware record IDs
                                            let id1 = currentRecordID_Company_ID;
                                            if (typeof cellInfo !== "undefined" && cellInfo && cellInfo.data) {
                                            id1 = cellInfo.data["Company_ID"] || id1;
                                            }
                                            let currentRecordIDValue = [id1];
                                            let currentRecordID = ["Company_ID"];

                                            if ("" && "".trim() !== "") {
                                            let id2 = currentRecordID_;
                                            if (typeof cellInfo !== "undefined" && cellInfo && cellInfo.data) {
                                            id2 = cellInfo.data[""] || id2;
                                            }
                                            currentRecordIDValue.push(id2);
                                            currentRecordID.push("");
                                            }
                                            const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                                            try {
                                            const json = await saveFunction(dataJSON, idValsJSON);
                                            const dtError = json.data[json.data.length - 1] || [];
                                            if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                                            if ("0" === "1") {
                                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu
                                            thất bại" });
                                            }
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value",
                                            _initialCompanyP8DBE48299B124653B68EFF25360E901C);
                                            } else {

                                            if(0 != 0 && 0 != null && 0 != "" && window.hpaSharedGridDataSources["0"])
                                            {
                                            try {
                                            var updateData = {};
                                            updateData["Company_ID"] = currentRecordIDValue[0];
                                            updateData["Company"] =
                                            InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value");

                                            var id2FieldName = "";
                                            var hasKey2 = id2FieldName && id2FieldName !== "" &&
                                            id2FieldName.indexOf("%") === -1;

                                            if (hasKey2) {
                                            if (currentRecordIDValue.length > 1 && currentRecordIDValue[1] !==
                                            undefined) {
                                            updateData[id2FieldName] = currentRecordIDValue[1];
                                            }
                                            }

                                            // Thực hiện update shared grid
                                            window.updateSharedGridRow("0", updateData);

                                            // Kiểm tra và cập nhật biến DataSource cục bộ
                                            if (typeof DataSource !== "undefined" && Array.isArray(DataSource)) {
                                            var ds;
                                            if (!hasKey2) {
                                            // Trường hợp 1 khóa
                                            ds = DataSource.filter(item => item["Company_ID"] ===
                                            updateData["Company_ID"]);
                                            } else {
                                            // Trường hợp 2 khóa
                                            ds = DataSource.filter(item =>
                                            item["Company_ID"] === updateData["Company_ID"] &&
                                            item[id2FieldName] === updateData[id2FieldName]
                                            );
                                            }

                                            if (ds && ds.length > 0) {
                                            ds[0]["Company"] = updateData["Company"];
                                            }
                                            } // <-- Bạn thiếu dấu này } catch (dsErr) { console.warn("[Grid Sync]
                                                SelectBox CompanyP8DBE48299B124653B68EFF25360E901C: Không thể sync
                                                shared grid data source:", dsErr); } } if (typeof cellInfo
                                                !=="undefined" && cellInfo && cellInfo.component) { try { const
                                                grid=cellInfo.component; grid.cellValue(cellInfo.rowIndex, "Company" ,
                                                val); grid.repaint(); } catch (syncErr) { console.warn("[Grid Sync]
                                                SelectBox CompanyP8DBE48299B124653B68EFF25360E901C: Không thể sync
                                                grid:", syncErr); } } if ("0"==="1" ) { uiManager.showAlert({
                                                type: "success" , message: "Lưu thành công" }); }
                                                _initialCompanyP8DBE48299B124653B68EFF25360E901C=val; } } catch (err) {
                                                if ("0"==="1" ) { uiManager.showAlert({ type: "error" ,
                                                message: "Có lỗi xảy ra khi lưu" }); }
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value",
                                                _initialCompanyP8DBE48299B124653B68EFF25360E901C);
                                                console.error("SelectBox Save Error:", err); } return; } // Normal
                                                Manual Mode Logic (No API) const $el=$(e.element); $el.css({
                                                transform: "scale(1.02)" , boxShadow: "0 0 0 3px rgba(28, 151, 94, 0.2)"
                                                , transition: "all 0.2s ease" }); setTimeout(()=> {
                                                $el.css({ transform: "", boxShadow: "" });
                                                }, 300);

                                                if (typeof window["onSelectBoxChanged_Company"] === "function") {
                                                window["onSelectBoxChanged_Company"](e.value,
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C, e);
                                                }

                                                if (typeof cellInfo !== "undefined" && cellInfo && cellInfo.component) {
                                                try {
                                                const grid = cellInfo.component;
                                                grid.cellValue(cellInfo.rowIndex, "Company", e.value);
                                                grid.repaint();
                                                } catch (syncErr) {
                                                console.warn("[Grid Sync] Không thể sync grid:", syncErr);
                                                }
                                                }
                                                }
                                                }).dxSelectBox("instance");

                                                let _initialCompanyP8DBE48299B124653B68EFF25360E901C =
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("value");

                                                // Load data source immediately to get field names
                                                if (CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP &&
                                                CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP !== "") {
                                                loadDataSourceCommon("Company",
                                                CompanyP8DBE48299B124653B68EFF25360E901CDataSourceSP, function(data) {
                                                CompanyP8DBE48299B124653B68EFF25360E901CIsDataLoaded = true;

                                                // Get field names from API response
                                                const idField = window["DataSourceIDField_Company"] || "ID";
                                                const nameField = window["DataSourceNameField_Company"] || "Name";

                                                // Update control options with actual field names
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("valueExpr",
                                                idField);
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("displayExpr",
                                                nameField);

                                                // Update data source
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.option("dataSource",
                                                getDataSourceConfigCompanyP8DBE48299B124653B68EFF25360E901C(data));
                                                InstanceCompanyP8DBE48299B124653B68EFF25360E901C.repaint();
                                                });
                                                }
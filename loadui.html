<script>
    window['DataSource_TypeCheckInCheckOut'] = window['DataSource_TypeCheckInCheckOut'] || [];

    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP = 'sp_GetTypeCheckInCheckOut';
    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECIsLoading = false;
    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECIsDataLoaded = false;
    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECTableAddNew = '';
    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECColumnAddNew = '';
    let TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECCurrentSearch = '';
    let InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC = null;

    function getDataSourceConfigTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC(data) {
        return new DevExpress.data.DataSource({
            store: new DevExpress.data.CustomStore({
                key: 'ID',
                load: function (loadOptions) {
                    // LẤY searchValue từ INSTANCE (option "text" hoặc "searchValue")
                    const searchValue =
                        InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC && InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option
                            ? InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('text') ||
                              InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('searchValue') ||
                              ''
                            : loadOptions.searchValue || '';

                    let result = data || [];

                    if (searchValue && searchValue.trim()) {
                        result = result.filter((item) => customSearchTypeCheckInCheckOut(item, searchValue));
                    }

                    return Promise.resolve(result);
                },
                byKey: function (key) {
                    return Promise.resolve((data || []).find((i) => i.ID === key));
                },
            }),
        });
    }

    async function processAddNewTypeCheckInCheckOut(newValue) {
        if (!newValue || !newValue.trim()) return;

        InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('disabled', true);

        const dataJSON = JSON.stringify([
            TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECTableAddNew,
            [TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECColumnAddNew],
            [newValue.trim()],
        ]);
        const idValsJSON = JSON.stringify([[], []]);

        try {
            const json = await saveFunction(dataJSON, idValsJSON);
            const dtError = json.data[json.data.length - 1] || [];
            if (dtError.length > 0 && dtError[0].Status === 'ERROR') {
                if ('0' === '1') {
                    uiManager.showAlert({ type: 'error', message: dtError[0]?.Message || 'Lỗi thêm mới' });
                }
            } else {
                if ('0' === '1') {
                    uiManager.showAlert({ type: 'success', message: 'Đã thêm mới: ' + newValue });
                }

                if (
                    TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP &&
                    TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP !== ''
                ) {
                    loadDataSourceCommon('TypeCheckInCheckOut', TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP, function (data) {
                        InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option(
                            'dataSource',
                            getDataSourceConfigTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC(data),
                        );
                        const newItem = data.find((x) => x.Name === newValue.trim());
                        if (newItem) {
                            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('value', newItem.ID);
                            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('searchValue', '');
                            TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECCurrentSearch = '';
                        }
                    });
                }
            }
        } catch (e) {
            console.error(e);
            if ('0' === '1') uiManager.showAlert({ type: 'error', message: 'Có lỗi khi thêm mới' });
        } finally {
            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('disabled', false);
            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.close();
        }
    }

    function highlightTextTypeCheckInCheckOut(text, search) {
        if (!search || !text) return text;
        const regex = new RegExp('(' + search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        return text.replace(regex, '<mark class="bg-warning fw-bold px-1 rounded">$1</mark>');
    }

    function customSearchTypeCheckInCheckOut(item, searchValue) {
        if (!searchValue) return true;

        // Chuẩn hóa searchValue - loại bỏ dấu và chuyển thành lowercase
        let searchNormalized = searchValue.toLowerCase();

        if (typeof RemoveToneMarks_Js === 'function') {
            searchNormalized = RemoveToneMarks_Js(searchValue).toLowerCase();
        } else {
            console.warn('[SelectBox Search Debug] RemoveToneMarks_Js is NOT defined!');
        }

        const fields = ['ID', 'Name', 'Code', 'Description'];

        for (let i = 0; i < fields.length; i++) {
            const fieldValue = item[fields[i]];

            if (fieldValue) {
                // Chuẩn hóa fieldValue - loại bỏ dấu và chuyển thành lowercase
                let fieldNormalized = String(fieldValue).toLowerCase();

                if (typeof RemoveToneMarks_Js === 'function') {
                    fieldNormalized = RemoveToneMarks_Js(String(fieldValue)).toLowerCase();
                }

                const matchIndex = fieldNormalized.indexOf(searchNormalized);

                // So sánh sau khi đã chuẩn hóa
                if (matchIndex !== -1) {
                    return true;
                }
            }
        }
        return false;
    }

    InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC = $('#PE62CC3EDB59347F79CE538A442F781EC')
        .dxSelectBox({
            dataSource: getDataSourceConfigTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC(window['DataSource_TypeCheckInCheckOut']),
            valueExpr: 'ID',
            displayExpr: 'Name',
            onOptionChanged: function (e) {},
            onContentReady: function (e) {},
            placeholder: 'Tìm kiếm hoặc chọn...',
            searchEnabled: true,
            searchTimeout: 300,
            minSearchLength: 0,
            showDataBeforeSearch: true,
            showClearButton: false,
            stylingMode: 'outlined',
            dropDownOptions: {
                showTitle: false,
                closeOnOutsideClick: true,
                height: 'auto',
                maxHeight: 400,
                minWidth: 320,
                onShowing: function (e) {
                    if (
                        !TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECIsDataLoaded &&
                        TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP &&
                        TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP !== ''
                    ) {
                        loadDataSourceCommon('TypeCheckInCheckOut', TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECDataSourceSP, function (data) {
                            TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781ECIsDataLoaded = true;
                            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option(
                                'dataSource',
                                getDataSourceConfigTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC(data),
                            );
                        });
                    }
                },
            },
            itemTemplate: function (data, index) {
                if (data.IsAddNew) {
                    const $item = $('<div>')
                        .addClass('d-flex align-items-center gap-2 px-3 py-2 text-primary fw-bold')
                        .css({ cursor: 'pointer', borderTop: '1px dashed #dee2e6' });

                    $('<i>').addClass('bi bi-plus-circle-fill fs-5').appendTo($item);
                    $('<span>')
                        .text('Thêm mới: "' + data.Name + '"')
                        .appendTo($item);

                    $item.on('dxclick', async function (e) {
                        e.stopPropagation();
                        if (InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC && InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.blur)
                            InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.blur();
                        await processAddNewTypeCheckInCheckOut(data.Name);
                    });

                    return $item;
                }

                const $item = $('<div>').addClass('d-flex align-items-center gap-3 px-3 py-2 my-1 mx-2 rounded').css({
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    border: '1px solid transparent',
                });

                $item
                    .on('mouseenter', function () {
                        $(this).css({
                            transform: 'translateX(4px)',
                            borderColor: '#90caf9',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                        });
                    })
                    .on('mouseleave', function () {
                        $(this).css({
                            background: '',
                            transform: '',
                            borderColor: 'transparent',
                            boxShadow: '',
                        });
                    });

                const $content = $('<div>').addClass('flex-fill').css('minWidth', '0');
                const searchValue = InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('searchValue') || '';

                const displayName = (data.ID !== undefined ? data.ID + ' - ' : '') + (data.Name || '');
                $('<div>')
                    .addClass('fw-semibold')
                    .css({
                        fontSize: '14px',
                        lineHeight: '1.4',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap',
                    })
                    .html(highlightTextTypeCheckInCheckOut(displayName, searchValue))
                    .appendTo($content);

                if (data.Description || data.Code) {
                    $('<div>')
                        .addClass('small text-muted')
                        .css({
                            fontSize: '12px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                        })
                        .text(data.Code || data.Description)
                        .appendTo($content);
                }

                $content.appendTo($item);

                if (data.Status) {
                    const badgeClass = data.Status === 'Active' ? 'bg-success' : 'bg-secondary';
                    $('<span>')
                        .addClass('badge ' + badgeClass + ' text-uppercase')
                        .css({
                            fontSize: '9px',
                            padding: '4px 8px',
                            letterSpacing: '0.5px',
                            flexShrink: '0',
                        })
                        .text(data.Status)
                        .appendTo($item);
                }

                setTimeout(() => {
                    $item
                        .css({
                            opacity: '0',
                            transform: 'translateX(-10px)',
                        })
                        .animate(
                            {
                                opacity: 1,
                            },
                            {
                                duration: 300,
                                step: function (now) {
                                    $(this).css('transform', 'translateX(' + (-10 + now * 10) + 'px)');
                                },
                                delay: index * 30,
                            },
                        );
                }, 10);

                return $item;
            },
            onOpened: function (e) {
                // Style dropdown
                $(e.component._popup.content()).parent().addClass('shadow-lg border rounded hpa-responsive').css({
                    borderRadius: '12px',
                    padding: '8px 0',
                    borderColor: '#dee2e6',
                });
            },
            onFocusIn: function (e) {
                InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('showClearButton', true);
            },
            onFocusOut: function (e) {
                InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('showClearButton', false);
            },
            onKeyDown: function (e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('showClearButton', false);
                }
            },
            onValueChanged: async function (e) {
                if (!e.event) return;
                if (e.value === '' || e.value == null || e.value === 0 || e.value === '0') {
                    InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('value', _initialTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC);
                    return;
                }

                $('#PE62CC3EDB59347F79CE538A442F781EC').find('.dx-texteditor-input').blur();
                if (InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC && InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.blur)
                    InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.blur();

                const $el = $(e.element);
                $el.css({
                    transform: 'scale(1.02)',
                    boxShadow: '0 0 0 3px rgba(28, 151, 94, 0.2)',
                    transition: 'all 0.2s ease',
                });
                setTimeout(() => {
                    $el.css({ transform: '', boxShadow: '' });
                }, 300);

                if (typeof window['onSelectBoxChanged_TypeCheckInCheckOut'] === 'function') {
                    window['onSelectBoxChanged_TypeCheckInCheckOut'](e.value, InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC, e);
                }

                const val = e.value;
                const dataJSON = JSON.stringify(['2099029869', ['TypeCheckInCheckOut'], [val || '']]);

                // Context-aware record IDs
                let id1 = currentRecordID_IdentityID,
                    ID;
                if (typeof cellInfo !== 'undefined' && cellInfo && cellInfo.data) {
                    id1 = cellInfo.data['IdentityID,ID'] || id1;
                }
                let currentRecordIDValue = [id1];
                let currentRecordID = ['IdentityID,ID'];

                // Xử lý multiple IDs nếu ColumnIDName chứa dấu phẩy
                if ('IdentityID,ID'.includes(',')) {
                    const ids = 'IdentityID,ID'.split(',').map((id) => id.trim());
                    ids.forEach((id) => {
                        let idVal = window['currentRecordID_' + id];
                        if (typeof cellInfo !== 'undefined' && cellInfo && cellInfo.data && cellInfo.data[id] !== undefined) {
                            idVal = cellInfo.data[id] || idVal;
                        }
                        currentRecordIDValue.push(idVal);
                    });
                    currentRecordID = 'IdentityID,ID'.split(',').map((id) => id.trim());
                }
                const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                try {
                    const json = await saveFunction(dataJSON, idValsJSON);
                    const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === 'ERROR') {
                        if ('0' === '1') {
                            uiManager.showAlert({ type: 'error', message: dtError[0]?.Message || 'Lưu thất bại' });
                        }
                        InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option(
                            'value',
                            _initialTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC,
                        );
                    } else {
                        if (typeof cellInfo !== 'undefined' && cellInfo && cellInfo.component) {
                            try {
                                const grid = cellInfo.component;
                                grid.cellValue(cellInfo.rowIndex, 'TypeCheckInCheckOut', val);
                                grid.repaint();
                            } catch (syncErr) {
                                console.warn('[Grid Sync] SelectBox TypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC: Không thể sync grid:', syncErr);
                            }
                        }
                        if ('0' === '1') {
                            uiManager.showAlert({ type: 'success', message: 'Lưu thành công' });
                        }
                        _initialTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC = val;
                    }
                } catch (err) {
                    if ('0' === '1') {
                        uiManager.showAlert({ type: 'error', message: 'Có lỗi xảy ra khi lưu' });
                    }
                    InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('value', _initialTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC);
                    console.error('SelectBox Save Error:', err);
                }
            },
        })
        .dxSelectBox('instance');

    let _initialTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC = InstanceTypeCheckInCheckOutPE62CC3EDB59347F79CE538A442F781EC.option('value');
</script>

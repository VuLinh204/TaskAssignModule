<script>
    // Shared grid data source registry so detail forms can trigger refreshes
    window.hpaSharedGridDataSources = window.hpaSharedGridDataSources || {};

    if (!window.reloadSharedGridDataSource) {
        window.reloadSharedGridDataSource = function (name, params) {
            const registry = window.hpaSharedGridDataSources || {};
            const entry = registry[name];
            if (!entry || typeof entry.reload !== "function") {
                console.warn("[SharedGrid] Grid", name, "is not registered");
                return Promise.resolve([]);
            }
            return entry.reload(params);
        };
    }

    if (!window.getSharedGridDataSource) {
        window.getSharedGridDataSource = function (name) {
            const registry = window.hpaSharedGridDataSources || {};
            return registry[name];
        };
    }

    if (!window.updateSharedGridRow) {
        window.updateSharedGridRow = function (name, rowData, options) {
            const registry = window.hpaSharedGridDataSources || {};
            const entry = registry[name];
            if (!entry || typeof entry.applyRowChanges !== "function") {
                console.warn("[SharedGrid] Grid", name, "cannot accept row updates");
                return Promise.resolve(false);
            }
            return entry.applyRowChanges(rowData, options);
        };
    }

    if (!window.removeSharedGridRow) {
        window.removeSharedGridRow = function (name, options) {
            const registry = window.hpaSharedGridDataSources || {};
            const entry = registry[name];
            if (!entry || typeof entry.removeRow !== "function") {
                console.warn("[SharedGrid] Grid", name, "cannot remove rows");
                return Promise.resolve(false);
            }
            return entry.removeRow(options);
        };
    }

    (function setupSharedGridSource() {
        const sharedKey = gridName;
        const primaryKeyField = "%PKColumnName%";

        const loginValue = typeof window.UserID !== "undefined"
            ? window.UserID
            : (typeof LoginID !== "undefined" ? LoginID : null);
        const languageValue = typeof window.LanguageID !== "undefined"
            ? window.LanguageID
            : (typeof LanguageID !== "undefined" ? LanguageID : null);

        const snapshotGridData = function (instance) {
            if (!instance) return [];
            try {
                if (typeof instance.getDataSource === "function") {
                    const ds = instance.getDataSource();
                    if (ds && typeof ds.items === "function") {
                        const dsItems = ds.items();
                        if (Array.isArray(dsItems)) {
                            return dsItems.map(function (item) {
                                return item && typeof item === "object" ? Object.assign({}, item) : item;
                            });
                        }
                    }
                }

                if (typeof instance.option === "function") {
                    const rawData = instance.option("dataSource");
                    if (Array.isArray(rawData)) {
                        return rawData.map(function (item) {
                            return item && typeof item === "object" ? Object.assign({}, item) : item;
                        });
                    }
                }
            } catch (snapshotErr) {
                console.warn("[SharedGrid] Unable to snapshot grid data", snapshotErr);
            }
            return [];
        };

        let sharedEntry = window.hpaSharedGridDataSources[sharedKey];
        if (!sharedEntry) {
            sharedEntry = {
                data: [],
                subscribers: [],
                loading: false
            };
        }

        sharedEntry.primaryKey = sharedEntry.primaryKey || primaryKeyField;
        sharedEntry.data = Array.isArray(sharedEntry.data) ? sharedEntry.data : [];
        sharedEntry.subscribers = Array.isArray(sharedEntry.subscribers) ? sharedEntry.subscribers : [];
        sharedEntry.loading = !!sharedEntry.loading;

        if (typeof sharedEntry.normalizeParams !== "function") {
            sharedEntry.normalizeParams = function (customParams) {
                const base = [];
                if (loginValue !== null && loginValue !== undefined) {
                    base.push("LoginID", loginValue);
                }
                if (languageValue !== null && languageValue !== undefined) {
                    base.push("LanguageID", languageValue);
                }

                if (Array.isArray(customParams) && customParams.length > 0) {
                    return base.concat(customParams);
                }

                if (customParams && typeof customParams === "object") {
                    const extras = [];
                    Object.keys(customParams).forEach(function (key) {
                        extras.push(key, customParams[key]);
                    });
                    return base.concat(extras);
                }

                return base;
            };
        }

        if (typeof sharedEntry.notify !== "function") {
            sharedEntry.notify = function () {
                this.subscribers.forEach(function (callback) {
                    try {
                        callback(this.data);
                    } catch (err) {
                        console.error("[SharedGrid] subscriber error", err);
                    }
                }, this);
            };
        }

        if (typeof sharedEntry.subscribe !== "function") {
            sharedEntry.subscribe = function (callback) {
                if (typeof callback === "function") {
                    this.subscribers.push(callback);
                }
                return () => {
                    this.subscribers = this.subscribers.filter(function (fn) {
                        return fn !== callback;
                    });
                };
            };
        }

        if (typeof sharedEntry.applyRowChanges !== "function") {
            sharedEntry.applyRowChanges = function (rowData, options) {
                const opts = options || {};
                const keyField = this.primaryKey;
                let keyValue = opts.key;
                if ((keyValue === undefined || keyValue === null) && rowData && rowData[keyField] !== undefined) {
                    keyValue = rowData[keyField];
                }

                if (keyValue === undefined || keyValue === null) {
                    console.warn("[SharedGrid] Missing key when applying row changes for", sharedKey);
                    return Promise.resolve(false);
                }

                if (typeof this.ensureLocalData === "function") {
                    this.ensureLocalData();
                }

                const compare = opts.strict === true
                    ? function (candidate) { return candidate === keyValue; }
                    : function (candidate) {
                        if (candidate === undefined || candidate === null) return candidate === keyValue;
                        if (keyValue === undefined || keyValue === null) return false;
                        return String(candidate) === String(keyValue);
                    };

                const nextData = Array.isArray(this.data) ? this.data.slice() : [];
                let targetIndex = nextData.findIndex(function (item) {
                    return item ? compare(item[keyField]) : false;
                });

                const normalizedRow = Object.assign({}, targetIndex > -1 ? nextData[targetIndex] : {}, rowData);

                if (targetIndex === -1) {
                    if (opts.ignoreMissing === true) {
                        return Promise.resolve(false);
                    }
                    if (opts.append === true) {
                        nextData.push(normalizedRow);
                        targetIndex = nextData.length - 1;
                    } else {
                        nextData.unshift(normalizedRow);
                        targetIndex = 0;
                    }
                } else {
                    nextData[targetIndex] = normalizedRow;
                }

                this.data = nextData;
                try {
                    if (this.instance && typeof this.instance.option === "function") {
                        this.instance.option("dataSource", nextData);
                        this.instance.refresh();
                    }
                } catch (applyErr) {
                    console.warn("[SharedGrid] Unable to push row update", applyErr);
                }
                this.notify();
                return Promise.resolve({ index: targetIndex, data: normalizedRow });
            };
        }

        if (typeof sharedEntry.removeRow !== "function") {
            sharedEntry.removeRow = function (options) {
                const opts = options || {};
                const keyField = this.primaryKey;
                const keyValue = opts.key;

                if (keyValue === undefined || keyValue === null) {
                    console.warn("[SharedGrid] Missing key when removing row for", sharedKey);
                    return Promise.resolve(false);
                }

                if (typeof this.ensureLocalData === "function") {
                    this.ensureLocalData();
                }

                const filtered = (Array.isArray(this.data) ? this.data : []).filter(function (item) {
                    if (!item) return true;
                    const candidate = item[keyField];
                    if (opts.strict === true) {
                        return candidate !== keyValue;
                    }
                    if (candidate === undefined || candidate === null) {
                        return keyValue !== candidate;
                    }
                    return String(candidate) !== String(keyValue);
                });

                if (filtered.length === (Array.isArray(this.data) ? this.data.length : 0)) {
                    return Promise.resolve(false);
                }

                this.data = filtered;
                try {
                    if (this.instance && typeof this.instance.option === "function") {
                        this.instance.option("dataSource", filtered);
                        this.instance.refresh();
                    }
                } catch (removeErr) {
                    console.warn("[SharedGrid] Unable to remove row", removeErr);
                }
                this.notify();
                return Promise.resolve(true);
            };
        }

        sharedEntry.instance = Instance % ColumnName %% UID %;

        if (typeof sharedEntry.ensureLocalData !== "function") {
            sharedEntry.ensureLocalData = function () {
                if (Array.isArray(this.data) && this.data.length > 0) {
                    return;
                }
                const snapshot = snapshotGridData(this.instance);
                if (snapshot.length > 0) {
                    this.data = snapshot;
                }
            };
        }

        const currentSnapshot = snapshotGridData(sharedEntry.instance);
        if (currentSnapshot.length > 0) {
            sharedEntry.data = currentSnapshot;
        }

        sharedEntry.getData = function () {
            return this.data;
        };

        window.hpaSharedGridDataSources[sharedKey] = sharedEntry;
    })();
</script>
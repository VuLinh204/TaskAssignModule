
    <div id="sp_UnregisteredAccount_NN_Control">
        <div id="GridAccount" style="height: 100%;"></div><div id="P8EC0724E578142E4AAD1FE3E0D6A4C94"></div><div id="PF9A3029C9FAB40E0B476C0D074A8DE5B"></div><div id="P804D6FADD5ED4412BB218159C16E04EF"></div><div id="P3FA0343C98A44849A4355D47E2E24061"></div><div id="PD987FC71CE5E444A9376403FF65C59D6"></div><div id="P5CD93C11BA754CDC9BC5D922A010638D"></div><div id="PDA076A9DA8724C408B0629DEB737E87D"></div><div id="PBD59BFBAB7E24842B06A82E458CB86F3"></div><div id="P05E1D5AAA0374717B94077A9FDD5559D"></div><div id="P4031E37943134B329C9F457B0CF5CF5C"></div><div id="P56F2EB96E5BB4C97BECA22B15340AAD4"></div><div id="PAC8E76094CDD4769864B4DDF6F660DFF"></div>
    </div>
    <script>
        (() => {
            let DataSource = []
            '
        +(select loadUI from tblCommonControlType_Signed where UID = 'P23DEDE11C5E44D8D8ADB55D186AC4198')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P8EC0724E578142E4AAD1FE3E0D6A4C94')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PF9A3029C9FAB40E0B476C0D074A8DE5B')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P804D6FADD5ED4412BB218159C16E04EF')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P3FA0343C98A44849A4355D47E2E24061')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PD987FC71CE5E444A9376403FF65C59D6')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P5CD93C11BA754CDC9BC5D922A010638D')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PDA076A9DA8724C408B0629DEB737E87D')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PBD59BFBAB7E24842B06A82E458CB86F3')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PC25903981FC547BC8338EE13BAB0E331')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P05E1D5AAA0374717B94077A9FDD5559D')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P4031E37943134B329C9F457B0CF5CF5C')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P56F2EB96E5BB4C97BECA22B15340AAD4')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PAC8E76094CDD4769864B4DDF6F660DFF')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P3B8CB442562743D1BA18EA8CEAAD3D7C') +N'

             window.currentRecordID_CompanyID = null; window.currentRecordID_CRM_CustomerID = null; window.currentRecordID_EmployeeID = null; window.currentRecordID_LoginName = null;
            
            // Load DataSource: sp_getCompanyInfo
            if ("sp_getCompanyInfo" && "sp_getCompanyInfo".trim() !== "") {
                loadDataSourceCommon("Company", "sp_getCompanyInfo", function(data) {
                    // Data được shared qua callback
                });
            }
        
            // Load DataSource: sp_getInfoEmployeeAccount
            if ("sp_getInfoEmployeeAccount" && "sp_getInfoEmployeeAccount".trim() !== "") {
                loadDataSourceCommon("SelectEmployee", "sp_getInfoEmployeeAccount", function(data) {
                    // Data được shared qua callback
                });
            }
        
            // Load DataSource: sp_getParentLogin
            if ("sp_getParentLogin" && "sp_getParentLogin".trim() !== "") {
                loadDataSourceCommon("ParentLogin", "sp_getParentLogin", function(data) {
                    // Data được shared qua callback
                });
            }
        
        function loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback) {
            if (!columnName || !dataSourceSP || dataSourceSP.trim() === "") {
                console.warn("[loadDataSourceCommon] Missing columnName or dataSourceSP");
                return;
            }

            const dataSourceKey = "DataSource_" + columnName;
            // Sử dụng format: columnNameDataSourceLoaded để tương thích với code hiện tại
            const loadedKey = columnName + "DataSourceLoaded";

            // Kiểm tra nếu đã load rồi thì không load lại
            if (window[loadedKey] === true) {
                if (typeof onSuccessCallback === "function") {
                    onSuccessCallback(window[dataSourceKey] || []);
                }
                return;
            }

            // Kiểm tra nếu đang load thì đợi
            if (window[loadedKey] === "loading") {
                // Đợi một chút rồi thử lại
                setTimeout(function() {
                    loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback);
                }, 100);
                return;
            }

            // Đánh dấu đang load để tránh load trùng lặp
            window[loadedKey] = "loading";

            AjaxHPAParadise({
                data: {
                    name: dataSourceSP,
                    param: ["LoginID", LoginID, "LanguageID", LanguageID]
                },
                success: function(res) {
                    const json = typeof res === "string" ? JSON.parse(res) : res;
                    window[dataSourceKey] = (json.data && json.data[0]) || [];
                    window[loadedKey] = true;

                    // Gọi callback nếu có
                    if (typeof onSuccessCallback === "function") {
                        onSuccessCallback(window[dataSourceKey]);
                    }

                    // Tự động cập nhật control nếu có method setDataSource hoặc option
                    // Thử nhiều format tên instance để tương thích
                    const instanceVariants = [
                        "Instance" + columnName.charAt(0).toUpperCase() + columnName.slice(1) + "P23DEDE11C5E44D8D8ADB55D186AC4198",
                        "Instance" + columnName + "P23DEDE11C5E44D8D8ADB55D186AC4198",
                        "instance" + columnName.charAt(0).toUpperCase() + columnName.slice(1) + "P23DEDE11C5E44D8D8ADB55D186AC4198"
                    ];

                    for (let i = 0; i < instanceVariants.length; i++) {
                        const instanceKey = instanceVariants[i];
                        if (window[instanceKey]) {
                            const instanceObj = window[instanceKey];

                            // Kiểm tra nếu đây là dxDataGrid
                            if (typeof instanceObj.dxDataGrid === "function" || instanceObj.option && instanceObj.option("dataSource") !== undefined) {
                                try {
                                    // Nếu là Grid, apply dynamic config
                                    const gridConfigFn = window["getGridConfig_" + columnName.charAt(0).toUpperCase() + columnName.slice(1)];
                                    if (typeof gridConfigFn === "function") {
                                        const gridConfig = gridConfigFn(window[dataSourceKey]);
                                        instanceObj.option("remoteOperations", gridConfig.remoteOperations);
                                    instanceObj.option("paging.pageSize", gridConfig.pageSize);
                                        instanceObj.option("pager.allowedPageSizes", gridConfig.allowedPageSizes);
                                    }

                                    instanceObj.option("dataSource", window[dataSourceKey]);
                                    break;
                                } catch(e) {
                                    console.warn("[LoadDataSourceCommon] Grid config error:", e);
                                    // Fallback: just set data source
                                    instanceObj.option("dataSource", window[dataSourceKey]);
                                    break;
                                }
                            } else if (typeof instanceObj.setDataSource === "function") {
                                instanceObj.setDataSource(window[dataSourceKey]);
                                break;
                            } else if (typeof instanceObj.option === "function") {
                                try {
                                    instanceObj.option("dataSource", window[dataSourceKey]);
                                    break;
                                } catch(e) {
                                    // Continue to next variant
                                }
                            }
                        }
                    }
                },
                error: function(err) {
                    console.error("[loadDataSourceCommon] Failed to load datasource for", columnName, ":", err);
                    window[loadedKey] = false;
                    if (typeof onSuccessCallback === "function") {
                        onSuccessCallback([]);
                    }
                }
            });
        }
    

            function ReloadData() {
                AjaxHPAParadise({
                    data: {
                        name: "sp_getUnregisteredAccount_Control",
                        param: []
                    },
                    success: function (res) {
                        const json = typeof res === "string" ? JSON.parse(res) : res;
                        const results = Array.isArray(json?.data?.[0])
                            ? json.data[0]
                            : (json?.data?.[0] ? [json.data[0]] : []);

                        const obj = results[0] || null;
                         window.currentRecordID_CompanyID = obj.CompanyID || window.currentRecordID_CompanyID; window.currentRecordID_CRM_CustomerID = obj.CRM_CustomerID || window.currentRecordID_CRM_CustomerID; window.currentRecordID_EmployeeID = obj.EmployeeID || window.currentRecordID_EmployeeID; window.currentRecordID_LoginName = obj.LoginName || window.currentRecordID_LoginName;
                        DataSource = results;
                        '
        +(select loadData from tblCommonControlType_Signed where UID = 'P23DEDE11C5E44D8D8ADB55D186AC4198')
        +(select loadData from tblCommonControlType_Signed where UID = 'P8EC0724E578142E4AAD1FE3E0D6A4C94')
        +(select loadData from tblCommonControlType_Signed where UID = 'PF9A3029C9FAB40E0B476C0D074A8DE5B')
        +(select loadData from tblCommonControlType_Signed where UID = 'P804D6FADD5ED4412BB218159C16E04EF')
        +(select loadData from tblCommonControlType_Signed where UID = 'P3FA0343C98A44849A4355D47E2E24061')
        +(select loadData from tblCommonControlType_Signed where UID = 'PD987FC71CE5E444A9376403FF65C59D6')
        +(select loadData from tblCommonControlType_Signed where UID = 'P5CD93C11BA754CDC9BC5D922A010638D')
        +(select loadData from tblCommonControlType_Signed where UID = 'PDA076A9DA8724C408B0629DEB737E87D')
        +(select loadData from tblCommonControlType_Signed where UID = 'PBD59BFBAB7E24842B06A82E458CB86F3')
        +(select loadData from tblCommonControlType_Signed where UID = 'PC25903981FC547BC8338EE13BAB0E331')
        +(select loadData from tblCommonControlType_Signed where UID = 'P05E1D5AAA0374717B94077A9FDD5559D')
        +(select loadData from tblCommonControlType_Signed where UID = 'P4031E37943134B329C9F457B0CF5CF5C')
        +(select loadData from tblCommonControlType_Signed where UID = 'P56F2EB96E5BB4C97BECA22B15340AAD4')
        +(select loadData from tblCommonControlType_Signed where UID = 'PAC8E76094CDD4769864B4DDF6F660DFF')
        +(select loadData from tblCommonControlType_Signed where UID = 'P3B8CB442562743D1BA18EA8CEAAD3D7C') +N'

                        if (1 === 1) {
                            // Xử lý cho grid layout
                            const gridInstance = InstanceGridAccountP23DEDE11C5E44D8D8ADB55D186AC4198;
                            const gridConfig = window.getGridConfig_GridAccount(results);

                            gridInstance.beginUpdate();

                            gridInstance.option("scrolling", {
                                mode: "standard",
                                showScrollbar: "onHover"
                            });

                            gridInstance.option("remoteOperations", false);  // Client-side cho <= 1000

                            // Set paging config
                            gridInstance.option("paging.enabled", true);
                            gridInstance.option("paging.pageSize", gridConfig.pageSize);
                            gridInstance.option("pager.allowedPageSizes", gridConfig.allowedPageSizes);
                            gridInstance.pageIndex(0);

                            gridInstance.option("dataSource", results);

                            gridInstance.endUpdate();
                        }
                    }
                })
            }
            ReloadData()
        })();
    </script>
USE Paradise_Dev
GO
if object_id('[dbo].[sp_Sub_SubQuotation_manager_html]') is null
	EXEC ('CREATE PROCEDURE [dbo].[sp_Sub_SubQuotation_manager_html] as select 1')
GO
ALTER PROCEDURE [dbo].[sp_Sub_SubQuotation_manager_html]
 @LoginID INT = 3,
 @LanguageID VARCHAR(2) = 'VN',
 @isWeb int = 1
AS
BEGIN
 SET NOCOUNT ON;

 DECLARE @html nvarchar(max);
 SET @html = N'
<style>
    :root {
        --quote-primary: #2E7D32;
        --quote-primary-dark: #167549ff;
        --quote-danger: #E53935;
        --quote-warning: #FBC02D;
        --quote-info: #0288D1;
    }

    #sp_quotation_manager {
        margin-bottom: 3rem;
        font-family: ''Segoe UI'', Tahoma, Geneva, Verdana, sans-serif;
        /* ‚úÖ Prevent layout shift from font loading */
        font-display: swap;
    }

    #sp_quotation_manager .header-section {
        border-bottom: 2px solid rgba(128, 128, 128, 0.2);
    }

    /* Buttons */
    #sp_quotation_manager .btn-add {
        background: var(--quote-primary);
        color: white;
        border: none;
        transition: all 0.2s;
        padding: 0.65rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
    }

    #sp_quotation_manager .btn-add:hover {
        background: var(--quote-primary-dark);
        transform: translateY(-2px);
    }

    /* Search & Filter */
    #sp_quotation_manager .search-box {
        position: relative;
        flex: 1;
    }

    #sp_quotation_manager .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.6;
    }

    #sp_quotation_manager .search-input {
        padding-left: 2.5rem !important;
    }

    /* Grid Styling */
    #sp_quotation_manager .grid-container {
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid rgba(128, 128, 128, 0.2);
        min-height: 400px;
        /* ‚úÖ Reserve space ƒë·ªÉ tr√°nh layout shift */
        position: relative;
        /* ‚úÖ ƒê·ªÉ absolute positioning cho loading/empty states */
    }

    #sp_quotation_manager .dx-datagrid {
        border: none !important;
        background: unset;
        min-height: 300px;
        /* ‚úÖ Reserve space cho grid */
    }

    #sp_quotation_manager .dx-datagrid-headers .dx-header-row>td {
        font-weight: 700 !important;
        padding: 1rem !important;
        height: 60px !important;
        vertical-align: middle !important;
        border-bottom: 2px solid rgba(128, 128, 128, 0.2) !important;
        background: rgba(128, 128, 128, 0.05) !important;
    }

    #sp_quotation_manager .dx-datagrid-row>td {
        padding: 0.75rem 1rem !important;
        vertical-align: middle !important;
        border-bottom: 1px solid rgba(128, 128, 128, 0.1) !important;
    }

    /* Status Badges */
    #sp_quotation_manager .badge-status {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-block;
        text-transform: uppercase;
    }

    #sp_quotation_manager .badge-draft {
        background: rgba(158, 158, 158, 0.15);
        color: #666;
    }

    #sp_quotation_manager .badge-sent {
        background: rgba(2, 136, 209, 0.15);
        color: var(--quote-info);
    }

    #sp_quotation_manager .badge-approved {
        background: rgba(46, 125, 50, 0.15);
        color: var(--quote-primary);
    }

    #sp_quotation_manager .badge-rejected {
        background: rgba(229, 57, 53, 0.15);
        color: var(--quote-danger);
    }

    /* Modal Styles */
    #sp_quotation_manager .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1050;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
        display: flex;
        /* ‚úÖ Lu√¥n c√≥ display flex ƒë·ªÉ reserve space */
    }

    #sp_quotation_manager .modal-overlay.show {
        visibility: visible;
        opacity: 1;
    }

    #sp_quotation_manager .modal-content {
        background: var(--bs-body-bg, white);
        color: var(--bs-body-color, black);
        border-radius: 16px;
        max-width: 1200px;
        width: 100%;
        min-height: 400px;
        /* ‚úÖ Reserve minimum height */
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        /* ‚úÖ Smooth entrance */
        transition: transform 0.2s;
    }

    #sp_quotation_manager .modal-overlay.show .modal-content {
        transform: scale(1);
        /* ‚úÖ Full size when shown */
    }

    #sp_quotation_manager .modal-header-custom {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(128, 128, 128, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--bs-body-bg, white);
        z-index: 10;
    }

    #sp_quotation_manager .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    #sp_quotation_manager .modal-buttons {
        position: sticky;
        bottom: 0;
        background: var(--bs-body-bg, white);
        border-top: 1px solid rgba(128, 128, 128, 0.2);
        padding: 1rem 1.5rem;
        z-index: 10;
    }

    /* Form Controls */
    #sp_quotation_manager .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    #sp_quotation_manager .form-control,
    #sp_quotation_manager .form-select {
        border: 2px solid rgba(128, 128, 128, 0.2);
        border-radius: 8px;
        padding: 0.625rem;
        transition: border-color 0.2s;
        width: 100%;
        height: 48px;
        box-sizing: border-box;
        /* ‚úÖ Include padding in height calculation */
        min-height: 48px;
        /* ‚úÖ Ensure minimum height */
    }

    #sp_quotation_manager .form-control:focus,
    #sp_quotation_manager .form-select:focus {
        border-color: var(--quote-primary);
        outline: none;
    }

    #sp_quotation_manager .form-control[readonly] {
        background-color: rgba(128, 128, 128, 0.05);
        color: #666;
        cursor: not-allowed;
        border-color: rgba(128, 128, 128, 0.15);
    }

    /* Buttons */
    #sp_quotation_manager .btn {
        font-size: 1rem;
        padding: 0.65rem 1.25rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    #sp_quotation_manager .btn-success {
        background-color: var(--quote-primary);
        color: #fff;
    }

    #sp_quotation_manager .btn-success:hover {
        background-color: var(--quote-primary-dark);
    }

    #sp_quotation_manager .btn-danger {
        background-color: var(--quote-danger);
        color: #fff;
    }

    #sp_quotation_manager .btn-secondary {
        background-color: #6c757d;
        color: #fff;
    }

    #sp_quotation_manager .btn-info {
        background-color: var(--quote-info);
        color: #fff;
    }

    /* Items Table */
    #sp_quotation_manager .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        border: 2px solid rgba(128, 128, 128, 0.2);
        border-radius: 8px;
        overflow: hidden;
        /* ‚úÖ Reserve space for table */
    }

    #sp_quotation_manager .items-table tbody {
        min-height: 100px;
        /* ‚úÖ Reserve space for tbody */
    }

    #sp_quotation_manager .items-table thead {
        background: rgba(128, 128, 128, 0.05);
    }

    #sp_quotation_manager .items-table th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 700;
        border-bottom: 2px solid rgba(128, 128, 128, 0.2);
    }

    #sp_quotation_manager .items-table td {
        padding: 0.5rem;
        border-bottom: 1px solid rgba(128, 128, 128, 0.1);
    }

    #sp_quotation_manager .items-table input[type="number"] {
        width: 100%;
        border: 1px solid rgba(128, 128, 128, 0.2);
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
    }

    #sp_quotation_manager .total-section {
        background: rgba(46, 125, 50, 0.05);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }

    #sp_quotation_manager .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    #sp_quotation_manager .total-row.grand-total {
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--quote-primary);
        border-top: 2px solid var(--quote-primary);
        padding-top: 0.5rem;
        margin-top: 0.5rem;
    }

    #sp_quotation_manager .btn-remove-item {
        background: rgba(229, 57, 53, 0.1);
        color: var(--quote-danger);
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
    }

    #sp_quotation_manager .btn-remove-item:hover {
        background: rgba(229, 57, 53, 0.2);
    }

    #sp_quotation_manager .btn-add-item {
        background: rgba(46, 125, 50, 0.1);
        color: var(--quote-primary);
        border: 2px dashed var(--quote-primary);
        padding: 0.75rem;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        margin-top: 1rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    #sp_quotation_manager .btn-add-item:hover {
        background: rgba(46, 125, 50, 0.2);
        transform: translateY(-2px);
    }

    #sp_quotation_manager .info-card {
        background: rgba(128, 128, 128, 0.05);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--quote-primary);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        #sp_quotation_manager .modal-content {
            max-width: 100%;
            margin: 0;
            border-radius: 0;
        }

        #sp_quotation_manager .items-table {
            font-size: 0.875rem;
        }

        #sp_quotation_manager .items-table th,
        #sp_quotation_manager .items-table td {
            padding: 0.5rem 0.25rem;
        }

        #sp_quotation_manager .header-section {
            display: none;
        }
    }
</style>

<div id="sp_quotation_manager">
    <div class="header-section pb-3 mb-4">
        <div
            class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h3 class="mb-1 fw-bold">
                    <i class="bi bi-file-earmark-text-fill me-2"></i>%QuotationManagementTitle%
                </h3>
                <p class="mb-0 opacity-75">%QuotationManagementSubtitle%</p>
            </div>
            <button class="btn btn-add" id="show-add-quote">
                <i class="bi bi-plus-lg me-2"></i>%CreateNewQuotation%
            </button>
        </div>
    </div>

    <div class="mb-4">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="search-box">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control search-input" id="search-quote"
                        placeholder="%SearchPlaceholder%">
                </div>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="filter-date" placeholder="%FilterByDate%">
            </div>
        </div>
    </div>

    <div class="grid-container">
        <div id="quote_loading" class="text-center py-5"





            style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.2s;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-3">%LoadingData%</p>
        </div>

        <div id="quote_grid_content"
            style="min-height: 300px; visibility: hidden; opacity: 0; transition: opacity 0.2s;">
            <div id="quote_grid"></div>
        </div>

        <div id="quote_empty" class="text-center py-5"
            style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.2s;">
            <div class="empty-state">
                <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <p>%NoQuotationFound%.</p>
                <button class="btn btn-success" onclick="document.getElementById(''show-add-quote'').click()">
                    %CreateFirstQuotation%
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL T·∫†O/S·ª¨A B√ÅO GI√Å -->
    <div class="modal-overlay" id="modal-quote">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-custom">
                <h5 class="mb-0 fw-bold" id="modal-quote-title">
                    <i class="bi bi-file-earmark-text me-2"></i>%QuotationInfo%
                </h5>
                <button type="button" class="btn-close" id="close-modal-quote"
                    style="background:none; border:none; font-size:1.2rem;">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <form id="modal-quote-form">
                <div class="modal-body">
                    <input type="hidden" id="modal-quote-id" value="">

                    <!-- TH√îNG TIN C∆† B·∫¢N -->
                    <div class="info-card mb-4">
                        <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>%BasicInfo%</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">%QuotationCode% </label>
                                <div id="P61E6A4D534D544DD9CF69BCB7853BC57"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">%CreateDate% </label>
                                <div id="PAD1A48ED0FEA4B8FA2437F80F18F7056"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">%QuotationCreator% </label>
                                <div id="modal-quote-creator"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">%Debt_CustomerNameLabel% </label>
                                <div id="PEDB116F05C8A4B2CA7B171F40C527313"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">%ContactPerson%</label>
                                <div class="d-flex gap-2">
                                    <div id="PCE49AAC954D241799FF775DDA7B6650E"></div>
                                    <div id="btn-quick-add-contact" class="btn btn-success btn-sm"><i class="bi bi-plus"></i></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">%PhoneNumber%</label>
                                <div id="P76A3C0DA8AEE41D096DF9D78AC1546CE"></div>
  </div>
  <div class="col-md-12">
                                <label class="form-label">Email</label>
                                <div id="P1E62274470194872A17C143B1515E563"></div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">%Address%</label>
                                <div id="P59392C8190A145579C4929A0A9998304"></div>
                            </div>
                        </div>
                    </div>

                    <!-- DANH S√ÅCH PH√ÇN H·ªÜ -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-grid-fill me-2"></i>%SubsystemList%
                        </h6>

                        <table class="items-table" id="subsystem-items-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 30%">%SubsystemName%</th>
                                    <th style="width: 20%">%LicenseFee% </th>
                                    <th style="width: 20%">%ImplementationFee% </th>
                                    <th style="width: 20%">%TotalAmount%</th>
                                    <th style="width: 5%"></th>
                                </tr>
                            </thead>
                            <tbody id="subsystem-items-tbody">
                                <!-- Subsystem items will be added here dynamically -->
                            </tbody>
                        </table>

                        <button type="button" class="btn-add-item" id="btn-add-subsystem">
                            <i class="bi bi-plus-circle me-2"></i>%AddSubsystem%
                        </button>
                    </div>

                    <!-- T·ªîNG TI·ªÄN -->
                    <div class="total-section">
                        <div class="total-row grand-total">
                            <span>%GrandTotal%:</span>
                            <span id="grand-total">0 ‚Ç´</span>
                        </div>
                    </div>

                    <!-- GHI CH√ö -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-12">
                            <label class="form-label">%AssignNotes%</label>
                            <div id="P4BD2A7E0E5094D77B00C28AE1EF377C0"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons d-flex justify-content-end gap-2">
                    <div id="modal-quote-export" style="display: none;"></div>
                    <div id="modal-quote-save"></div>
                    <div id="modal-quote-delete" style="display: none;"></div>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="modal-add-contact" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header-custom">
                <h5 class="mb-0 fw-bold"><i class="bi bi-person-plus me-2"></i>Th√™m ng∆∞·ªùi li√™n h·ªá m·ªõi</h5>
                <button type="button" class="btn-close" id="close-modal-contact" style="background:none; border:none;">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="form-quick-add-contact">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                        <div id="P62A6B8693851494C86E78A4ABB105511"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                        <div id="P6B60ED34C18A433A832E018552A35E32"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <div id="PC68F34CBC4E346A29BB759E7A9FC2E5D"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">C√¥ng ty (Kh√°ch h√†ng) <span class="text-danger">*</span></label>
                        <div id="P8DBE48299B124653B68EFF25360E901C"></div>
                    </div>
                </div>
                <div class="modal-buttons d-flex justify-content-end gap-2">
                    <div id="btn-cancel-contact"></div>
                    <div id="btn-save-contact"></div>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    (function () {
        // ============================================================================
        // PH·∫¶N 1: KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C
        // ============================================================================

        // --- Bi·∫øn qu·∫£n l√Ω d·ªØ li·ªáu ---
        var quotes = [];                    // Danh s√°ch b√°o gi√°
        var subProducts = [];               // Danh s√°ch ph√¢n h·ªá s·∫£n ph·∫©m
        var gridInstance = null;            // Instance c·ªßa DevExtreme DataGrid
        var editingId = null;               // ID b√°o gi√° ƒëang ƒë∆∞·ª£c ch·ªânh s·ª≠a
        var subsystemItemCounter = 0;       // Counter cho c√°c item ph√¢n h·ªá

        // --- Bi·∫øn ng∆∞·ªùi d√πng & ph√¢n quy·ªÅn ---
        var currentLoginID = null;          // ID ƒëƒÉng nh·∫≠p hi·ªán t·∫°i
        var currentEmployeeID = null;       // ID nh√¢n vi√™n hi·ªán t·∫°i
        var currentUserInfo = null;         // Th√¥ng tin user hi·ªán t·∫°i
        var employeeList = [];              // Danh s√°ch nh√¢n vi√™n
        var isAdmin = false;                // L√† admin hay kh√¥ng

        // --- Bi·∫øn qu·∫£n l√Ω CRM ---
        var companyList = [];               // Danh s√°ch c√¥ng ty
        var customerPersonList = [];        // Danh s√°ch ng∆∞·ªùi li√™n h·ªá

        // --- DevExtreme Component Instances (Modal B√°o Gi√°) ---
        var dxQuoteCode = null;             // TextBox - M√£ b√°o gi√°
        var dxQuoteDate = null;             // DateBox - Ng√†y t·∫°o
        var dxQuoteCreator = null;          // SelectBox - Ng∆∞·ªùi t·∫°o
        var dxQuoteCustomer = null;         // TextBox - T√™n kh√°ch h√†ng (readonly)
        var dxQuoteContactPerson = null;    // SelectBox - Ng∆∞·ªùi li√™n h·ªá
        var dxQuotePhone = null;            // TextBox - S·ªë ƒëi·ªán tho·∫°i (readonly)
        var dxQuoteEmail = null;            // TextBox - Email (readonly)
        var dxQuoteAddress = null;          // TextBox - ƒê·ªãa ch·ªâ (readonly)
        var dxQuoteNotes = null;            // TextArea - Ghi ch√∫
        var dxQuoteExport = null;           // Button - Export
        var dxQuoteSave = null;             // Button - L∆∞u
        var dxQuoteDelete = null;           // Button - X√≥a
        var dxBtnQuickAddContact = null;    // Button - Th√™m ng∆∞·ªùi li√™n h·ªá nhanh

        // --- DevExtreme Component Instances (Modal Th√™m Ng∆∞·ªùi Li√™n H·ªá) ---
        var dxNewContactName = null;        // TextBox - H·ªç t√™n
        var dxNewContactPhone = null;       // TextBox - SƒêT
        var dxNewContactEmail = null;       // TextBox - Email
        var dxNewContactCompany = null;     // SelectBox - C√¥ng ty
        var dxBtnCancelContact = null;      // Button - H·ªßy
        var dxBtnSaveContact = null;        // Button - L∆∞u


        // ============================================================================
        // PH·∫¶N 2: H√ÄM TI·ªÜN √çCH (UTILITY FUNCTIONS)
        // ============================================================================

        /**
         * Hi·ªÉn th·ªã loading indicator
         */
        function showLoading() {
            var el = document.getElementById("quote_loading");
       if (el) {
                el.style.visibility = "visible";
                el.style.opacity = "1";
            }
        }

        /**
         * ·∫®n loading indicator
         */
        function hideLoading() {
            var el = document.getElementById("quote_loading");
            if (el) {
                el.style.visibility = "hidden";
                el.style.opacity = "0";
            }
        }

        /**
         * Format s·ªë ti·ªÅn theo ƒë·ªãnh d·∫°ng VND (c√≥ k√Ω hi·ªáu ‚Ç´)
         * @param {number} value - S·ªë ti·ªÅn c·∫ßn format
         * @returns {string} - Chu·ªói ƒë√£ format
         */
        function formatCurrency(value) {
            return new Intl.NumberFormat(''vi-VN'', {
                style: ''currency'',
                currency: ''VND''
            }).format(value);
        }

        /**
         * Format s·ªë ti·ªÅn kh√¥ng c√≥ k√Ω hi·ªáu (d√πng cho input)
         * @param {number} value - S·ªë ti·ªÅn c·∫ßn format
         * @returns {string} - Chu·ªói s·ªë ƒë√£ format
         */
        function formatCurrencyRaw(value) {
            if (!value || value === 0) return '''';
            return new Intl.NumberFormat(''vi-VN'').format(value);
        }

        /**
         * L·∫•y instance c·ªßa DevExtreme component m·ªôt c√°ch an to√†n
         * @param {jQuery} element - jQuery element
         * @param {string} componentType - Lo·∫°i component (vd: "dxTextBox", "dxSelectBox")
         * @returns {object|null} - Instance ho·∫∑c null n·∫øu kh√¥ng t·ªìn t·∫°i
         */
        function getDxInstance(element, componentType) {
            try {
                return element[componentType]("instance");
            } catch (e) {
                return null;
            }
        }



        // ============================================================================
        // PH·∫¶N 3: KH·ªûI T·∫†O DEVEXTREME COMPONENTS
        // ============================================================================

        /**
         * L·∫•y instances c·ªßa c√°c DevExtreme components ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o b·ªüi loadUI
         * (Ch·ªâ l·∫•y instance, KH√îNG t·∫°o m·ªõi ƒë·ªÉ tr√°nh duplicate rendering)
         */
        function initQuoteModalComponents() {
            // ------------------------------------------------------------------------
            // 3.1. L·∫§Y INSTANCES C·ª¶A C√ÅC CONTROL (ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi loadUI)
            // ------------------------------------------------------------------------

            // Form controls - Th√¥ng tin b√°o gi√°
            if (!dxQuoteCode) {
                dxQuoteCode = getDxInstance($("#P61E6A4D534D544DD9CF69BCB7853BC57"), "dxTextBox");
            }
            if (!dxQuoteDate) {
                dxQuoteDate = getDxInstance($("#PAD1A48ED0FEA4B8FA2437F80F18F7056"), "dxDateBox");
            }
            if (!dxQuoteCreator) {
                dxQuoteCreator = getDxInstance($("#modal-quote-creator"), "dxSelectBox");
            }

            // Form controls - Th√¥ng tin kh√°ch h√†ng (readonly)
            if (!dxQuoteCustomer) {
                dxQuoteCustomer = getDxInstance($("#PEDB116F05C8A4B2CA7B171F40C527313"), "dxTextBox");
            }
            if (!dxQuoteContactPerson) {
                dxQuoteContactPerson = getDxInstance($("#PCE49AAC954D241799FF775DDA7B6650E"), "dxSelectBox");
            }
            if (!dxQuotePhone) {
                dxQuotePhone = getDxInstance($("#P76A3C0DA8AEE41D096DF9D78AC1546CE"), "dxTextBox");
            }
            if (!dxQuoteEmail) {
                dxQuoteEmail = getDxInstance($("#P1E62274470194872A17C143B1515E563"), "dxTextBox");
            }
            if (!dxQuoteAddress) {
                dxQuoteAddress = getDxInstance($("#P59392C8190A145579C4929A0A9998304"), "dxTextBox");
            }

            // Form controls - Ghi ch√∫
            if (!dxQuoteNotes) {
                dxQuoteNotes = getDxInstance($("#P4BD2A7E0E5094D77B00C28AE1EF377C0"), "dxTextArea");
  }

            // Action buttons

            if (!dxQuoteSave) {
                dxQuoteSave = getDxInstance($("#modal-quote-save"), "dxButton");
            }
            if (!dxQuoteDelete) {
                dxQuoteDelete = getDxInstance($("#modal-quote-delete"), "dxButton");
            }
            if (!dxQuoteExport) {
                dxQuoteExport = getDxInstance($("#modal-quote-export"), "dxButton");
            }
            if (!dxBtnQuickAddContact) {
                dxBtnQuickAddContact = getDxInstance($("#btn-quick-add-contact"), "dxButton");
            }

            // ------------------------------------------------------------------------
            // 3.2. C·∫§U H√åNH EVENT HANDLERS (sau khi controls ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o)
            // ------------------------------------------------------------------------

            // Event handler cho SelectBox Ng∆∞·ªùi li√™n h·ªá
            if (dxQuoteContactPerson) {
                dxQuoteContactPerson.option("onValueChanged", function (e) {
                    console.log("ü§û ~ onValueChanged:", e.value);
                    var contactId = e.value;

                    // Reset n·∫øu kh√¥ng c√≥ gi√° tr·ªã
                    if (!contactId || contactId === '''' || contactId === ''__legacy__'') {
                        applyContactSelection(null);
                        return;
                    }

                    // T√¨m contact trong danh s√°ch theo ID
                    var selectedContact = customerPersonList.find(function (p) {
                        return String(p.CRM_CustomerID) === String(contactId);
                    });

                    // Apply th√¥ng tin contact ƒë√£ ch·ªçn
                    if (selectedContact) {
                        applyContactSelection(selectedContact);
                    } else {
                        // Fallback: th·ª≠ l·∫•y t·ª´ selectedItem
                        var selectedItem = e.component.option("selectedItem");
                        if (selectedItem) {
                            applyContactSelection(selectedItem);
                        } else {
                            applyContactSelection(contactId);
                        }
                    }
                });
            }

            // ------------------------------------------------------------------------
            // 3.3. ƒê·∫∂T READONLY CHO C√ÅC FIELD TH√îNG TIN KH√ÅCH H√ÄNG
            // ------------------------------------------------------------------------

            // ƒê·∫£m b·∫£o c√°c field th√¥ng tin kh√°ch h√†ng lu√¥n ·ªü ch·∫ø ƒë·ªô readonly
            // (ch·ªâ ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông khi ch·ªçn ng∆∞·ªùi li√™n h·ªá)
            if (dxQuoteCustomer) dxQuoteCustomer.option("readOnly", true);
            if (dxQuotePhone) dxQuotePhone.option("readOnly", true);
            if (dxQuoteEmail) dxQuoteEmail.option("readOnly", true);
            if (dxQuoteAddress) dxQuoteAddress.option("readOnly", true);
        }


        // ============================================================================
        // PH·∫¶N 4: KH·ªûI T·∫†O COMPONENTS CHO MODAL TH√äM NG∆Ø·ªúI LI√äN H·ªÜ
        // ============================================================================

        /**
         * Kh·ªüi t·∫°o c√°c DevExtreme components cho modal th√™m ng∆∞·ªùi li√™n h·ªá m·ªõi
         * (Modal n√†y CHO PH√âP t·∫°o m·ªõi components v√¨ kh√¥ng d√πng loadUI)
         */
        function initContactModalComponents() {
            try {
                if (typeof DevExpress === ''undefined'' || !DevExpress.ui || typeof $ === ''undefined'') {
                    console.warn(''DevExtreme ho·∫∑c jQuery ch∆∞a ƒë∆∞·ª£c load'');
                    return;
                }

                // TextBox - H·ªç v√† t√™n
                try {
                    var nameEl = $("#P62A6B8693851494C86E78A4ABB105511");
                    if (nameEl.length === 0) return;
                    var nameInstance = getDxInstance(nameEl, "dxTextBox");
 if (!nameInstance) {
      dxNewContactName = nameEl.dxTextBox({
                            placeholder: "Nh·∫≠p h·ªç v√† t√™n",
                            showClearButton: true
                        }).dxTextBox("instance");
                    } else {
                        dxNewContactName = nameInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxTextBox cho new-contact-name:'', e);
                }

                // TextBox - S·ªë ƒëi·ªán tho·∫°i
                try {
                    var phoneEl = $("#P6B60ED34C18A433A832E018552A35E32");
                    if (phoneEl.length === 0) return;
                    var phoneInstance = getDxInstance(phoneEl, "dxTextBox");
                    if (!phoneInstance) {
                        dxNewContactPhone = phoneEl.dxTextBox({
                            placeholder: "Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i",
                            showClearButton: true
                            // B·ªè mask ƒë·ªÉ tr√°nh l·ªói v·ªõi s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
                        }).dxTextBox("instance");
                    } else {
                        dxNewContactPhone = phoneInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxTextBox cho new-contact-phone:'', e);
                }

                // TextBox - Email
                try {
                    var emailEl = $("#PC68F34CBC4E346A29BB759E7A9FC2E5D");
                    if (emailEl.length === 0) return;
                    var emailInstance = getDxInstance(emailEl, "dxTextBox");
                    if (!emailInstance) {
                        dxNewContactEmail = emailEl.dxTextBox({
                            placeholder: "Nh·∫≠p email",
                            mode: "email",
                            showClearButton: true
                        }).dxTextBox("instance");
                    } else {
                        dxNewContactEmail = emailInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxTextBox cho new-contact-email:'', e);
                }

                // SelectBox - C√¥ng ty
                try {
                    var companyEl = $("#P8DBE48299B124653B68EFF25360E901C");
                    if (companyEl.length === 0) return;
                    var companyInstance = getDxInstance(companyEl, "dxSelectBox");
                    if (!companyInstance) {
                        dxNewContactCompany = companyEl.dxSelectBox({
                            placeholder: "-- Ch·ªçn c√¥ng ty --",
                            showClearButton: true,
                            searchEnabled: true
                        }).dxSelectBox("instance");
                    } else {
                        dxNewContactCompany = companyInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxSelectBox cho new-contact-company-id:'', e);
                }

                // Button - H·ªßy
                try {
                    var cancelEl = $("#btn-cancel-contact");
                    if (cancelEl.length === 0) return;
                    var cancelInstance = getDxInstance(cancelEl, "dxButton");
                    if (!cancelInstance) {
                        dxBtnCancelContact = cancelEl.dxButton({
                            text: "H·ªßy",
                            type: "danger",
                            stylingMode: "contained"
                        }).dxButton("instance");
                    } else {
                        dxBtnCancelContact = cancelInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxButton cho btn-cancel-contact:'', e);
                }

                // Button - L∆∞u ng∆∞·ªùi li√™n h·ªá
                try {
 var saveEl = $("#btn-save-contact");
                    if (saveEl.length === 0) return;
                    var saveInstance = getDxInstance(saveEl, "dxButton");
                    if (!saveInstance) {
                        dxBtnSaveContact = saveEl.dxButton({
                            text: "L∆∞u ng∆∞·ªùi li√™n h·ªá",
                            type: "success",
                            stylingMode: "contained",
                            useSubmitBehavior: true
                        }).dxButton("instance");
                    } else {
                        dxBtnSaveContact = saveInstance;
                    }
                } catch (e) {
                    console.error(''L·ªói kh·ªüi t·∫°o dxButton cho btn-save-contact:'', e);
                }
            } catch (e) {
                console.error(''L·ªói t·ªïng qu√°t trong initContactModalComponents:'', e);
            }
        }

        // Format input khi ng∆∞·ªùi d√πng nh·∫≠p v√† c·∫≠p nh·∫≠t th√†nh ti·ªÅn ngay l·∫≠p t·ª©c
        window.formatPriceInput = function (input) {
            // L·∫•y gi√° tr·ªã s·ªë t·ª´ input (b·ªè c√°c k√Ω t·ª± kh√¥ng ph·∫£i s·ªë)
            var rawValue = input.value.replace(/[^\d]/g, '''');

            if (rawValue === '''' || rawValue === ''0'') {
                input.value = '''';
                input.dataset.value = ''0'';
            } else {
                var numValue = parseInt(rawValue);
                input.dataset.value = numValue;
                // Format l·∫°i v·ªõi d·∫•u ph√¢n c√°ch h√†ng ngh√¨n
                input.value = formatCurrencyRaw(numValue);
            }

            // ‚úÖ C·∫≠p nh·∫≠t th√†nh ti·ªÅn c·ªßa row n√†y ngay l·∫≠p t·ª©c
            updateRowTotal(input);
            // ‚úÖ C·∫≠p nh·∫≠t t·ªïng thanh to√°n ngay l·∫≠p t·ª©c
            calculateTotal();
        };
        document.getElementById("btn-quick-add-contact").onclick = function () {
            // Kh·ªüi t·∫°o DevExtreme components cho modal contact
            initContactModalComponents();

            // ƒê·ªï danh s√°ch c√¥ng ty v√†o dropdown trong modal th√™m m·ªõi
            var items = [];
            items.push({ value: '''', text: ''-- Ch·ªçn c√¥ng ty --'' });
            companyList.forEach(function (c) {
                items.push({ value: c.Company_ID, text: c.Company });
            });

            if (dxNewContactCompany) {
                dxNewContactCompany.option("dataSource", items);
                dxNewContactCompany.option("value", '''');
            }

            // Reset form
            if (dxNewContactName) dxNewContactName.option("value", '''');
            if (dxNewContactPhone) dxNewContactPhone.option("value", '''');
            if (dxNewContactEmail) dxNewContactEmail.option("value", '''');

            document.getElementById("form-quick-add-contact").reset();
            document.getElementById("modal-add-contact").classList.add("show");
        };

        // 2. ƒê√≥ng Modal
        function closeContactModal() {
            document.getElementById("modal-add-contact").classList.remove("show");
        }
        document.getElementById("close-modal-contact").onclick = closeContactModal;
        document.getElementById("btn-cancel-contact").onclick = closeContactModal;

        // 3. X·ª≠ l√Ω l∆∞u ng∆∞·ªùi li√™n h·ªá m·ªõi
        document.getElementById("form-quick-add-contact").onsubmit = function (e) {
            e.preventDefault();

            var name = dxNewContactName ? (dxNewContactName.option("value") || '''').toString().trim() : '''';
            var phone = dxNewContactPhone ? (dxNewContactPhone.option("value") || '''').toString().trim() : '''';
            var email = dxNewContactEmail ? (dxNewContactEmail.option("value") || '''').toString().trim() : '''';
            var companyId = dxNewContactCompany ? (dxNewContactCompany.option("value") || '''').toString() : '''';

            if (!currentLoginID) {
                alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëƒÉng nh·∫≠p!");
return;
            }

            AjaxHPAParadise({
 data: {
  name: "sp_Sub_CRM_CustomerPerson_Insert",
              param: [
                        "FullName", name,
                        "PhoneNumber", phone,
                        "Email", email,
                        "CompanyID", companyId,
                        "LoginID", currentLoginID
                    ]
                },
                success: function (res) {
                    try {
                        var parsed = JSON.parse(res);
                        var resultData = parsed.data;
                        if (Array.isArray(resultData) && resultData.length > 0 && Array.isArray(resultData[0])) resultData = resultData[0];

                        if (resultData && resultData[0] && resultData[0].Result === ''SUCCESS'') {
                            var newId = resultData[0].NewContactID;

                            // Th√¥ng b√°o th√†nh c√¥ng
                            if (typeof uiManager !== ''undefined'') {
                                uiManager.showAlert({ type: "success", message: "ƒê√£ th√™m ng∆∞·ªùi li√™n h·ªá m·ªõi!" });
                            }

                            // T·∫£i l·∫°i danh s√°ch ng∆∞·ªùi li√™n h·ªá v√† t·ª± ƒë·ªông ch·ªçn ng∆∞·ªùi m·ªõi
                            loadCRMCustomerPersons().then(function () {
                                renderContactDropdown(newId, name);
                                applyContactSelection(newId);
                                closeContactModal();
                            });
                        } else {
                            alert(resultData[0].Message || "L·ªói khi l∆∞u d·ªØ li·ªáu");
                        }
                    } catch (e) {
                        console.error("L·ªói parse response:", e);
                    }
                },
                error: function (err) {
                    console.error("L·ªói API:", err);
                }
            });
        };
        // C·∫≠p nh·∫≠t th√†nh ti·ªÅn c·ªßa m·ªôt row c·ª• th·ªÉ
        function updateRowTotal(priceInput) {
            // T√¨m row ch·ª©a input n√†y
            var row = priceInput.closest(''tr'');
            if (!row) return;

            // L·∫•y gi√° b·∫£n quy·ªÅn v√† gi√° tri·ªÉn khai
            var licensePriceInput = row.querySelector(".item-license-price");
            var customizePriceInput = row.querySelector(".item-customize-price");

            var licensePrice = licensePriceInput ? getItemPriceValue(licensePriceInput) : 0;
            var customizePrice = customizePriceInput ? getItemPriceValue(customizePriceInput) : 0;

            // Th√†nh ti·ªÅn = Ph√≠ b·∫£n quy·ªÅn + Ph√≠ tri·ªÉn khai
            var lineTotal = licensePrice + customizePrice;

            // C·∫≠p nh·∫≠t th√†nh ti·ªÅn trong row
            var totalElement = row.querySelector(".item-total");
            if (totalElement) {
                totalElement.textContent = formatCurrency(lineTotal);
            }
        }

        // C·∫≠p nh·∫≠t gi√° tr·ªã th·ª±c t·∫ø khi blur (khi ng∆∞·ªùi d√πng r·ªùi kh·ªèi input)
        window.updateItemPriceValue = function (input) {
            var rawValue = input.value.replace(/[^\d]/g, '''');
            var numValue = parseInt(rawValue) || 0;
            input.dataset.value = numValue;
            input.value = numValue > 0 ? formatCurrencyRaw(numValue) : '''';
            // ‚úÖ C·∫≠p nh·∫≠t th√†nh ti·ªÅn v√† t·ªïng khi blur
            updateRowTotal(input);
            calculateTotal();
        };

        // L·∫•y gi√° tr·ªã s·ªë t·ª´ input (parse t·ª´ dataset.value ho·∫∑c value)
        function getItemPriceValue(input) {
            if (input && input.dataset && input.dataset.value) {
                return parseFloat(input.dataset.value) || 0;
            }
            if (input && input.value) {
                var rawValue = input.value.replace(/[^\d]/g, '''');
                return parseFloat(rawValue) || 0;

            }
            return 0;
        }

        // C·∫≠p nh·∫≠t gi√° t·ª´ dropdown (khi ch·ªçn s·∫£n ph·∫©m)
        window.updateItemPrice = function (input) {
            // C·∫≠p nh·∫≠t th√†nh ti·ªÅn v√† t·ªïng
            updateRowTotal(input);
            calculateTotal();
        };

        function getTodayDate() {
            return new Date().toISOString().split(''T'')[0];
        }

        // --- H√†m chu·∫©n h√≥a ti·∫øng Vi·ªát (b·ªè d·∫•u) ƒë·ªÉ t√¨m ki·∫øm kh√¥ng ph√¢n bi·ªát d·∫•u ---
        function normalizeVietnamese(str) {
            if (!str) return '''';
            str = String(str);
            // Map c√°c k√Ω t·ª± c√≥ d·∫•u sang kh√¥ng d·∫•u
            var map = {
                ''√†'': ''a'', ''√°'': ''a'', ''·∫°'': ''a'', ''·∫£'': ''a'', ''√£'': ''a'',
                ''√¢'': ''a'', ''·∫ß'': ''a'', ''·∫•'': ''a'', ''·∫≠'': ''a'', ''·∫©'': ''a'', ''·∫´'': ''a'',
                ''ƒÉ'': ''a'', ''·∫±'': ''a'', ''·∫Ø'': ''a'', ''·∫∑'': ''a'', ''·∫≥'': ''a'', ''·∫µ'': ''a'',
                ''√®'': ''e'', ''√©'': ''e'', ''·∫π'': ''e'', ''·∫ª'': ''e'', ''·∫Ω'': ''e'',
                ''√™'': ''e'', ''·ªÅ'': ''e'', ''·∫ø'': ''e'', ''·ªá'': ''e'', ''·ªÉ'': ''e'', ''·ªÖ'': ''e'',
                ''√¨'': ''i'', ''√≠'': ''i'', ''·ªã'': ''i'', ''·ªâ'': ''i'', ''ƒ©'': ''i'',
                ''√≤'': ''o'', ''√≥'': ''o'', ''·ªç'': ''o'', ''·ªè'': ''o'', ''√µ'': ''o'',
                ''√¥'': ''o'', ''·ªì'': ''o'', ''·ªë'': ''o'', ''·ªô'': ''o'', ''·ªï'': ''o'', ''·ªó'': ''o'',
                ''∆°'': ''o'', ''·ªù'': ''o'', ''·ªõ'': ''o'', ''·ª£'': ''o'', ''·ªü'': ''o'', ''·ª°'': ''o'',
                ''√π'': ''u'', ''√∫'': ''u'', ''·ª•'': ''u'', ''·ªß'': ''u'', ''≈©'': ''u'',
                ''∆∞'': ''u'', ''·ª´'': ''u'', ''·ª©'': ''u'', ''·ª±'': ''u'', ''·ª≠'': ''u'', ''·ªØ'': ''u'',
                ''·ª≥'': ''y'', ''√Ω'': ''y'', ''·ªµ'': ''y'', ''·ª∑'': ''y'', ''·ªπ'': ''y'',
                ''ƒë'': ''d'',
                ''√Ä'': ''A'', ''√Å'': ''A'', ''·∫†'': ''A'', ''·∫¢'': ''A'', ''√É'': ''A'',
                ''√Ç'': ''A'', ''·∫¶'': ''A'', ''·∫§'': ''A'', ''·∫¨'': ''A'', ''·∫®'': ''A'', ''·∫™'': ''A'',
                ''ƒÇ'': ''A'', ''·∫∞'': ''A'', ''·∫Æ'': ''A'', ''·∫∂'': ''A'', ''·∫≤'': ''A'', ''·∫¥'': ''A'',
                ''√à'': ''E'', ''√â'': ''E'', ''·∫∏'': ''E'', ''·∫∫'': ''E'', ''·∫º'': ''E'',
                ''√ä'': ''E'', ''·ªÄ'': ''E'', ''·∫æ'': ''E'', ''·ªÜ'': ''E'', ''·ªÇ'': ''E'', ''·ªÑ'': ''E'',
                ''√å'': ''I'', ''√ç'': ''I'', ''·ªä'': ''I'', ''·ªà'': ''I'', ''ƒ®'': ''I'',
                ''√í'': ''O'', ''√ì'': ''O'', ''·ªå'': ''O'', ''·ªé'': ''O'', ''√ï'': ''O'',
                ''√î'': ''O'', ''·ªí'': ''O'', ''·ªê'': ''O'', ''·ªò'': ''O'', ''·ªî'': ''O'', ''·ªñ'': ''O'',
                ''∆†'': ''O'', ''·ªú'': ''O'', ''·ªö'': ''O'', ''·ª¢'': ''O'', ''·ªû'': ''O'', ''·ª†'': ''O'',
                ''√ô'': ''U'', ''√ö'': ''U'', ''·ª§'': ''U'', ''·ª¶'': ''U'', ''≈®'': ''U'',
                ''∆Ø'': ''U'', ''·ª™'': ''U'', ''·ª®'': ''U'', ''·ª∞'': ''U'', ''·ª¨'': ''U'', ''·ªÆ'': ''U'',
                ''·ª≤'': ''Y'', ''√ù'': ''Y'', ''·ª¥'': ''Y'', ''·ª∂'': ''Y'', ''·ª∏'': ''Y'',
                ''ƒê'': ''D''
            };
            return str.replace(/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë√Ä√Å·∫†·∫¢√É√Ç·∫¶·∫§·∫¨·∫®·∫™ƒÇ·∫∞·∫Æ·∫∂·∫≤·∫¥√à√â·∫∏·∫∫·∫º√ä·ªÄ·∫æ·ªÜ·ªÇ·ªÑ√å√ç·ªä·ªàƒ®√í√ì·ªå·ªé√ï√î·ªí·ªê·ªò·ªî·ªñ∆†·ªú·ªö·ª¢·ªû·ª†√ô√ö·ª§·ª¶≈®∆Ø·ª™·ª®·ª∞·ª¨·ªÆ·ª≤√ù·ª¥·ª∂·ª∏ƒê]/g, function (m) {
                return map[m] || m;
            }).toLowerCase();
        }

        // --- H√ÄM L·∫§Y LOGIN ID ---
        function getCurrentLoginID() {
            var loginID = null;

            // C√°ch 1: T·ª´ h√†m h·ªá th·ªëng
            if (typeof GetLoginID === ''function'') {
                try {
                    loginID = GetLoginID();
                    if (loginID && loginID > 0) {
                        return loginID;
                    }
                } catch (e) {
                    // B·ªè qua l·ªói
                }
            }

            // C√°ch 2: T·ª´ localStorage (th·ª≠ nhi·ªÅu key kh√°c nhau)
            var localStorageKeys = [''LoginID'', ''loginID'', ''LoginId'', ''loginId'', ''userLoginID'', ''UserLoginID''];
            for (var i = 0; i < localStorageKeys.length; i++) {
                var key = localStorageKeys[i];
       var value = localStorage.getItem(key);
                if (value) {
                    loginID = parseInt(value);
                    if (loginID && loginID > 0) {
                        return loginID;
                    }
                }
            }

            // C√°ch 3: T·ª´ sessionStorage
            var sessionStorageKeys = [''LoginID'', ''loginID'', ''LoginId'', ''loginId'', ''userLoginID'', ''UserLoginID''];
            for (var j = 0; j < sessionStorageKeys.length; j++) {
                var sessKey = sessionStorageKeys[j];
                var sessValue = sessionStorage.getItem(sessKey);
                if (sessValue) {
                    loginID = parseInt(sessValue);
                    if (loginID && loginID > 0) {
                        return loginID;
                    }
                }
            }

            // C√°ch 4: T·ª´ global variable (th·ª≠ nhi·ªÅu t√™n kh√°c nhau)
            var globalVars = [''LoginID'', ''loginID'', ''LoginId'', ''loginId'', ''userLoginID'', ''UserLoginID'', ''currentLoginID'', ''CurrentLoginID''];
            for (var k = 0; k < globalVars.length; k++) {
                var varName = globalVars[k];
                if (typeof window[varName] !== ''undefined'' && window[varName] !== null) {
                    loginID = parseInt(window[varName]);
                    if (loginID && loginID > 0) {
                        return loginID;
                    }
                }
            }

            // C√°ch 5: T·ª´ document (n·∫øu c√≥ attribute)
            try {
                var docLoginID = document.documentElement.getAttribute(''data-login-id'') ||
                    document.body.getAttribute(''data-login-id'') ||
                    (document.getElementById(''sp_quotation_manager'') ? document.getElementById(''sp_quotation_manager'').getAttribute(''data-login-id'') : null);
                if (docLoginID) {
                    loginID = parseInt(docLoginID);
                    if (loginID && loginID > 0) {
                        return loginID;
                    }
                }
            } catch (e) {
                // B·ªè qua l·ªói
            }

            // C√°ch 6: T·ª´ cookie
            try {
                function getCookie(name) {
                    var nameEQ = name + "=";
                    var ca = document.cookie.split('';'');
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) === '' '') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                }

                var cookieKeys = [''LoginID'', ''loginID'', ''LoginId'', ''loginId'', ''userLoginID'', ''UserLoginID'', ''Login_ID'', ''login_id''];
                for (var c = 0; c < cookieKeys.length; c++) {
                    var cookieValue = getCookie(cookieKeys[c]);
                    if (cookieValue) {
                        loginID = parseInt(cookieValue);
                        if (loginID && loginID > 0) {
                            return loginID;
                        }
                    }
                }
            } catch (e) {
                // B·ªè qua l·ªói
            }

            // C√°ch 7: Th·ª≠ g·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin user hi·ªán t·∫°i (kh√¥ng c·∫ßn LoginID)
            // N·∫øu c√≥ API l·∫•y user info kh√¥ng c·∫ßn LoginID, s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong loadCurrentUserInfo

            // ‚ùå KH√îNG T√åM TH·∫§Y LOGINID - Debug ƒë·ªÉ t√¨m

            return null;
        }

        // --- LOAD TH√îNG TIN USER HI·ªÜN T·∫†I ---
        function loadCurrentUserInfo(callback) {
            currentLoginID = getCurrentLoginID();

            // N·∫øu kh√¥ng t√¨m th·∫•y LoginID, th·ª≠ g·ªçi API kh√¥ng c·∫ßn LoginID ƒë·ªÉ l·∫•y th√¥ng tin user
            if (!currentLoginID) {
            // Th·ª≠ t√¨m LoginID t·ª´ t·∫•t c·∫£ c√°c ngu·ªìn c√≥ th·ªÉ (bao g·ªìm c·∫£ trong window object)
                try {
                    // Ki·ªÉm tra t·∫•t c·∫£ c√°c property trong window
                    for (var prop in window) {
                        if (prop.toLowerCase().includes(''login'') && typeof window[prop] === ''number'' && window[prop] > 0) {
                            currentLoginID = window[prop];
                            break;
                        }
                    }

                    // Ki·ªÉm tra t·∫•t c·∫£ cookies
                    var allCookies = document.cookie.split('';'');
                    for (var i = 0; i < allCookies.length; i++) {
                        var cookie = allCookies[i].trim();
                        var parts = cookie.split(''='');
                        if (parts.length === 2) {
                            var key = parts[0].trim();
                            var value = parts[1].trim();
                            if (key.toLowerCase().includes(''login'') && !isNaN(value) && parseInt(value) > 0) {
                                currentLoginID = parseInt(value);
                                break;
                            }
                        }
                    }
                } catch (e) {
                    // B·ªè qua l·ªói
                }
            }

            // N·∫øu v·∫´n kh√¥ng c√≥ LoginID, th·ª≠ g·ªçi API kh√¥ng c·∫ßn LoginID
            if (!currentLoginID) {
                // Th·ª≠ g·ªçi API l·∫•y th√¥ng tin user hi·ªán t·∫°i (kh√¥ng c·∫ßn LoginID)
                AjaxHPAParadise({
                    data: { name: "sp_Sub_GetCurrentUserInfo", param: [] },
                    success: function (res) {
                        try {
                            var parsed = JSON.parse(res);
                            var data = parsed.data;
                            if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];

                            if (data && data.length > 0 && data[0] && data[0].LoginID) {
                                currentLoginID = data[0].LoginID;
                                // Ti·∫øp t·ª•c load th√¥ng tin user v·ªõi LoginID v·ª´a l·∫•y ƒë∆∞·ª£c
                                loadCurrentUserInfoWithLoginID(callback);
                            } else {
                                console.error(''‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c LoginID t·ª´ API. Vui l√≤ng ƒëƒÉng nh·∫≠p!'');
                                if (typeof uiManager !== ''undefined'') {
                                    uiManager.showAlert({ type: "error", message: "%PleaseLogin%" });
                                }
                                if (callback) callback(); // V·∫´n g·ªçi callback ƒë·ªÉ kh√¥ng block
                            }
                        } catch (e) {
                            console.error(''‚ùå L·ªói parse response t·ª´ API GetCurrentUserInfo:'', e);
                            if (typeof uiManager !== ''undefined'') {
                                uiManager.showAlert({ type: "error", message: "%PleaseLogin%" });
                            }
                            if (callback) callback(); // V·∫´n g·ªçi callback ƒë·ªÉ kh√¥ng block
                        }
                    },
                    error: function (err) {
                        console.error(''‚ùå L·ªói g·ªçi API GetCurrentUserInfo:'', err);
                        if (typeof uiManager !== ''undefined'') {
                            uiManager.showAlert({ type: "error", message: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng!" });
                        }
                        if (callback) callback(); // V·∫´n g·ªçi callback ƒë·ªÉ kh√¥ng block
                    }
                });
                return;
            }

            // N·∫øu ƒë√£ c√≥ LoginID, ti·∫øp t·ª•c load th√¥ng tin user
            loadCurrentUserInfoWithLoginID(callback);
        }

        // --- LOAD TH√îNG TIN USER V·ªöI LOGINID ---
        function loadCurrentUserInfoWithLoginID(callback) {
            if (!currentLoginID) {
                if (callback) callback();
          return;
            }


            AjaxHPAParadise({
                data: { name: "sp_Sub_GetCurrentUserInfo", param: ["LoginID", currentLoginID] },
                success: function (res) {
                    try {
                        var parsed = JSON.parse(res);
                        var data = parsed.data;
                        if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];

                        if (data && data.length > 0) {
                            currentUserInfo = data[0];
                            currentEmployeeID = currentUserInfo.EmployeeID;


                            // Load danh s√°ch nh√¢n vi√™n ph√≤ng ban
                            loadEmployeeList(callback);
                        } else {
                            console.warn(''‚ö†Ô∏è Kh√¥ng c√≥ th√¥ng tin user, nh∆∞ng v·∫´n ti·∫øp t·ª•c load data...'');
                            // V·∫´n g·ªçi callback ƒë·ªÉ load data (c√≥ th·ªÉ kh√¥ng c√≥ EmployeeID nh∆∞ng v·∫´n c√≥ LoginID)
                            if (callback) callback();
                        }
                    } catch (e) {
                        console.error(''L·ªói load user info:'', e);
                        console.warn(''‚ö†Ô∏è V·∫´n ti·∫øp t·ª•c load data v·ªõi LoginID:'', currentLoginID);
                        if (callback) callback();
                    }
                },
                error: function (err) {
                    console.error(''API Error khi load user info:'', err);
                    console.warn(''‚ö†Ô∏è V·∫´n ti·∫øp t·ª•c load data v·ªõi LoginID:'', currentLoginID);
                    if (callback) callback();
                }
            });
        }

        // --- LOAD DANH S√ÅCH NH√ÇN VI√äN PH√íNG BAN 4 ---
        function loadEmployeeList(callback) {
            AjaxHPAParadise({
                data: { name: "sp_Sub_Employee_GetByDepartment", param: ["DepartmentID", 4] },
                success: function (res) {
                    try {
                        var parsed = JSON.parse(res);
                        var data = parsed.data;
                        if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];
                        employeeList = Array.isArray(data) ? data : [];


                        if (callback) callback();
                    } catch (e) {
                        console.error(e);
                        if (callback) callback();
                    }
                },
                error: function (err) {
                    console.error(err);
                    if (callback) callback();
                }
            });
        }

        // --- LOAD DANH S√ÅCH C√îNG TY CRM ---
        function loadCRMCompanies() {
            return new Promise(function (resolve, reject) {
                AjaxHPAParadise({
                    data: { name: "sp_Sub_CRM_CompanyInfo_Get", param: [] },
                    success: function (res) {
                        try {
                            var parsed = JSON.parse(res);
                            var data = parsed.data;
                            if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];
                            companyList = Array.isArray(data) ? data : [];
                            resolve();
                        } catch (e) {
                            reject(e);
                        }
                    },
                    error: function (err) { reject(err); }
                });
            });
        }

        // --- LOAD DANH S√ÅCH NG∆Ø·ªúI LI√äN H·ªÜ CRM ---
        function loadCRMCustomerPersons() {
            return new Promise(function (resolve, reject) {
                AjaxHPAParadise({
                    data: { name: "sp_Sub_CRM_CustomerPersonInfo_Get", param: [] },
                    success: function (res) {
                        try {
             var parsed = JSON.parse(res);
 var data = parsed.data;
                            if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];
                            customerPersonList = Array.isArray(data) ? data : [];
                            resolve();
                        } catch (e) {
                            reject(e);
                        }
                    },
                    error: function (err) { reject(err); }
                });
            });
        }

        // --- ƒê·ªî NG∆Ø·ªúI LI√äN H·ªÜ V√Ä T·ª∞ ƒêI·ªÄN TH√îNG TIN LI√äN QUAN ---
        function renderContactDropdown(selectedId, fallbackDisplayText) {
            if (!dxQuoteContactPerson) return;

            var items = [];
            items.push({ value: '''', text: ''-- Ch·ªçn ng∆∞·ªùi li√™n h·ªá --'' });

            customerPersonList.forEach(function (p) {
                var item = Object.assign({}, p); // Clone to√†n b·ªô properties t·ª´ object g·ªëc
                // Th√™m c√°c field chu·∫©n ƒë·ªÉ t∆∞∆°ng th√≠ch logic c≈© v√† hi·ªÉn th·ªã c∆° b·∫£n
                item.value = p.CRM_CustomerID;
                item.text = p.FullName || '''';

                // Gi·ªØ map c√°c field c≈© ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng break logic hi·ªán t·∫°i
                item.companyId = p.CRM_CompanyID || '''';
                item.phone = p.PhoneNumber || '''';
                item.email = p.Email || '''';

                items.push(item);
            });

            // N·∫øu kh√¥ng t√¨m th·∫•y ID nh∆∞ng c√≥ t√™n c≈©, th√™m option t·∫°m ƒë·ªÉ hi·ªÉn th·ªã
            if (!selectedId && fallbackDisplayText) {
                items.push({ value: ''__legacy__'', text: fallbackDisplayText });
            }

            try {
                dxQuoteContactPerson.option("dataSource", items);
                if (selectedId) {
                    dxQuoteContactPerson.option("value", selectedId);
                    // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin khi c√≥ selectedId
                    setTimeout(function () {
                        applyContactSelection(selectedId);
                    }, 100);
                } else if (fallbackDisplayText) {
                    dxQuoteContactPerson.option("value", ''__legacy__'');
                } else {
                    dxQuoteContactPerson.option("value", '''');
                }
            } catch (e) {
                console.error(''L·ªói khi set dataSource v√† value cho dxQuoteContactPerson:'', e);
            }
        }

        function applyContactSelection(contactIdOrObject) {
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p nh·∫≠n ƒë∆∞·ª£c object t·ª´ DevExtreme SelectBox
            var contactId = null;
            var contactData = null;

            // Reset t·∫•t c·∫£ c√°c tr∆∞·ªùng n·∫øu kh√¥ng c√≥ gi√° tr·ªã - NH∆ØNG V·∫™N GI·ªÆ READONLY
            if (!contactIdOrObject || contactIdOrObject === '''' || contactIdOrObject === ''__legacy__'') {
                if (dxQuotePhone) {
                    dxQuotePhone.option("value", '''');
                    dxQuotePhone.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteEmail) {
                    dxQuoteEmail.option("value", '''');
                    dxQuoteEmail.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteCustomer) {
                    dxQuoteCustomer.option("value", '''');
                    dxQuoteCustomer.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteAddress) {
                    dxQuoteAddress.option("value", '''');
                    dxQuoteAddress.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                return;
            }

            console.log("ü§û ~ applyContactSelection input:", contactIdOrObject);

            // N·∫øu l√† object (t·ª´ DevExtreme SelectBox v·ªõi displayExpr v√† valueExpr)
 if (typeof contactIdOrObject === ''object'' && contactIdOrObject !== null) {
               contactId = contactIdOrObject.value || contactIdOrObject.CRM_CustomerID;
                contactData = contactIdOrObject; // L∆∞u object ƒë·ªÉ d√πng tr·ª±c ti·∫øp
            } else {
                contactId = contactIdOrObject;
            }

            console.log("ü§û ~ contactId:", contactId);
            console.log("ü§û ~ contactData:", contactData);

            if (!contactId) {
                if (dxQuotePhone) {
                    dxQuotePhone.option("value", '''');
                    dxQuotePhone.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteEmail) {
                    dxQuoteEmail.option("value", '''');
                    dxQuoteEmail.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteCustomer) {
                    dxQuoteCustomer.option("value", '''');
                    dxQuoteCustomer.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteAddress) {
                    dxQuoteAddress.option("value", '''');
                    dxQuoteAddress.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                return;
            }

            var selectedContact = null;

            // LU√îN t√¨m trong customerPersonList ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin
            if (customerPersonList && customerPersonList.length > 0) {
                selectedContact = customerPersonList.find(function (p) {
                    return String(p.CRM_CustomerID) === String(contactId);
                });
            }

            // N·∫øu kh√¥ng t√¨m th·∫•y trong list, fallback sang contactData
            if (!selectedContact && contactData) {
                selectedContact = {
                    CRM_CustomerID: contactId,
                    PhoneNumber: contactData.PhoneNumber || contactData.phone || '''',
                    Email: contactData.Email || contactData.email || '''',
                    CRM_CompanyID: contactData.CRM_CompanyID || contactData.companyId || null
                };
            }

            if (!selectedContact) {
                console.warn(''Kh√¥ng t√¨m th·∫•y contact v·ªõi ID:'', contactId);
                if (dxQuotePhone) {
                    dxQuotePhone.option("value", '''');
                    dxQuotePhone.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteEmail) {
                    dxQuoteEmail.option("value", '''');
                    dxQuoteEmail.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteCustomer) {
                    dxQuoteCustomer.option("value", '''');
                    dxQuoteCustomer.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                if (dxQuoteAddress) {
                    dxQuoteAddress.option("value", '''');
                    dxQuoteAddress.option("readOnly", true);  // ‚úÖ V·∫™N READONLY
                }
                return;
            }

            console.log("ü§û ~ selectedContact resolved:", selectedContact);

            var companyId = selectedContact.CRM_CompanyID;
            var company = companyList && companyList.length > 0 ?
                companyList.find(function (c) { return String(c.Company_ID) === String(companyId); }) : null;

            console.log("ü§û ~ company resolved:", company);

            try {
                // ƒêi·ªÅn s·ªë ƒëi·ªán tho·∫°i v√† ƒë·∫∑t readonly
                if (dxQuotePhone) {
                    dxQuotePhone.option("value", selectedContact.PhoneNumber || '''');
                    dxQuotePhone.option("readOnly", true);
                }
                // ƒêi·ªÅn email v√† ƒë·∫∑t readonly
                if (dxQuoteEmail) {
                    dxQuoteEmail.option("value", selectedContact.Email || '''');
                    dxQuoteEmail.option("readOnly", true);
                }

                // ƒêi·ªÅn th√¥ng tin c√¥ng ty n·∫øu c√≥
                if (company) {
                    if (dxQuoteCustomer) {
                        dxQuoteCustomer.option("value", company.Company || '''');
                        dxQuoteCustomer.option("readOnly", true);
                    }
                    if (dxQuoteAddress) {
                        dxQuoteAddress.option("value", company.Address || '''');
                        dxQuoteAddress.option("readOnly", true);
                    }
                } else {
                    // N·∫øu kh√¥ng c√≥ c√¥ng ty, v·∫´n gi·ªØ readonly nh∆∞ng ƒë·ªÉ tr·ªëng
                    if (dxQuoteCustomer) {
                        dxQuoteCustomer.option("value", '''');
                        dxQuoteCustomer.option("readOnly", true);
                    }
                    if (dxQuoteAddress) {
                        dxQuoteAddress.option("value", '''');
                        dxQuoteAddress.option("readOnly", true);
                    }
                }

                console.log("‚úÖ ƒê√£ ƒëi·ªÅn th√¥ng tin ng∆∞·ªùi li√™n h·ªá th√†nh c√¥ng");
            } catch (e) {
                console.error(''L·ªói khi set gi√° tr·ªã cho c√°c field t·ª´ contact selection:'', e);
            }
        }

        // --- DELETE ALL ITEMS C·ª¶A QUOTATION ---
        function deleteAllQuoteItems(quoteID, callback) {
            if (!currentLoginID || !quoteID) {
                console.warn(''‚ö†Ô∏è Kh√¥ng c√≥ LoginID ho·∫∑c QuoteID, kh√¥ng th·ªÉ x√≥a items'');
                if (callback) callback(true); // Tr·∫£ v·ªÅ true ƒë·ªÉ kh√¥ng block flow
                return;
            }


            // Load t·∫•t c·∫£ items c≈© tr∆∞·ªõc
            loadQuoteItems(quoteID, function (oldItems) {
                if (!oldItems || oldItems.length === 0) {
                    if (callback) callback(true);
                    return;
                }


                // X√≥a t·ª´ng item
                var deletePromises = oldItems.map(function (item) {
                    return new Promise(function (resolve, reject) {
                        AjaxHPAParadise({
                            data: {
                                name: "sp_Sub_QuotationItems_Delete",
                                param: ["ItemID", item.ItemID, "LoginID", currentLoginID]
                            },
                            success: function (res) {
                                try {
                                    var parsed = JSON.parse(res);
                                    var data = parsed.data;
                                    if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];

                                    if (data && data[0] && data[0].Result === ''SUCCESS'') {
                                        resolve(true);
                                    } else {
                                        var errorMsg = data && data[0] ? data[0].Message : ''Unknown error'';
                                        console.warn(''‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a ItemID'', item.ItemID, '':'', errorMsg);
                                        resolve(true); // V·∫´n resolve ƒë·ªÉ kh√¥ng block
                                    }
                                } catch (e) {
                                    console.error(''‚ùå L·ªói parse response khi x√≥a item:'', e);
                                    resolve(true); // V·∫´n resolve ƒë·ªÉ kh√¥ng block
                                }
                            },
                            error: function (err) {
                                console.error(''‚ùå L·ªói API khi x√≥a item:'', err);
                                resolve(true); // V·∫´n resolve ƒë·ªÉ kh√¥ng block
                            }
                        });
                    });
                });

                Promise.all(deletePromises).then(function () {
                    if (callback) callback(true);
                }).catch(function (err) {
                    console.error(''‚ùå L·ªói khi x√≥a items c≈©:'', err);
                    if (callback) callback(true); // V·∫´n callback ƒë·ªÉ kh√¥ng block
                });
            });
        }

        // --- SAVE ITEMS C·ª¶A QUOTATION ---
        function saveQuoteItems(quoteID, items, callback) {
            if (!currentLoginID || !quoteID || !items || items.length === 0) {
                console.warn(''‚ö†Ô∏è Kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ l∆∞u items'');
                if (callback) callback(false);
                return;
            }


            // N·∫øu l√† Update, x√≥a items c≈© tr∆∞·ªõc (s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong stored procedure Update, nh∆∞ng ƒë·ªÉ an to√†n v·∫´n x√≥a tr∆∞·ªõc)
            var promises = [];

            items.forEach(function (item, idx) {
                var promise = new Promise(function (resolve, reject) {
                    // ‚úÖ Log ƒë·ªÉ debug ItemType tr∆∞·ªõc khi g·ª≠i

                    // ‚úÖ Chu·∫©n b·ªã params ƒë·ªÉ g·ª≠i
                    var params = [
                        "QuoteID", quoteID,
                        "ProductID", item.ProductID,
                        "ProductName", item.ProductName,
                        "UnitPrice", item.UnitPrice, // T·ªïng gi√° = LicensePrice + CustomizePrice
                        "Quantity", item.Quantity,
                        "Discount", item.Discount,
                        "ItemType", item.ItemType || ''Subsystem'', // ‚úÖ G·ª≠i ItemType
                        "SubLicensePrice", item.LicensePrice || 0, // ‚úÖ G·ª≠i SubLicensePrice
                        "SubCustomizePrice", item.CustomizePrice || 0, // ‚úÖ G·ª≠i SubCustomizePrice
                        "LoginID", currentLoginID
                    ];

                    AjaxHPAParadise({
                        data: {
                            name: "sp_Sub_QuotationItems_Insert",
                            param: params
                        },
                        success: function (res) {
                            try {
                                var parsed = JSON.parse(res);
                                var data = parsed.data;
                                if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];

                                if (data && data[0] && data[0].Result === ''SUCCESS'') {
                                    resolve(true);
                                } else {
                                    var errorMsg = data && data[0] ? data[0].Message : ''Unknown error'';
                                    console.error(''‚ùå L·ªói insert item'', idx + 1, '':'', errorMsg);
                                    console.error(''  ‚Üí ItemType ƒë∆∞·ª£c g·ª≠i:'', item.ItemType);
                                    reject(new Error(errorMsg));
                                }
                            } catch (e) {
                                console.error(''‚ùå L·ªói parse response:'', e);
                                console.error(''  ‚Üí Raw response:'', res);
                                reject(e);
                            }
                        },
                        error: function (err) {
                            console.error(''‚ùå L·ªói API insert item'', idx, '':'', err);
                            reject(err);
                        }
                    });
                });
                promises.push(promise);
            });

            Promise.all(promises).then(function () {
                if (callback) callback(true);
            }).catch(function (err) {
                console.error(''‚ùå L·ªói khi l∆∞u items:'', err);
                if (callback) callback(false);
            });
        }

        // --- LOAD ITEMS C·ª¶A QUOTATION ---
        function loadQuoteItems(quoteID, callback) {
            if (!currentLoginID || !quoteID) {
                console.warn(''‚ö†Ô∏è Kh√¥ng c√≥ LoginID ho·∫∑c QuoteID, kh√¥ng th·ªÉ load items'');
                if (callback) callback([]);
                return;
            }

            AjaxHPAParadise({
                data: {
                    name: "sp_Sub_QuotationItems_Get",
                    param: ["QuoteID", quoteID, "LoginID", currentLoginID]
                },
                success: function (res) {
                    try {
                        var parsed = JSON.parse(res);
                        var data = parsed.data;
                        if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];

                        var items = Array.isArray(data) ? data : [];
                        if (callback) callback(items);
                    } catch (e) {
                        console.error(''‚ùå L·ªói parse items:'', e);
                        if (callback) callback([]);
                    }
                },
                error: function (err) {
                    console.error(''‚ùå L·ªói load items:'', err);
                    if (callback) callback([]);
                }
            });
        }

        // --- FILL DROPDOWN NG∆Ø·ªúI T·∫†O B√ÅO GI√Å ---
        function fillCreatorDropdown(quoteData) {
            if (!dxQuoteCreator) {
                console.warn(''dxQuoteCreator ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o'');
                return;
            }

            // Ki·ªÉm tra employeeList ƒë√£ ƒë∆∞·ª£c load ch∆∞a
            if (!employeeList || employeeList.length === 0) {
                console.warn(''employeeList ch∆∞a ƒë∆∞·ª£c load, ƒëang ch·ªù...'');
                // ƒê·ª£i m·ªôt ch√∫t r·ªìi th·ª≠ l·∫°i
                setTimeout(function () {
                    fillCreatorDropdown(quoteData);
                }, 500);
                return;
            }

            // ‚úÖ L·∫•y EmployeeID v√† CreatorName c·ªßa ng∆∞·ªùi t·∫°o b√°o gi√° (n·∫øu ƒëang edit)
            var creatorEmployeeID = null;
            var creatorName = null;
            if (quoteData) {
                creatorEmployeeID = quoteData.CreatedByEmployeeID || null;
                creatorName = quoteData.CreatorName || null; // ‚úÖ L·∫•y t√™n t·ª´ database
            }

            var items = [];
            var selectedValue = null;

            if (isAdmin) {
                // Admin c√≥ th·ªÉ ch·ªçn b·∫•t k·ª≥ nh√¢n vi√™n n√†o trong ph√≤ng ban
                items.push({ value: '''', text: ''-- Ch·ªçn ng∆∞·ªùi t·∫°o --'' });
                employeeList.forEach(emp => {
                    items.push({ value: emp.EmployeeID, text: emp.FullName });
                    // ‚úÖ N·∫øu ƒëang edit, ch·ªçn ng∆∞·ªùi t·∫°o b√°o gi√°; n·∫øu kh√¥ng th√¨ ch·ªçn user hi·ªán t·∫°i
                    if (creatorEmployeeID) {
                        if (emp.EmployeeID === creatorEmployeeID) selectedValue = emp.EmployeeID;
                    } else {
                        if (emp.EmployeeID === currentEmployeeID) selectedValue = currentEmployeeID;
                    }
                });

                // ‚úÖ N·∫øu ƒëang edit v√† c√≥ CreatorName nh∆∞ng kh√¥ng t√¨m th·∫•y trong employeeList, th√™m option ri√™ng
                if (creatorEmployeeID && creatorName) {
                    var foundInList = employeeList.some(e => e.EmployeeID === creatorEmployeeID);
                    if (!foundInList) {
                        items.push({ value: creatorEmployeeID, text: creatorName });
                        selectedValue = creatorEmployeeID;
                    }
                }

                dxQuoteCreator.option("disabled", false);
            } else {
                // ‚úÖ User th∆∞·ªùng: N·∫øu ƒëang edit, hi·ªÉn th·ªã ng∆∞·ªùi t·∫°o b√°o gi√°; n·∫øu t·∫°o m·ªõi th√¨ hi·ªÉn th·ªã ch√≠nh m√¨nh
                var displayEmployeeID = creatorEmployeeID || currentEmployeeID;
                var displayEmp = employeeList.find(e => e.EmployeeID === displayEmployeeID);

                if (displayEmp) {
                    // ‚úÖ T√¨m th·∫•y trong danh s√°ch, d√πng t√™n t·ª´ danh s√°ch
                    items.push({ value: displayEmp.EmployeeID, text: displayEmp.FullName });
                    selectedValue = displayEmp.EmployeeID;
                } else if (creatorEmployeeID && creatorName) {
                  // ‚úÖ ƒêang edit v√† c√≥ CreatorName t·ª´ database, d√πng t√™n ƒë√≥
                    items.push({ value: creatorEmployeeID, text: creatorName });
                    selectedValue = creatorEmployeeID;
                } else {
                    // Fallback n·∫øu kh√¥ng c√≥ th√¥ng tin
                    var displayName = creatorEmployeeID ? (creatorName || ''%QuotationCreator%'') : ''%CurrentUser%'';
                    items.push({ value: displayEmployeeID, text: displayName });
                    selectedValue = displayEmployeeID;
                }
                dxQuoteCreator.option("disabled", true); // Kh√≥a kh√¥ng cho ƒë·ªïi
            }

            try {
                dxQuoteCreator.option("dataSource", items);
                dxQuoteCreator.option("value", selectedValue);
            } catch (e) {
                console.error(''L·ªói khi set dataSource v√† value cho dxQuoteCreator:'', e);
            }
        }

        // --- 0. Control JS ---
        let DataSource = []
        window.currentRecordID_Company_ID = null; window.currentRecordID_CRM_CustomerID = null; window.currentRecordID_QuoteID = null;
        window.ValidationEngine = window.ValidationEngine || {};
        window.ValidationEngine.getRequiredMessage = function (displayName) {
            return "kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng " + (displayName || "tr∆∞·ªùng n√†y");
        };

        '
            + (select loadUI from tblCommonControlType_Signed where UID = 'P61E6A4D534D544DD9CF69BCB7853BC57')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PAD1A48ED0FEA4B8FA2437F80F18F7056')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PEDB116F05C8A4B2CA7B171F40C527313')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P76A3C0DA8AEE41D096DF9D78AC1546CE')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P1E62274470194872A17C143B1515E563')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P59392C8190A145579C4929A0A9998304')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P4BD2A7E0E5094D77B00C28AE1EF377C0')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PCE49AAC954D241799FF775DDA7B6650E')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P62A6B8693851494C86E78A4ABB105511')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P6B60ED34C18A433A832E018552A35E32')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PC68F34CBC4E346A29BB759E7A9FC2E5D')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P8DBE48299B124653B68EFF25360E901C') +N'

        function loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback) {
			console.log(columnName, dataSourceSP, onSuccessCallback)
            if (!columnName || !dataSourceSP || dataSourceSP.trim() === "") {
                console.warn("[loadDataSourceCommon] Missing columnName or dataSourceSP");
                return;
            }

            const dataSourceKey = "DataSource_" + columnName;
            // S·ª≠ d·ª•ng format: columnNameDataSourceLoaded ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi code hi·ªán t·∫°i
            const loadedKey = columnName + "DataSourceLoaded";

            // Ki·ªÉm tra n·∫øu ƒë√£ load r·ªìi th√¨ kh√¥ng load l·∫°i
            if (window[loadedKey] === true) {
                if (typeof onSuccessCallback === "function") {
                    onSuccessCallback(window[dataSourceKey] || []);
                }
                return;
            }

            // Ki·ªÉm tra n·∫øu ƒëang load th√¨ ƒë·ª£i
            if (window[loadedKey] === "loading") {
                // ƒê·ª£i m·ªôt ch√∫t r·ªìi th·ª≠ l·∫°i
                setTimeout(function() {
                    loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback);
                }, 100);

                return;
            }

            // ƒê√°nh d·∫•u ƒëang load ƒë·ªÉ tr√°nh load tr√πng l·∫∑p
            window[loadedKey] = "loading";

            return new Promise((resolve, reject) => {
                AjaxHPAParadise({
                    data: {
                        name: dataSourceSP,
                        param: ["LoginID", LoginID, "LanguageID", LanguageID]
                    },
                    success: function (res) {
                        const json = typeof res === "string" ? JSON.parse(res) : res;

                        window[dataSourceKey] = (json.data && json.data[0]) || [];
                        window[loadedKey] = true;

                        // ∆Øu ti√™n l·∫•y t·ª´ json response (n·∫øu API tr·∫£ v·ªÅ explicit)
                        // Sau ƒë√≥ m·ªõi fallback query dataSchema
                        let idField = json.valueExpr;
                        let nameField = json.displayExpr;

                        if (!idField || !nameField) {
                            if (json.dataSchema && json.dataSchema[0]) {
                                const schema = json.dataSchema[0];
                                if (!idField) idField = schema[0]?.name;
                                if (!nameField) nameField = schema[1]?.name;
                            }
                        }

                        window["DataSourceIDField_" + columnName]   = idField || "ID";
                        window["DataSourceNameField_" + columnName] = nameField || "Name";

                        const data = window[dataSourceKey];

                        // callback tr∆∞·ªõc
                        if (typeof onSuccessCallback === "function") {
                            onSuccessCallback(data, json);
                        }

                        // resolve sau
                        resolve(data);
                    },
                    error: function (err) {
                        console.error("[loadDataSourceCommon] Failed to load datasource for", columnName, ":", err);
                        window[loadedKey] = false;

                        if (typeof onSuccessCallback === "function") {
                            onSuccessCallback([]);
                        }

                        reject(err);
                    }
                });
            });
        }

        // --- 1. LOAD DATA (C√ì PH√ÇN QUY·ªÄN) ---
        function loadData() {
            // ‚úÖ KI·ªÇM TRA B·∫ÆT BU·ªòC: PH·∫¢I C√ì LOGINID
            if (!currentLoginID) {
                console.error(''‚ùå‚ùå‚ùå KH√îNG TH·ªÇ LOAD DATA - THI·∫æU LOGINID!'');
                hideLoading();
                var emptyEl = document.getElementById("quote_empty");
                if (emptyEl) {
                    emptyEl.style.visibility = "visible";
                    emptyEl.style.opacity = "1";
                    emptyEl.innerHTML = `
                        <div class="text-center py-5">
                            <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <h5 style="color: #dc3545;">L·ªói: Kh√¥ng t√¨m th·∫•y LoginID</h5>
                            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng.</p>
                        </div>
      `;
}
                return;
            }

            showLoading();

            // Load SubProducts (Ph√¢n h·ªá)
            var pSubProducts = new Promise((resolve, reject) => {
                AjaxHPAParadise({
                    data: { name: "sp_Sub_SubProduct_Get", param: [] },
                    success: function (res) {
                        try {
                            var parsed = JSON.parse(res);
                            var data = parsed.data;
                            if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) data = data[0];
                            subProducts = Array.isArray(data) ? data.filter(x => x.Status === 1) : [];
                            resolve();
                        } catch (e) { reject(e); }
                    },
                    error: function (err) { reject(err); }
                });
            });

            // Load Quotations C√ì PH√ÇN QUY·ªÄN
            var pQuotes = new Promise((resolve, reject) => {
                // ‚úÖ LU√îN G·ª¨I LOGINID (B·∫ÆT BU·ªòC) - ƒê·∫£m b·∫£o l√† number
                var loginIDInt = parseInt(currentLoginID);
                if (isNaN(loginIDInt) || loginIDInt <= 0) {
                    console.error(''‚ùå LoginID kh√¥ng h·ª£p l·ªá:'', currentLoginID);
                    reject(new Error(''LoginID kh√¥ng h·ª£p l·ªá''));
                    return;
                }

                var params = ["LoginID", loginIDInt, "ShowAll", isAdmin ? 1 : 0];


                AjaxHPAParadise({
                    data: { name: "sp_Sub_Quotation_Get", param: params },
                    success: function (res) {
                        try {
                            var parsed = JSON.parse(res);
                            var data = parsed.data;
                            var obj = data;
  const json = typeof res === "string" ? JSON.parse(res) : res;
                            const results = Array.isArray(json?.data?.[0]) ? json.data[0] : (json?.data?.[0] ? [json.data[0]] : []);

                            if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0])) {
                                data = data[0];
                            }

                            // x·ª≠ l√Ω data cho control
                            if (obj) { window.currentRecordID_Company_ID = (obj.Company_ID !== undefined && obj.Company_ID !== null) ? obj.Company_ID : window.currentRecordID_Company_ID; } if (obj) { window.currentRecordID_CRM_CustomerID = (obj.CRM_CustomerID !== undefined && obj.CRM_CustomerID !== null) ? obj.CRM_CustomerID : window.currentRecordID_CRM_CustomerID; } if (obj) { window.currentRecordID_QuoteID = (obj.QuoteID !== undefined && obj.QuoteID !== null) ? obj.QuoteID : window.currentRecordID_QuoteID; }
                            DataSource = results;
                            '
                                + (select loadData from tblCommonControlType_Signed where UID = 'P61E6A4D534D544DD9CF69BCB7853BC57')
                    + (select loadData from tblCommonControlType_Signed where UID = 'PAD1A48ED0FEA4B8FA2437F80F18F7056')
                + (select loadData from tblCommonControlType_Signed where UID = 'PEDB116F05C8A4B2CA7B171F40C527313')
            +(select loadData from tblCommonControlType_Signed where UID = 'P76A3C0DA8AEE41D096DF9D78AC1546CE')
            +(select loadData from tblCommonControlType_Signed where UID = 'P1E62274470194872A17C143B1515E563')
            +(select loadData from tblCommonControlType_Signed where UID = 'P59392C8190A145579C4929A0A9998304')
            +(select loadData from tblCommonControlType_Signed where UID = 'P4BD2A7E0E5094D77B00C28AE1EF377C0')
            +(select loadData from tblCommonControlType_Signed where UID = 'PCE49AAC954D241799FF775DDA7B6650E')
            +(select loadData from tblCommonControlType_Signed where UID = 'P62A6B8693851494C86E78A4ABB105511')
            +(select loadData from tblCommonControlType_Signed where UID = 'P6B60ED34C18A433A832E018552A35E32')
            +(select loadData from tblCommonControlType_Signed where UID = 'PC68F34CBC4E346A29BB759E7A9FC2E5D')
            +(select loadData from tblCommonControlType_Signed where UID = 'P8DBE48299B124653B68EFF25360E901C') +N'

            quotes = Array.isArray(data) ? data : [];

            // ‚úÖ KI·ªÇM TRA ERROR MESSAGE T·ª™ STORED PROCEDURE
            if (quotes.length > 0 && quotes[0] && quotes[0].Result === ''ERROR'') {
                var errorMsg = quotes[0].Message || "LoginIDNotFound%.";
                console.error(''‚ùå Stored procedure tr·∫£ v·ªÅ ERROR:'', errorMsg);
                console.error(''‚ùå QuoteID:'', quotes[0].QuoteID);
                console.error(''‚ùå currentLoginID ƒë∆∞·ª£c g·ª≠i:'', currentLoginID);

                // N·∫øu l√† ERROR, kh√¥ng load data
                quotes = [];

                if (typeof uiManager !== ''undefined'') {
                    uiManager.showAlert({
                        type: "error",
                        message: errorMsg
                    });
                }

                // V·∫´n resolve ƒë·ªÉ kh√¥ng break Promise chain
                resolve();
                return;
            }

            // ‚úÖ NORMALIZE KEYS: X·ª≠ l√Ω c·∫£ PascalCase v√† lowercase
            var keyMap = {
                ''quoteid'': ''QuoteID'',
                ''quotecode'': ''QuoteCode'',
                ''quotedate'': ''QuoteDate'',
                ''customername'': ''CustomerName'',
                ''customerphone'': ''CustomerPhone'',
                ''customeremail'': ''CustomerEmail'',
                ''customeraddress'': ''CustomerAddress'',
                ''totalamount'': ''TotalAmount'',
                ''notes'': ''Notes'',
                ''status'': ''Status'',
                ''createdbyemployeeid'': ''CreatedByEmployeeID'',
                ''createdbyloginid'': ''CreatedByLoginID'',
                ''createddate'': ''CreatedDate'',
               ''createdat'': ''CreatedAt'',
                ''modifieddate'': ''ModifiedDate'',
                ''updatedat'': ''UpdatedAt'',
                ''creatorname'': ''CreatorName'', // ‚úÖ Th√™m CreatorName
                ''creatoremail'': ''CreatorEmail'', // ‚úÖ Th√™m CreatorEmail
                ''contactperson'': ''ContactPerson'' // ‚úÖ Th√™m ContactPerson
            };

            quotes = quotes.map(function (q) {
                // T·∫°o object m·ªõi v·ªõi keys ƒë√£ normalize
                var normalized = {};
                Object.keys(q).forEach(function (key) {
                    // N·∫øu c√≥ mapping th√¨ d√πng key PascalCase
                    var pascalKey = keyMap[key.toLowerCase()];
                    if (pascalKey) {
                        normalized[pascalKey] = q[key];
                    } else {
                        // Gi·ªØ nguy√™n key g·ªëc n·∫øu kh√¥ng c√≥ mapping
                        normalized[key] = q[key];
                    }
                });
                return normalized;
            });


            resolve();
        } catch (e) {
            console.error(''‚ùå L·ªói parse d·ªØ li·ªáu:'', e);
            console.error(''‚ùå Response g√¢y l·ªói:'', res);
            reject(e);
        }
    },
        error: function (err) {
            console.error(''‚ùå L·ªói g·ªçi API:'', err);
            reject(err);
        }
                });
            });

    var pCompanies = loadCRMCompanies().catch(function (err) {
        console.error(''‚ùå L·ªói load c√¥ng ty CRM:'', err);
        companyList = [];
    });
    var pContacts = pCompanies.then(() => loadCRMCustomerPersons().catch(function (err) {
        console.error(''‚ùå L·ªói load ng∆∞·ªùi li√™n h·ªá CRM:'', err);
        customerPersonList = [];
    }));

    Promise.all([pSubProducts, pQuotes, pCompanies, pContacts]).then(() => {
        renderGrid();
    }).catch(err => {
        console.error(err);
    }).finally(() => {
        hideLoading();
 });
    }

    // --- 2. RENDER GRID ---
    function renderGrid() {
        var searchText = document.getElementById("search-quote").value;

        // ‚úÖ Chu·∫©n h√≥a text t√¨m ki·∫øm (b·ªè d·∫•u v√† chuy·ªÉn lowercase)
        var normalizedSearch = normalizeVietnamese(searchText);

        var filteredData = quotes.filter(q => {
            // ‚úÖ Ki·ªÉm tra match text (h·ªó tr·ª£ ti·∫øng Vi·ªát c√≥ d·∫•u)
            var matchText = true; // M·∫∑c ƒë·ªãnh match n·∫øu kh√¥ng c√≥ text t√¨m ki·∫øm
            if (normalizedSearch && normalizedSearch.trim() !== '''') {
                // Chu·∫©n h√≥a c√°c field c·∫ßn t√¨m v√† so s√°nh
                var normalizedCustomerName = normalizeVietnamese(q.CustomerName || '''');
                var normalizedContactPerson = normalizeVietnamese(q.ContactPerson || '''');
                var normalizedQuoteCode = normalizeVietnamese(q.QuoteCode || '''');

                // T√¨m ki·∫øm kh√¥ng ph√¢n bi·ªát d·∫•u
                matchText = normalizedCustomerName.includes(normalizedSearch) ||
                    normalizedContactPerson.includes(normalizedSearch) ||
                    normalizedQuoteCode.includes(normalizedSearch);
            }
            return matchText;
        });

        var gridContentEl = document.getElementById("quote_grid_content");
        var emptyEl = document.getElementById("quote_empty");

        if (filteredData.length === 0 && quotes.length === 0) {
            if (gridContentEl) {
                gridContentEl.style.visibility = "hidden";
                gridContentEl.style.opacity = "0";
            }
            if (emptyEl) {
                emptyEl.style.visibility = "visible";
                emptyEl.style.opacity = "1";
            }
            return;
        }

        if (gridContentEl) {
            gridContentEl.style.visibility = "visible";
         gridContentEl.style.opacity = "1";
        }
        if (emptyEl) {
            emptyEl.style.visibility = "hidden";
            emptyEl.style.opacity = "0";
        }

        if (gridInstance) {
            gridInstance.option("dataSource", filteredData);
        } else {
            gridInstance = $("#quote_grid").dxDataGrid({
                dataSource: filteredData,
                keyExpr: "QuoteID",
                showBorders: false,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                paging: { pageSize: 15 },
                columns: [
                    {
                        dataField: "QuoteCode",
                        caption: "%GridQuotationCode%",
                        width: 180,
                        cellTemplate: function (container, options) {
                            $("<div>").addClass("fw-bold").text(options.value).appendTo(container);
                        }
                    },
                    {
                        dataField: "CustomerName",
                        caption: "%GridCustomer%",
                        minWidth: 200,
                        cellTemplate: function (container, options) {
                            $("<div>").addClass("fw-bold").text(options.value).appendTo(container);
                            if (options.data.CustomerPhone) {
                                $("<small>").addClass("opacity-75").text(options.data.CustomerPhone).appendTo(container);
                            }
                        }
                    },
                    {
                        dataField: "ContactPerson",
                        caption: "%ContactPerson%",
                        width: 150,
                        cellTemplate: function (container, options) {
                            $("<div>").text(options.value || '''').appendTo(container);
                        }
                    },
                    {
                        dataField: "CreatorName",
        caption: "%GridCreator%",
                        width: 150,
        cellTemplate: function (container, options) {
                            var creatorName = options.value || options.data.CreatorName || ''N/A'';
                            $("<div>").text(creatorName).appendTo(container);
                        }
                    },
                    {
                        dataField: "QuoteDate",
                        caption: "%GridCreateDate%",
                        width: 110,
                        dataType: "date",
                        format: "dd/MM/yyyy"
                    },
                    {
                        dataField: "TotalAmount",
                        caption: "%GridTotalPayment%",
                        width: 150,
                        alignment: "right",
                        cellTemplate: function (container, options) {
                            $("<span>").addClass("fw-bold text-success").text(formatCurrency(options.value || 0)).appendTo(container);
                        }
                    },
                    {
                        caption: "%GridActions%",
                        width: 100,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            var quoteID = options.data.QuoteID;

                            // N√∫t Export
                            $("<button>")
                                .addClass("btn btn-sm btn-success")
                                .attr("title", "%ExportQuotationTitle%")
                                .html(''<i class="bi bi-download"></i>'')
                                .on("click", function (e) {
                                    e.stopPropagation(); // NgƒÉn kh√¥ng cho trigger onRowClick
                                    exportQuotationDataQuick(quoteID);
                                })
                                .appendTo(container);
                        }
                 }
                ],
                onRowClick: function (e) { openEditModal(e.data.QuoteID); }
            }).dxDataGrid("instance");
        }
    }

    // --- 3. MODAL ACTIONS ---
    function openEditModal(id) {
        initQuoteModalComponents(); // ‚úÖ Ensure components are initialized
        editingId = id;
        subsystemItemCounter = 0;
        document.getElementById("modal-quote-form").reset();
        document.getElementById("subsystem-items-tbody").innerHTML = "";



        var deleteBtn = document.getElementById("modal-quote-delete");
        var exportBtn = document.getElementById("modal-quote-export");
        var title = document.getElementById("modal-quote-title");

        if (id) {
            // Edit Mode
            var quote = quotes.find(x => x.QuoteID === id);
            if (quote) {

                title.innerHTML = ''<i class="bi bi-pencil-square me-2"></i>%UpdateQuotation%'';
                if (dxQuoteDelete) dxQuoteDelete.option("visible", true);
                if (dxQuoteExport) dxQuoteExport.option("visible", true);

                if (dxQuoteCode) {
                    dxQuoteCode.option("value", quote.QuoteCode || '''');
                    dxQuoteCode.option("readOnly", true);
                }

                // X·ª≠ l√Ω ng√†y (h·ªó tr·ª£ c·∫£ CreatedAt v√† CreatedDate)
                var quoteDate = quote.QuoteDate || quote.CreatedAt || quote.CreatedDate;
                if (quoteDate) {
                    var dateStr = typeof quoteDate === ''string'' ? quoteDate.split(''T'')[0] : quoteDate;
                    if (dxQuoteDate) {
                        dxQuoteDate.option("value", new Date(dateStr));
                        dxQuoteDate.option("readOnly", true);
                    }
                } else {
                    if (dxQuoteDate) {
                        dxQuoteDate.option("value", new Date(getTodayDate()));
                        dxQuoteDate.option("readOnly", true);
}
                }

                if (dxQuoteCustomer) dxQuoteCustomer.option("value", quote.CustomerName || '''');
                if (dxQuotePhone) dxQuotePhone.option("value", quote.CustomerPhone || '''');
                if (dxQuoteEmail) dxQuoteEmail.option("value", quote.CustomerEmail || '''');
                if (dxQuoteAddress) dxQuoteAddress.option("value", quote.CustomerAddress || '''');
                if (dxQuoteNotes) dxQuoteNotes.option("value", quote.Notes || '''');

                // ‚úÖ Fill ng∆∞·ªùi t·∫°o - hi·ªÉn th·ªã ƒë√∫ng ng∆∞·ªùi t·∫°o b√°o gi√° (t·ª´ CreatedByEmployeeID)
                fillCreatorDropdown(quote);

                // ‚úÖ Ch·ªçn ng∆∞·ªùi li√™n h·ªá t·ª´ CRM (∆∞u ti√™n match theo Phone/Email, fallback theo t√™n)
                var matchedContact = null;
                if (quote.CustomerPhone) {
                    matchedContact = customerPersonList.find(function (p) { return (p.PhoneNumber || '''').trim() === quote.CustomerPhone.trim(); });
                }
                if (!matchedContact && quote.CustomerEmail) {
                    matchedContact = customerPersonList.find(function (p) { return (p.Email || '''').trim().toLowerCase() === quote.CustomerEmail.trim().toLowerCase(); });
                }
                if (!matchedContact && quote.ContactPerson) {
                    matchedContact = customerPersonList.find(function (p) { return (p.FullName || '''').trim().toLowerCase() === quote.ContactPerson.trim().toLowerCase(); });
                }

                renderContactDropdown(matchedContact ? matchedContact.CRM_CustomerID : null, quote.ContactPerson || '''');
                if (matchedContact) {
                    applyContactSelection(matchedContact.CRM_CustomerID);
                }

                // ‚úÖ Load items t·ª´ b·∫£ng ri√™ng
                loadQuoteItems(id, function (items) {
                    if (items && Array.isArray(items) && items.length > 0) {
                items.forEach(item => {
                            addSubsystemItemRow(item);
                        });
                    }
                    // ‚úÖ C·∫≠p nh·∫≠t dropdown sau khi load items
                    updateSubsystemDropdowns();
                    calculateTotal();
                });
            } else {
                console.error(''‚ùå Kh√¥ng t√¨m th·∫•y quote v·ªõi QuoteID:'', id);
                if (typeof uiManager !== ''undefined'') {
                    uiManager.showAlert({ type: "error", message: "%%QuotationNotFound" });
                }
            }
        } else {
            // Add Mode
            title.innerHTML = ''<i class="bi bi-file-earmark-plus me-2"></i>T·∫°o b√°o gi√° m·ªõi'';
            if (dxQuoteDelete) dxQuoteDelete.option("visible", false);
            if (dxQuoteExport) dxQuoteExport.option("visible", false);

            if (dxQuoteDate) {
                dxQuoteDate.option("value", new Date(getTodayDate()));
                dxQuoteDate.option("readOnly", false);
            }

            // ‚úÖ Reset c√°c tr∆∞·ªùng v·ªÅ gi√° tr·ªã r·ªóng - NH∆ØNG V·∫™N GI·ªÆ READONLY
            if (dxQuoteCustomer) {
                dxQuoteCustomer.option("value", '''');
                dxQuoteCustomer.option("readOnly", true);  // ‚úÖ CH·ªà CHO PH√âP CH·ªåN T·ª™ DROPDOWN
            }
            if (dxQuotePhone) {
                dxQuotePhone.option("value", '''');
                dxQuotePhone.option("readOnly", true);  // ‚úÖ CH·ªà CHO PH√âP CH·ªåN T·ª™ DROPDOWN
            }
            if (dxQuoteEmail) {
                dxQuoteEmail.option("value", '''');
                dxQuoteEmail.option("readOnly", true);  // ‚úÖ CH·ªà CHO PH√âP CH·ªåN T·ª™ DROPDOWN
            }
            if (dxQuoteAddress) {
                dxQuoteAddress.option("value", '''');
                dxQuoteAddress.option("readOnly", true);  // ‚úÖ CH·ªà CHO PH√âP CH·ªåN T·ª™ DROPDOWN
            }
if (dxQuoteNotes) {
                dxQuoteNotes.option("value", '''');
            }

   // ‚úÖ Fill ng∆∞·ªùi t·∫°o - t·∫°o m·ªõi th√¨ hi·ªÉn th·ªã user hi·ªán t·∫°i
            fillCreatorDropdown(null);
            renderContactDropdown(null, null);

            // Generate new code t·ª± ƒë·ªông (d√πng timestamp ƒë·ªÉ ƒë·∫£m b·∫£o unique)
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, ''0'');
            var day = String(now.getDate()).padStart(2, ''0'');
            var hours = String(now.getHours()).padStart(2, ''0'');
            var minutes = String(now.getMinutes()).padStart(2, ''0'');
            var seconds = String(now.getSeconds()).padStart(2, ''0'');
            var newCode = ''BG-'' + year + month + day + ''-'' + hours + minutes + seconds;
            if (dxQuoteCode) {
                dxQuoteCode.option("value", newCode);
                dxQuoteCode.option("readOnly", true);
            }
        }

        document.getElementById("modal-quote").classList.add("show");

        // N·∫øu l√† Add mode, t√≠nh total ngay. Edit mode s·∫Ω t√≠nh sau khi load items xong
        if (!id) {
            calculateTotal();
        }
    }

    // --- 4. ITEMS MANAGEMENT ---
    // ‚úÖ L·∫•y danh s√°ch ProductID ƒë√£ ƒë∆∞·ª£c ch·ªçn
    function getSelectedSubsystemProductIDs() {
        var selectedIDs = new Set();
        var subsystemRows = document.querySelectorAll("#subsystem-items-tbody tr");
        subsystemRows.forEach(row => {
            var select = row.querySelector(".item-product");
            if (select && select.value) {
                selectedIDs.add(parseInt(select.value));
            }
        });
        return selectedIDs;
    }

    // ‚úÖ C·∫≠p nh·∫≠t dropdown
    function updateSubsystemDropdowns(excludeRowId) {
        var selectedIDs = getSelectedSubsystemProductIDs();
        var subsystemRows = document.querySelectorAll("#subsystem-items-tbody tr");
        subsystemRows.forEach(row => {
            // Skip row ƒëang ƒë∆∞·ª£c update (n·∫øu c√≥)
            if (excludeRowId && row.id === excludeRowId) return;

            var select = row.querySelector(".item-product");
            if (!select) return;

            var currentValue = select.value;
            var options = select.querySelectorAll("option");
            options.forEach(option => {
                if (!option.value) return; // Skip empty option

                var optionID = parseInt(option.value);
                var isSelected = selectedIDs.has(optionID);

                if (isSelected && option.value !== currentValue) {
                    // Disable n·∫øu ƒë√£ ƒë∆∞·ª£c ch·ªçn ·ªü ch·ªó kh√°c
                    option.disabled = true;
                    option.style.color = ''#ccc'';
                } else {
                    // Enable n·∫øu ch∆∞a ƒë∆∞·ª£c ch·ªçn ho·∫∑c l√† option hi·ªán t·∫°i
                    option.disabled = false;
                    option.style.color = '''';
                }
            });
        });
    }

    // Th√™m ph√¢n h·ªá
    function addSubsystemItemRow(data) {
        subsystemItemCounter++;
        var row = document.createElement("tr");
        row.id = "subsystem-item-row-" + subsystemItemCounter;
        row.dataset.itemId = subsystemItemCounter;
        row.dataset.itemType = "Subsystem";


        // ‚úÖ L·∫•y danh s√°ch ProductID ƒë√£ ƒë∆∞·ª£c ch·ªçn
        var selectedIDs = getSelectedSubsystemProductIDs();
        if (data && data.ProductID) {
            selectedIDs.add(parseInt(data.ProductID)); // Th√™m item hi·ªán t·∫°i v√†o selected
        }

        // Build product options (·∫©n c√°c option ƒë√£ ƒë∆∞·ª£c ch·ªçn)
        var productOptions = ''<option value="">-- Ch·ªçn ph√¢n h·ªá --</option>'';
        subProducts.forEach(p => {
            var isSelected = selectedIDs.has(p.SubID);
            var selected = data && data.ProductID === p.SubID ? ''selected'' : '''';
            var disabled = isSelected && (!data || data.ProductID !== p.SubID) ? ''disabled style="color: #ccc;"'' : '''';
            productOptions += `<option value="${p.SubID}" data-license-price="${p.SubLicensePrice || 0}" data-customize-price="${p.SubCustomizePrice || 0}" ${selected} ${disabled}>${p.SubName}</option>`;
        });

        // L·∫•y gi√° ban ƒë·∫ßu t·ª´ data ho·∫∑c t·ª´ product
        var initialLicensePrice = 0;
        var initialCustomizePrice = 0;

        if (data) {
            // N·∫øu c√≥ data t·ª´ database (khi edit)
            // ‚úÖ ∆Øu ti√™n l·∫•y t·ª´ database (SubLicensePrice v√† SubCustomizePrice)
            initialLicensePrice = data.SubLicensePrice || data.LicensePrice || 0;
            initialCustomizePrice = data.SubCustomizePrice || data.CustomizePrice || 0;

            // N·∫øu v·∫´n kh√¥ng c√≥ gi√° t·ª´ database, l·∫•y t·ª´ product d·ª±a tr√™n ProductID
            if (initialLicensePrice === 0 && initialCustomizePrice === 0 && data.ProductID) {
                var product = subProducts.find(p => p.SubID === parseInt(data.ProductID));
                if (product) {
                    initialLicensePrice = product.SubLicensePrice || 0;
                    initialCustomizePrice = product.SubCustomizePrice || 0;
                }
            }
        }

        row.innerHTML = `
                <td class="text-center">${subsystemItemCounter}</td>
                <td>
                    <select class="form-select form-select-sm item-product" onchange="updateSubsystemItemPrice(${subsystemItemCounter})">
                        ${productOptions}
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm item-license-price" value="${initialLicensePrice > 0 ? formatCurrencyRaw(initialLicensePrice) : ''''}"
                        data-value="${initialLicensePrice || 0}"
   onchange="updateItemPrice(this);"
             oninput="formatPriceInput(this);"
                        onblur="updateItemPriceValue(this);"
                        placeholder="Ph√≠ b·∫£n quy·ªÅn">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm item-customize-price" value="${initialCustomizePrice > 0 ? formatCurrencyRaw(initialCustomizePrice) : ''''}"
                        data-value="${initialCustomizePrice || 0}"
                        onchange="updateItemPrice(this);"
                        oninput="formatPriceInput(this);"
                        onblur="updateItemPriceValue(this);"
                        placeholder="Ph√≠ tri·ªÉn khai">
                </td>
                <td class="text-end fw-bold item-total">0 ‚Ç´</td>
                <td class="text-center">
                    <button type="button" class="btn-remove-item" onclick="removeSubsystemItemRow(${subsystemItemCounter})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            `;

        // ‚úÖ ƒê·∫£m b·∫£o add v√†o ƒë√∫ng tbody
        var subsystemTbody = document.getElementById("subsystem-items-tbody");
        if (!subsystemTbody) {
            console.error(''‚ùå Kh√¥ng t√¨m th·∫•y #subsystem-items-tbody'');
            return;
        }
        subsystemTbody.appendChild(row);

        // ‚úÖ C·∫≠p nh·∫≠t dropdown sau khi th√™m row m·ªõi
        updateSubsystemDropdowns();
        // ‚úÖ T√≠nh t·ªïng sau khi th√™m row (ƒë·ªÉ c·∫≠p nh·∫≠t th√†nh ti·ªÅn ngay)
        calculateTotal();
    }

    window.updateSubsystemItemPrice = function (itemId) {
        var row = document.getElementById("subsystem-item-row-" + itemId);
        if (!row) {
            console.error(''‚ùå Kh√¥ng t√¨m th·∫•y row:'', ''subsystem-item-row-'' + itemId);
            return;
        }

        var select = row.querySelector(".item-product");
        var licensePriceInput = row.querySelector(".item-license-price");
        var customizePriceInput = row.querySelector(".item-customize-price");

        if (!select || !licensePriceInput || !customizePriceInput) {
            console.error(''‚ùå Kh√¥ng t√¨m th·∫•y select ho·∫∑c priceInput trong row'');
            return;
        }

        var selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.value) {
            // L·∫•y gi√° t·ª´ data-license-price v√† data-customize-price attributes
            var licensePrice = 0;
            var customizePrice = 0;

            if (selectedOption.dataset.licensePrice) {
                licensePrice = parseFloat(selectedOption.dataset.licensePrice) || 0;
            }
            if (selectedOption.dataset.customizePrice) {
                customizePrice = parseFloat(selectedOption.dataset.customizePrice) || 0;
            }

            // N·∫øu kh√¥ng c√≥ trong dataset, t√¨m trong subProducts
            if (licensePrice === 0 && customizePrice === 0) {
                var productId = parseInt(selectedOption.value);
                var product = subProducts.find(p => p.SubID === productId);
                if (product) {
                    licensePrice = product.SubLicensePrice || 0;
                    customizePrice = product.SubCustomizePrice || 0;
                }
            }

            // Format v√† set gi√° v√†o input
            licensePriceInput.dataset.value = licensePrice;
            licensePriceInput.value = licensePrice > 0 ? formatCurrencyRaw(licensePrice) : '''';

            customizePriceInput.dataset.value = customizePrice;
            customizePriceInput.value = customizePrice > 0 ? formatCurrencyRaw(customizePrice) : '''';

        } else {
            licensePriceInput.dataset.value = ''0'';
            licensePriceInput.value = '''';
            customizePriceInput.dataset.value = ''0'';
            customizePriceInput.value = '''';
        }

        // ‚úÖ C·∫≠p nh·∫≠t dropdown sau khi ch·ªçn
        updateSubsystemDropdowns(row.id);
        calculateTotal();
    };

    window.removeSubsystemItemRow = function (itemId) {
        var row = document.getElementById("subsystem-item-row-" + itemId);
        if (row) {
            row.remove();
            // ‚úÖ C·∫≠p nh·∫≠t dropdown sau khi x√≥a
            updateSubsystemDropdowns();
            calculateTotal();
        }
    };

    function calculateTotal() {
        // T√≠nh t·ªïng - ch·ªâ t√≠nh c√°c item ƒë√£ ch·ªçn s·∫£n ph·∫©m
        var grandTotal = 0;
        var subsystemRows = document.querySelectorAll("#subsystem-items-tbody tr");
        subsystemRows.forEach(row => {
            var productSelect = row.querySelector(".item-product");
            // Ch·ªâ t√≠nh n·∫øu ƒë√£ ch·ªçn s·∫£n ph·∫©m (c√≥ productId)
            if (productSelect && productSelect.value) {
                var licensePriceInput = row.querySelector(".item-license-price");
                var customizePriceInput = row.querySelector(".item-customize-price");

                var licensePrice = licensePriceInput ? getItemPriceValue(licensePriceInput) : 0;
                var customizePrice = customizePriceInput ? getItemPriceValue(customizePriceInput) : 0;

                // Th√†nh ti·ªÅn = Ph√≠ b·∫£n quy·ªÅn + Ph√≠ tri·ªÉn khai
                var lineTotal = licensePrice + customizePrice;

                var totalElement = row.querySelector(".item-total");
                if (totalElement) {
                    totalElement.textContent = formatCurrency(lineTotal);
                }
                grandTotal += lineTotal;
            } else {
                // N·∫øu ch∆∞a ch·ªçn s·∫£n ph·∫©m, hi·ªÉn th·ªã 0
                var totalElement = row.querySelector(".item-total");
                if (totalElement) {
                    totalElement.textContent = formatCurrency(0);
                }
            }
        });

        // C·∫≠p nh·∫≠t t·ªïng thanh to√°n
        var grandTotalEl = document.getElementById("grand-total");
        if (grandTotalEl) grandTotalEl.textContent = formatCurrency(grandTotal);
    }

    // --- EVENTS ---
    document.getElementById("show-add-quote").onclick = () => openEditModal(null);
    document.getElementById("close-modal-quote").onclick = () => document.getElementById("modal-quote").classList.remove("show");
    document.getElementById("search-quote").oninput = renderGrid;
    document.getElementById("btn-add-subsystem").onclick = () => addSubsystemItemRow(null);
    // Event handler cho contact person s·∫Ω ƒë∆∞·ª£c g√°n trong initQuoteModalComponents

    // --- CRUD SUBMIT (C√ì PH√ÇN QUY·ªÄN) ---
    document.getElementById("modal-quote-form").onsubmit = function (e) {
        e.preventDefault();

        var code = dxQuoteCode ? (dxQuoteCode.option("value") || '''').toString().trim() : '''';
        var dateValue = dxQuoteDate ? dxQuoteDate.option("value") : null;
        var date = dateValue ? (dateValue instanceof Date ? dateValue.toISOString().split(''T'')[0] : dateValue) : '''';
        var customer = dxQuoteCustomer ? (dxQuoteCustomer.option("value") || '''').toString().trim() : '''';

        var contactPerson = '''';
        var contactId = '''';
        if (dxQuoteContactPerson) {
            var selectedValue = dxQuoteContactPerson.option("value");
            if (selectedValue) {
                var selectedItem = dxQuoteContactPerson.option("dataSource").find(function (item) {
                    return item.value === selectedValue;
                });
                contactPerson = selectedItem ? (selectedItem.text || '''').toString().trim() : '''';
                contactId = selectedValue;
            }
        }

        var phone = dxQuotePhone ? (dxQuotePhone.option("value") || '''').toString().trim() : '''';
        var email = dxQuoteEmail ? (dxQuoteEmail.option("value") || '''').toString().trim() : '''';
        var address = dxQuoteAddress ? (dxQuoteAddress.option("value") || '''').toString().trim() : '''';
        var notes = dxQuoteNotes ? (dxQuoteNotes.option("value") || '''').toString().trim() : '''';

        // L·∫•y ng∆∞·ªùi t·∫°o (EmployeeID) - PH·∫¢I L√Ä STRING (NVARCHAR)
        var creatorEmployeeID = dxQuoteCreator ? (dxQuoteCreator.option("value") || '''').toString() : currentEmployeeID;

        if (!creatorEmployeeID) {
            console.error(''‚ùå Kh√¥ng c√≥ EmployeeID!'');
            console.error(''  ‚Üí dxQuoteCreator:'', dxQuoteCreator);
            console.error(''  ‚Üí creatorEmployeeID:'', creatorEmployeeID);
            console.error(''  ‚Üí currentEmployeeID:'', currentEmployeeID);

            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "warning", message: "%PleaseSelectCreator%" });
            }
            return;
        }

        if (!contactId || contactId === '''' || contactId === ''__legacy__'') {
            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "warning", message: "%PleaseSelectContactPerson%" });
            }
            return;
        }


        // Get items t·ª´ b·∫£ng ph√¢n h·ªá
        var items = [];

        // L·∫•y items t·ª´ b·∫£ng ph√¢n h·ªá
        var subsystemRows = document.querySelectorAll("#subsystem-items-tbody tr");
        subsystemRows.forEach((row, idx) => {
            var productSelect = row.querySelector(".item-product");
            var productId = productSelect.value;
            var productName = productSelect.options[productSelect.selectedIndex].text;

            if (productId) {
                var licensePriceInput = row.querySelector(".item-license-price");
                var customizePriceInput = row.querySelector(".item-customize-price");

                var licensePrice = licensePriceInput ? getItemPriceValue(licensePriceInput) : 0;
                var customizePrice = customizePriceInput ? getItemPriceValue(customizePriceInput) : 0;

                // T·ªïng gi√° = Ph√≠ b·∫£n quy·ªÅn + Ph√≠ tri·ªÉn khai
                var totalPrice = licensePrice + customizePrice;

                var subsystemItem = {
                    ProductID: productId,
                    ProductName: productName,
                UnitPrice: totalPrice, // T·ªïng gi√° ƒë·ªÉ t√≠nh TotalAmount
                    LicensePrice: licensePrice, // Ph√≠ b·∫£n quy·ªÅn
                    CustomizePrice: customizePrice, // Ph√≠ tri·ªÉn khai
                    Quantity: 1,
                    Discount: 0,
                    ItemType: ''Subsystem'' // ‚úÖ Ph√¢n lo·∫°i: Ph√¢n h·ªá
                };
                items.push(subsystemItem);
            }
        });

        if (items.length === 0) {
            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "warning", message: "%PleaseAddAtLeastOneProduct%" });
            }
            return;
        }

        // ‚úÖ G·ªçi calculateTotal() tr∆∞·ªõc ƒë·ªÉ ƒë·∫£m b·∫£o gi√° ƒë∆∞·ª£c t√≠nh ch√≠nh x√°c v√† hi·ªÉn th·ªã ƒë√∫ng trong UI
        calculateTotal();

        // ‚úÖ L·∫•y totalAmount t·ª´ grand-total element (ƒë√£ ƒë∆∞·ª£c format, c·∫ßn parse l·∫°i)
        var grandTotalText = document.getElementById("grand-total").textContent;
        var totalAmount = parseFloat(grandTotalText.replace(/[^\d]/g, '''')) || 0;


        // ‚úÖ KI·ªÇM TRA LOGINID TR∆Ø·ªöC KHI L∆ØU
        if (!currentLoginID) {
            console.error(''‚ùå KH√îNG TH·ªÇ L∆ØU - THI·∫æU LOGINID!'');
            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "error", message: "%LoginIDNotFound%" });
            }
            return;
        }

        var spName = editingId ? "sp_Sub_Quotation_Update" : "sp_Sub_Quotation_Insert";

        var params = [
            "QuoteCode", code,
            "QuoteDate", date,
            "CustomerName", customer,
            "CustomerPhone", phone,
            "CustomerEmail", email,
            "CustomerAddress", address,
            "TotalAmount", totalAmount,
  "Notes", notes,
            "Status", "draft",              // ‚úÖ G·ª¨I STATUS (m·∫∑c ƒë·ªãnh l√† ''draft'' v√¨ ƒë√£ x√≥a kh·ªèi UI)
            "ContactPerson", contactPerson, // ‚úÖ G·ª¨I ContactPerson
            "LoginID", currentLoginID,        // ‚úÖ G·ª¨I LOGINID
            "EmployeeID", creatorEmployeeID   // ‚úÖ G·ª¨I EMPLOYEEID (STRING)
        ];

        if (editingId) params = ["QuoteID", editingId, ...params];


        AjaxHPAParadise({
            data: { name: spName, param: params },
            success: function (res) {
                try {

                    var parsed = JSON.parse(res);
                    var resultData = parsed.data;
                    if (Array.isArray(resultData) && resultData.length > 0 && Array.isArray(resultData[0])) {
                        resultData = resultData[0];
                    }

                    // ‚úÖ Ki·ªÉm tra ERROR tr∆∞·ªõc
                    if (resultData && resultData[0] && resultData[0].Result === ''ERROR'') {
                        console.error(''‚ùå Stored procedure tr·∫£ v·ªÅ ERROR:'', resultData[0].Message);
                        if (typeof uiManager !== ''undefined'') {
                            uiManager.showAlert({ type: "error", message: resultData[0].Message });
                        }
                        return;
                    }

                    // ‚úÖ L·∫•y QuoteID: n·∫øu l√† Update th√¨ d√πng editingId, n·∫øu l√† Insert th√¨ l·∫•y t·ª´ response
                    var finalQuoteID = editingId;
                    if (!editingId) {
                        // Insert mode: L·∫•y QuoteID t·ª´ response
                        if (resultData && resultData[0] && resultData[0].QuoteID) {
                            finalQuoteID = resultData[0].QuoteID;
                        } else {
                            console.error(''‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c QuoteID m·ªõi t·ª´ Insert response'');
                            console.error(''Response data:'', resultData);
                            if (typeof uiManager !== ''undefined'') {
                                uiManager.showAlert({ type: "error", message: "L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c ID b√°o gi√° m·ªõi!" });
                            }
                            return;
                       }
                 }

                    // ‚úÖ L∆∞u items v√†o b·∫£ng ri√™ng (n·∫øu c√≥ QuoteID)
                    if (finalQuoteID && items.length > 0) {
                        // N·∫øu l√† Update, x√≥a items c≈© tr∆∞·ªõc
                        if (editingId) {
                            deleteAllQuoteItems(finalQuoteID, function () {
                                saveQuoteItems(finalQuoteID, items, function (success) {
                                    document.getElementById("modal-quote").classList.remove("show");
                                    if (success) {
                                        if (typeof uiManager !== ''undefined'') {
                                            uiManager.showAlert({ type: "success", message: "%QuotationUpdatedSuccess%" });
                                        }
                                    } else {
                                        if (typeof uiManager !== ''undefined'') {
                                            uiManager.showAlert({ type: "error", message: "%Debt_SystemError%" });
                                        }
                                    }
                                    loadData();
                                });
                            });
                        } else {
                            // Insert mode: Ch·ªâ c·∫ßn insert items m·ªõi
                            saveQuoteItems(finalQuoteID, items, function (success) {
                                document.getElementById("modal-quote").classList.remove("show");
                                if (success) {
                                    if (typeof uiManager !== ''undefined'') {
                                        uiManager.showAlert({ type: "success", message: "ƒê√£ l∆∞u b√°o gi√° v√† items th√†nh c√¥ng!" });
                                    }
                                } else {
        if (typeof uiManager !== ''undefined'') {
                                        uiManager.showAlert({ type: "error", message: "ƒê√£ l∆∞u b√°o gi√° nh∆∞ng l·ªói khi l∆∞u items!" });
                                    }
                                }
                                loadData();
                            });
                        }
                    } else {
                        document.getElementById("modal-quote").classList.remove("show");
                        if (typeof uiManager !== ''undefined'') {
                            uiManager.showAlert({ type: "success", message: "%QuotationSavedSuccess%" });
                        }
                        loadData();
                    }
                } catch (e) {
                    console.error(''‚ùå L·ªói x·ª≠ l√Ω response:'', e);
                    document.getElementById("modal-quote").classList.remove("show");
                    if (typeof uiManager !== ''undefined'') {
                        uiManager.showAlert({ type: "error", message: "L·ªói x·ª≠ l√Ω d·ªØ li·ªáu!" });
                    }
                    loadData();
                }
            },
            error: function (err) {
                console.error(''‚ùå L·ªói l∆∞u b√°o gi√°:'', err);
                if (typeof uiManager !== ''undefined'') {
                    uiManager.showAlert({ type: "error", message: "%Debt_SystemError%" });
                }
            }
        });
    };

    // --- EXPORT ACTION QUICK (KH√îNG C·∫¶N M·ªû MODAL) ---
    async function exportQuotationDataQuick(quoteID) {
        if (!quoteID) {
            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "warning", message: "Kh√¥ng t√¨m th·∫•y b√°o gi√° ƒë·ªÉ xu·∫•t!" });
            }
            return;
        }

        if (typeof showLoadingByClassOrID === ''function'') {
            showLoadingByClassOrID("#sp_quotation_manager", "%ExportData%");
      }

        let exportItem = {
            name: "Xu·∫•t b√°o gi√°",
            text: "Xu·∫•t b√°o gi√°",
            item: "ExportQuoteExcel",
            query: "sp_Sub_ExportQuote_Excel",
            fileName: "exportExcelQuote.xlsx",
        };

        let ExportName = exportItem.item;

        try {
            // N·∫øu kh√¥ng c√≥ fileName, l·∫•y t·ª´ server
            if (!exportItem.fileName) {
                let exportTemp = await AjaxHPAParadiseAsync({
                    data: {
                        name: exportItem.item,
                        param: ["QuoteID", quoteID],
                    },
                    success: function (resultData) { },
                });

                exportTemp = typeof exportTemp === "string" ? JSON.parse(exportTemp) : exportTemp;

                if (exportTemp.data && exportTemp.data[0] && exportTemp.data[0][0]) {
                    ExportName = exportTemp.data[0][0][
                        Object.keys(exportTemp.data[0][0]).find(
                            (x) => x.toLowerCase() == "exportname"
                        )
                    ] ?? ExportName;
                }
            }

            // G·ªçi stored procedure export
            let resultData = await AjaxHPAParadiseParadiseAsync({
                data: {
                    name: "ExportLocationFolder",
                    param: [
                        "",
                        ExportName,
                        exportItem.fileName,
                        "@QuoteID",
                        quoteID,
                    ],
                },
                success: function (resultData) { },
                error: function (xhr, status, error) { },
            });

            let jsonData = typeof resultData === "string" ? JSON.parse(resultData) : resultData;

            if (jsonData.result == "error")
                throw new Error(jsonData.reason ?? "L·ªói b·∫•t th∆∞·ªùng");

            if (jsonData) {
if (jsonData.result == "error") throw new Error(jsonData.reason ?? "L·ªói b·∫•t th∆∞·ªùng");
                // Parse jsonData.data n·∫øu n√≥ l√† string JSON
                let fileInfo = null;
                if (jsonData.data) {
                    if (typeof jsonData.data === "string") {
                        try {
                            fileInfo = JSON.parse(jsonData.data);
                        } catch (e) {
                            console.error("L·ªói parse jsonData.data:", e);
                            fileInfo = { FilePath: jsonData.data, FileName: exportItem.fileName };
                        }
                    } else {
                        fileInfo = jsonData.data;
                    }
                } else {
                    // Fallback: d√πng tr·ª±c ti·∫øp jsonData n·∫øu kh√¥ng c√≥ data
                    fileInfo = jsonData;
                }

                // L·∫•y FilePath v√† FileName
                const filePath = fileInfo.FilePath || fileInfo.filePath || jsonData.FilePath;
                const fileName = fileInfo.FileName || fileInfo.fileName || exportItem.fileName;

                console.log("üöÄ ~ filePath:", filePath);
                console.log("üöÄ ~ fileName:", fileName);
                if (ParadiseOption && ParadiseOption.AppInfoPackageName && ParadiseOption.AppInfoPackageName.includes("com.vietinsoft.onshift")) {
                    await AjaxHPAParadiseParadiseAsync({
                        data: {
                            name: "MobileOpenFileAsync",
                            param: [filePath, fileName]
                        }
                    })
                } else {
                    let result = await AjaxHPAParadiseParadiseAsync({
                        data: {
                            name: "ReadPathFileToByte",
                            param: [filePath]
                        }
                    })
                    resultData = typeof result === "string" ? JSON.parse(result) : result;
                    if (ParadiseOption && ParadiseOption.AppInfoPackageName && ParadiseOption.AppInfoPackageName.includes("com.vietinsoft.paradisehr"))
                        await apimobileAjaxAsync({}, { "MethodName": "MobileOpenFileAsync", "prs": [resultData.data, fileName], })
                    else
                        saveAsFile(fileName, resultData.data);
                }
            }

            if (typeof HideLoadingByClassOrID === ''function'') {
                HideLoadingByClassOrID("#sp_quotation_manager");
            }
        } catch (error) {
            if (typeof HideLoadingByClassOrID === ''function'') {
                HideLoadingByClassOrID("#sp_quotation_manager");
            }

            let direction = "up-push";
            let position = "bottom right";

            let message = error.message || "%ExportQuotationError%";

            if (typeof DevExpress !== ''undefined'' && DevExpress.ui && DevExpress.ui.notify) {
                DevExpress.ui.notify(
                    {
                        message: message,
                        type: "error",
                        displayTime: 2500,
                    },
                    {
                        position,
                        direction,
                    }
                );
            } else if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "error", message: message });
            } else {
                alert(message);
            }
        }
    }


    // --- EXPORT ACTION (T·ª™ MODAL) ---
    async function exportQuotationData() {
        if (!editingId) {
            if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "warning", message: "%PleaseSaveBeforeExport%" });
            }
            return;
        }

        if (typeof showLoadingByClassOrID === ''function'') {
            showLoadingByClassOrID("#sp_quotation_manager", "Xu·∫•t d·ªØ li·ªáu");
        }

        let exportItem = {
            name: "Xu·∫•t b√°o gi√°",
            text: "Xu·∫•t b√°o gi√°",
            item: "ExportQuoteExcel",
            query: "sp_Sub_ExportQuote_Excel",
            fileName: "exportExcelQuote.xlsx",
        };

        let ExportName = exportItem.item;

        try {
            // N·∫øu kh√¥ng c√≥ fileName, l·∫•y t·ª´ server
            if (!exportItem.fileName) {
                let exportTemp = await AjaxHPAParadiseAsync({
                    data: {
                        name: exportItem.item,
                        param: ["QuoteID", editingId],
                    },
                    success: function (resultData) { },
                });

                exportTemp = typeof exportTemp === "string" ? JSON.parse(exportTemp) : exportTemp;

                if (exportTemp.data && exportTemp.data[0] && exportTemp.data[0][0]) {
                    ExportName = exportTemp.data[0][0][
                        Object.keys(exportTemp.data[0][0]).find(
                            (x) => x.toLowerCase() == "exportname"
                        )
                    ] ?? ExportName;
                }
            }

            // G·ªçi stored procedure export
            let resultData = await AjaxHPAParadiseParadiseAsync({
                data: {
                    name: "ExportLocationFolder",
                    param: [
                        "",
                        ExportName,
                        exportItem.fileName,
                        "@QuoteID",
                        editingId,
                    ],

                },
                success: function (resultData) { },
                error: function (xhr, status, error) { },
            });

            let jsonData = typeof resultData === "string" ? JSON.parse(resultData) : resultData;

            if (jsonData) {
                if (jsonData.result == "error") throw new Error(jsonData.reason ?? "L·ªói b·∫•t th∆∞·ªùng");
                // Parse jsonData.data n·∫øu n√≥ l√† string JSON
                let fileInfo = null;
                if (jsonData.data) {
                    if (typeof jsonData.data === "string") {
                        try {
                            fileInfo = JSON.parse(jsonData.data);
                        } catch (e) {
                            console.error("L·ªói parse jsonData.data:", e);
                            fileInfo = { FilePath: jsonData.data, FileName: exportItem.fileName };
                        }
                    } else {
                        fileInfo = jsonData.data;
                    }
                } else {
                    // Fallback: d√πng tr·ª±c ti·∫øp jsonData n·∫øu kh√¥ng c√≥ data
                    fileInfo = jsonData;
                }

                // L·∫•y FilePath v√† FileName
                const filePath = fileInfo.FilePath || fileInfo.filePath || jsonData.FilePath;
                const fileName = fileInfo.FileName || fileInfo.fileName || exportItem.fileName;

                console.log("üöÄ ~ filePath:", filePath);
                console.log("üöÄ ~ fileName:", fileName);
                if (ParadiseOption && ParadiseOption.AppInfoPackageName && ParadiseOption.AppInfoPackageName.includes("com.vietinsoft.onshift")) {
                    await AjaxHPAParadiseParadiseAsync({
                        data: {
                            name: "MobileOpenFileAsync",
                            param: [filePath, fileName]
                        }
                    })
                } else {
                    let result = await AjaxHPAParadiseParadiseAsync({
                        data: {
                            name: "ReadPathFileToByte",
                            param: [filePath]
                        }
                    })
                    resultData = typeof result === "string" ? JSON.parse(result) : result;
                    if (ParadiseOption && ParadiseOption.AppInfoPackageName && ParadiseOption.AppInfoPackageName.includes("com.vietinsoft.paradisehr"))
                        await apimobileAjaxAsync({}, { "MethodName": "MobileOpenFileAsync", "prs": [resultData.data, fileName], })
                    else
                        saveAsFile(fileName, resultData.data);
                }
            }

            if (typeof HideLoadingByClassOrID === ''function'') {
                HideLoadingByClassOrID("#sp_quotation_manager");
            }
        } catch (error) {
            if (typeof HideLoadingByClassOrID === ''function'') {
                HideLoadingByClassOrID("#sp_quotation_manager");
            }

            let direction = "up-push";
            let position = "bottom right";

            let message = error.message || "L·ªói khi xu·∫•t b√°o gi√°";

            if (typeof DevExpress !== ''undefined'' && DevExpress.ui && DevExpress.ui.notify) {
                DevExpress.ui.notify(
                    {
                        message: message,
                        type: "error",
                        displayTime: 2500,
                    },
                    {
                        position,
                        direction,
                    }
                );
            } else if (typeof uiManager !== ''undefined'') {
                uiManager.showAlert({ type: "error", message: message });
            } else {
                alert(message);
            }
        }
    }

    // --- EXPORT ACTION (T·ª™ MODAL) ---
    if (dxQuoteExport) {
        dxQuoteExport.option("onClick", function () {
            exportQuotationData();
        });
    } else {
        document.getElementById("modal-quote-export").onclick = function () {
            exportQuotationData();
        };
    }

    // --- DELETE ACTION (C√ì PH√ÇN QUY·ªÄN) ---
    var deleteHandler = function () {
        if (!editingId) return;

        showConfirmPopup({
            title: "%DeleteQuotationConfirm%",
            message: "%DeleteQuotationConfirmMessage%",
            icon: "bi bi-trash",
            YesText: "%Common_Delete%",
            NoText: "%btnFWCancel%",
            onYes: function () {
                document.getElementById("modal-quote").classList.remove("show");
                AjaxHPAParadise({
                    data: {
                        name: "sp_Sub_Quotation_Delete",
                        param: ["QuoteID", editingId, "LoginID", currentLoginID] // ‚úÖ G·ª¨I LOGINID
                    },
                    success: function (res) {
                        try {
                            var parsed = JSON.parse(res);
                            if (parsed.data && parsed.data[0] && parsed.data[0][0]) {
                                var result = parsed.data[0][0];
                                if (result.Result === ''ERROR'') {
                                    if (typeof uiManager !== ''undefined'') {
                                        uiManager.showAlert({ type: "error", message: result.Message });
                                    }
                                    return;
                                }
                            }
                        } catch (e) {
                            console.error(e);
                        }

                        if (typeof uiManager !== ''undefined'') {
                            uiManager.showAlert({ type: "success", message: "%QuotationDeletedSuccess%" });
                        }
                        loadData();
                    }
                });
            }
        });

    };

    // G√°n delete handler v√†o DevExtreme button
    if (dxQuoteDelete) {
        dxQuoteDelete.option("onClick", deleteHandler);
    } else {
        document.getElementById("modal-quote-delete").onclick = deleteHandler;
    }

    // --- INITIALIZE (C√ì PH√ÇN QUY·ªÄN) ---

    // B∆∞·ªõc 1: Load th√¥ng tin user v√† nh√¢n vi√™n tr∆∞·ªõc
    loadCurrentUserInfo(function () {
        // B∆∞·ªõc 2: Sau khi c√≥ th√¥ng tin user, load d·ªØ li·ªáu b√°o gi√°
        loadData();
    });

    // ‚úÖ FALLBACK: ƒê·∫£m b·∫£o loadData() ƒë∆∞·ª£c g·ªçi sau 2 gi√¢y n·∫øu callback kh√¥ng ƒë∆∞·ª£c g·ªçi
    setTimeout(function () {
        if (quotes.length === 0 && currentLoginID) {
            console.warn(''‚ö†Ô∏è Fallback: G·ªçi loadData() v√¨ ch∆∞a c√≥ data...'');
            loadData();
        }
    }, 2000);

    if (typeof HideLoadingByClassOrID === ''function'') HideLoadingByClassOrID("#sp_Sub_SubQuotation_manager");

    if (["Android", "iOS"].includes(getMobileOperatingSystem())) {
        var header = document.getElementById("header_sp_Sub_SubQuotation_manager");
        if (header && !header.querySelector(".back-btn.m-0")) {
            var newButton = document.createElement("button");
            newButton.className = "back-btn m-0";
            newButton.innerHTML = `<i class="fas fa-plus"></i>`;
            newButton.onclick = function () { openEditModal(null); };
            header.appendChild(newButton);
        }
    }


    }) ();
</script>
'
 SELECT @html as html
 -- exec sp_GenerateHTMLScript_new 'sp_Sub_SubQuotation_manager_html'
END
GO

EXEC sptblCommonControlType_Signed 'sp_Sub_SubQuotation_manager_html'
EXEC sp_GenerateHTMLScript_new 'sp_Sub_SubQuotation_manager_html'
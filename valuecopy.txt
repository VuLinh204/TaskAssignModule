
    <div id="sp_Task_MyWork_html">
        <div id="gridMyWork" style="height: 100%;"></div><div id="gridSubtaskAssign" style="height: 100%;"></div><div id="P777C87EE29F94C29A6EAABD16E31FDDC"></div><div id="P2920410F91DB42948640CF1ABBDEE649"></div><div id="PC98E2DFA331343BBAE22882BE3825C1A"></div><div id="P02E6F18645BA47648567B32773A1B7B4"></div><div id="P27C40759D9C94453AB9B2DFBCD661AE3"></div>
    </div>
    <script>
        (() => {
   let DataSource = []
            
            // Load DataSource: EmployeeListAll_DataSetting_Custom
            if ("EmployeeListAll_DataSetting_Custom" && "EmployeeListAll_DataSetting_Custom".trim() !== "") {
                loadDataSourceCommon("AssignedEmployeeIDs", "EmployeeListAll_DataSetting_Custom", function(data) {
                    // Data được shared qua callback
                });
            }
        
            // Load DataSource: sp_Task_GetAssignmentSetup
            if ("sp_Task_GetAssignmentSetup" && "sp_Task_GetAssignmentSetup".trim() !== "") {
                loadDataSourceCommon("TaskName", "sp_Task_GetAssignmentSetup", function(data) {
                    // Data được shared qua callback
                });
            }
        
        function loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback) {
            if (!columnName || !dataSourceSP || dataSourceSP.trim() === "") {
                console.warn("[loadDataSourceCommon] Missing columnName or dataSourceSP");
                return;
            }

            const dataSourceKey = "DataSource_" + columnName;
            // Sử dụng format: columnNameDataSourceLoaded để tương thích với code hiện tại
            const loadedKey = columnName + "DataSourceLoaded";

            // Kiểm tra nếu đã load rồi thì không load lại
            if (window[loadedKey] === true) {
                if (typeof onSuccessCallback === "function") {
                    onSuccessCallback(window[dataSourceKey] || []);
                }
                return;
            }

            // Kiểm tra nếu đang load thì đợi
            if (window[loadedKey] === "loading") {
                // Đợi một chút rồi thử lại
                setTimeout(function() {
                    loadDataSourceCommon(columnName, dataSourceSP, onSuccessCallback);
                }, 100);
                return;
            }

            // Đánh dấu đang load để tránh load trùng lặp
            window[loadedKey] = "loading";

            AjaxHPAParadise({
                data: {
                    name: dataSourceSP,
                    param: ["LoginID", LoginID, "LanguageID", LanguageID]
                },
                success: function(res) {
                    const json = typeof res === "string" ? JSON.parse(res) : res;
                    window[dataSourceKey] = (json.data && json.data[0]) || [];
                    window[loadedKey] = true;

                    // Gọi callback nếu có
                    if (typeof onSuccessCallback === "function") {
                        onSuccessCallback(window[dataSourceKey]);
                    }

                    // Tự động cập nhật control nếu có method setDataSource hoặc option
                    // Thử nhiều format tên instance để tương thích
                    const instanceVariants = [
                        "Instance" + columnName.charAt(0).toUpperCase() + columnName.slice(1) + "PDB2DB35885F14803A9A52961A7871972",
                        "Instance" + columnName + "PDB2DB35885F14803A9A52961A7871972",
                        "instance" + columnName.charAt(0).toUpperCase() + columnName.slice(1) + "PDB2DB35885F14803A9A52961A7871972"
                    ];

                    for (let i = 0; i < instanceVariants.length; i++) {
                        const instanceKey = instanceVariants[i];
                        if (window[instanceKey]) {
                            const instanceObj = window[instanceKey];

                            // Kiểm tra nếu đây là dxDataGrid
                            if (typeof instanceObj.dxDataGrid === "function" || instanceObj.option && instanceObj.option("dataSource") !== undefined) {
                                try {
                                    // Nếu là Grid, apply dynamic config
                                    const gridConfigFn = window["getGridConfig_" + columnName.charAt(0).toUpperCase() + columnName.slice(1)];
                                    if (typeof gridConfigFn === "function") {
                                        const gridConfig = gridConfigFn(window[dataSourceKey]);
                                        instanceObj.option("remoteOperations", gridConfig.remoteOperations);
                                        instanceObj.option("paging.pageSize", gridConfig.pageSize);
                                        instanceObj.option("pager.allowedPageSizes", gridConfig.allowedPageSizes);
                                    }

                                    instanceObj.option("dataSource", window[dataSourceKey]);
                                    break;
                                } catch(e) {
                                    console.warn("[LoadDataSourceCommon] Grid config error:", e);
                                    // Fallback: just set data source
                                    instanceObj.option("dataSource", window[dataSourceKey]);
                       break;
                                }
                            } else if (typeof instanceObj.setDataSource === "function") {
                                instanceObj.setDataSource(window[dataSourceKey]);
                                break;
                            } else if (typeof instanceObj.option === "function") {
                                try {
                                    instanceObj.option("dataSource", window[dataSourceKey]);
                                    break;
                                } catch(e) {
                                    // Continue to next variant
                                }
                            }
                        }
                    }
                },
                error: function(err) {
                    console.error("[loadDataSourceCommon] Failed to load datasource for", columnName, ":", err);
                    window[loadedKey] = false;
                    if (typeof onSuccessCallback === "function") {
                        onSuccessCallback([]);
                    }
                }
            });
        }
    
            '
        +(select loadUI from tblCommonControlType_Signed where UID = 'PDB2DB35885F14803A9A52961A7871972')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P870C076FA1FD48DDBDEDE2C2435B4DA9')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P777C87EE29F94C29A6EAABD16E31FDDC')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P2920410F91DB42948640CF1ABBDEE649')
        +(select loadUI from tblCommonControlType_Signed where UID = 'PC98E2DFA331343BBAE22882BE3825C1A')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P02E6F18645BA47648567B32773A1B7B4')
        +(select loadUI from tblCommonControlType_Signed where UID = 'P27C40759D9C94453AB9B2DFBCD661AE3') +N'
             window.currentRecordID_HeaderID = null; window.currentRecordID_HistoryID = null; window.currentRecordID_TaskID = null;
            
        // =============== GRID COLUMN CONFIG PERSISTENCE ===============
        function saveGridColumnConfig(tableName, columns) {
            const visibleColumns = columns
                .filter(col => {
                    return col.visible !== false
                        && col.dataField
                        && col.dataField !== "rowIndex"
                        && typeof col.dataField === "string";
                })
                .map(col => col.dataField);

            const columnOrder = columns
                .filter(col => {
                    return col.dataField
                        && col.dataField !== "rowIndex"
                        && typeof col.dataField === "string";
                })
                .map(col => col.dataField);

            const config = { visibleColumns, columnOrder };
            console.log("[SaveConfig]", config);

            AjaxHPAParadise({
                data: {
                    name: "sp_SaveGridColumnConfig",
                    param: [
                        "LoginID", LoginID,
                        "TableName", tableName,
                        "ColumnConfigJson", JSON.stringify(config)
                    ]
                }
            });
        }

        function loadGridColumnConfig(tableName, callback) {
            AjaxHPAParadise({
                data: {
                    name: "sp_GetGridColumnConfig",
                    param: ["LoginID", LoginID, "TableName", tableName]
                },
                async: false,
                success: function(res) {
                    let config = {};
                    const json = typeof res === "string" ? JSON.parse(res) : res;
                    if (json && json.data && json.data[0] && json.data[0][0] && json.data[0][0].ColumnConfigJson) {
                        const raw = json.data[0][0].ColumnConfigJson;
                        config = typeof raw === "string" ? JSON.parse(raw) : raw;
                    }
                    if (typeof callback === "function") callback(config);
                }
            });
        }

        // =============== FILTER STATE - LOCALSTORAGE ONLY ===============
        function saveGridFilterState(tableName, gridInstance) {
            try {
                const filterValue = gridInstance.getCombinedFilter();
                const searchValue = gridInstance.option("searchPanel.text") || "";
                
                // Lấy filter của từng cột
                const columnFilters = {};
                const columns = gridInstance.option("columns");
                
                columns.forEach(col => {
                    if (col.dataField && col.filterValue !== undefined) {
                        columnFilters[col.dataField] = {
                            filterValue: col.filterValue,
                            filterType: col.filterType || "include",
                            selectedFilterOperation: col.selectedFilterOperation
                        };
                    }
                });
                
                const filterState = {
                    combinedFilter: filterValue,
                    searchText: searchValue,
                    columnFilters: columnFilters,
                    timestamp: new Date().getTime()
                };
                
                console.log("[SaveFilterState]", filterState);
                
                // CHỈ LƯU VÀO LOCALSTORAGE
                localStorage.setItem("GridFilter_" + tableName + "_" + LoginID, JSON.stringify(filterState));
            } catch(e) {
                console.error("[SaveFilterState] Error:", e);
            }
        }

        function loadGridFilterState(tableName, gridInstance) {
            try {
                const storageKey = "GridFilter_" + tableName + "_" + LoginID;
                const savedState = localStorage.getItem(storageKey);
                
                if (!savedState) {
                    console.log("[LoadFilterState] No saved filter");
                    return null;
                }
                
                const filterState = JSON.parse(savedState);
                console.log("[LoadFilterState] Loaded:", filterState);
                
                return filterState;
            } catch(e) {
                console.error("[LoadFilterState] Error:", e);
                return null;
            }
        }

        function applyGridFilterState(gridInstance, filterState) {
            if (!filterState) return;
            
            try {
                gridInstance.beginUpdate();
                
                // 1. Apply search text
                if (filterState.searchText) {
                    gridInstance.option("searchPanel.text", filterState.searchText);
                }
                
                // 2. Apply column filters
                if (filterState.columnFilters) {
                    Object.keys(filterState.columnFilters).forEach(dataField => {
                        const colFilter = filterState.columnFilters[dataField];
                        const colIndex = gridInstance.columnOption(dataField, "index");
                        
                        if (colIndex !== undefined) {
                            gridInstance.columnOption(dataField, "filterValue", colFilter.filterValue);
                            if (colFilter.filterType) {
                                gridInstance.columnOption(dataField, "filterType", colFilter.filterType);
                            }
                            if (colFilter.selectedFilterOperation) {
                                gridInstance.columnOption(dataField, "selectedFilterOperation", colFilter.selectedFilterOperation);
                            }
                        }
                    });
                }
                
                // 3. Apply combined filter (fallback)
                if (filterState.combinedFilter && !filterState.columnFilters) {
                    gridInstance.option("filterValue", filterState.combinedFilter);
                }
                
                gridInstance.endUpdate();
                
                console.log("[ApplyFilterState] Filter applied successfully");
            } catch(e) {
                console.error("[ApplyFilterState] Error:", e);
            }
        }

        function clearGridFilterState(tableName) {
            try {
                const storageKey = "GridFilter_" + tableName + "_" + LoginID;
                localStorage.removeItem(storageKey);
                console.log("[ClearFilterState] Cleared filter for", tableName);
            } catch(e) {
                console.error("[ClearFilterState] Error:", e);
            }
        }

        // =============== ROW ORDER PERSISTENCE ===============
        function saveGridRowOrder(gridInstance, tableName, pkColumn) {
            const dataSource = gridInstance.option("dataSource");
            const rowOrderArray = dataSource.map(item => item[pkColumn]);

            AjaxHPAParadise({
                data: {
                    name: "sp_SaveGridRowOrder",
                    param: [
                        "LoginID", LoginID,
                        "TableName", tableName,
                        "RowOrderJson", JSON.stringify(rowOrderArray)
                    ]
                },
                success: function(res) {
                    console.log("[SaveRowOrder] Success");
                },
                error: function(err) {
                    console.error("[SaveRowOrder] Error:", err);
                }
            });
        }

        function loadGridRowOrder(tableName, dataSource, pkColumn, callback) {
            AjaxHPAParadise({
                data: {
                    name: "sp_GetGridRowOrder",
                    param: ["LoginID", LoginID, "TableName", tableName]
                },
                async: false,
                success: function(res) {
                    try {
                        const json = typeof res === "string" ? JSON.parse(res) : res;
                        const rowOrderJson = json.data[0][0].RowOrderJson;

                        if (rowOrderJson && rowOrderJson !== "[]") {
                            const savedOrder = JSON.parse(rowOrderJson);
                            console.log("[LoadRowOrder] Loaded saved order:", savedOrder);

                            const dataMap = {};
                            dataSource.forEach(item => {
                                dataMap[item[pkColumn]] = item;
                            });

                            const sortedData = [];
                            savedOrder.forEach(id => {
                                if (dataMap[id]) {
                                    sortedData.push(dataMap[id]);
                                    delete dataMap[id];
                                }
                            });

                            Object.values(dataMap).forEach(item => {
                                sortedData.push(item);
                            });

                            console.log("[LoadRowOrder] Sorted data:", sortedData.length, "rows");

                            if (typeof callback === "function") {
                                callback(sortedData);
                            }
                        } else {
                            console.log("[LoadRowOrder] No saved order");
                            if (typeof callback === "function") {
                                callback(dataSource);
                            }
                        }
                    } catch (e) {
                        if (typeof callback === "function") {
                            callback(dataSource);
                        }
                    }
                },
                error: function(err) {
                    console.error("[LoadRowOrder] Error:", err);
                    if (typeof callback === "function") {
                        callback(dataSource);
                    }
                }
            });
        }
    

            function ReloadData() {
                AjaxHPAParadise({
                    data: {
                        name: "sp_Task_GetMyTasks",
                        param: []
                    },
                    success: function (res) {
                        const json = typeof res === "string" ? JSON.parse(res) : res;
                        const results = Array.isArray(json?.data?.[0])
                            ? json.data[0]
                            : (json?.data?.[0] ? [json.data[0]] : []);

                        const obj = results.length === 1 ? results[0] : (results[0] || null);

                        
                const gridInstancegridMyWork = InstancegridMyWorkPDB2DB35885F14803A9A52961A7871972;
                const gridConfiggridMyWork = window.getGridConfig_gridMyWork(results);
                
                loadGridRowOrder(
                    "sp_Task_MyWork_html",
                    results,
                    "TaskID",
                    function(sortedData) {
                        gridInstancegridMyWork.beginUpdate();
                        gridInstancegridMyWork.option("scrolling", {
                            mode: "standard",
                            showScrollbar: "onHover"
                        });
                        gridInstancegridMyWork.option("remoteOperations", false);
                        gridInstancegridMyWork.option("paging.enabled", true);
                        gridInstancegridMyWork.option("paging.pageSize", gridConfiggridMyWork.pageSize);
                        gridInstancegridMyWork.option("pager.allowedPageSizes", gridConfiggridMyWork.allowedPageSizes);
                        gridInstancegridMyWork.pageIndex(0);
                        gridInstancegridMyWork.option("dataSource", sortedData);
                        gridInstancegridMyWork.endUpdate();
                        
                        // RESTORE FILTER STATE T? LOCALSTORAGE
                        setTimeout(function() {
                            const savedFilter = loadGridFilterState("sp_Task_MyWork_html", gridInstancegridMyWork);
                            if (savedFilter) {
                                console.log("[ReloadData] Restoring filter:", savedFilter);
                                applyGridFilterState(gridInstancegridMyWork, savedFilter);
                            } else {
                                console.log("[ReloadData] No filter to restore");
                            }
                        }, 100);
                    }
                );
            
                const gridInstancegridSubtaskAssign = InstancegridSubtaskAssignP870C076FA1FD48DDBDEDE2C2435B4DA9;
                const gridConfiggridSubtaskAssign = window.getGridConfig_gridSubtaskAssign(results);
                
                loadGridRowOrder(
                    "sp_Task_MyWork_html",
                    results,
                    "TaskID",
                    function(sortedData) {
                        gridInstancegridSubtaskAssign.beginUpdate();
                        gridInstancegridSubtaskAssign.option("scrolling", {
                            mode: "standard",
                            showScrollbar: "onHover"
                        });
                        gridInstancegridSubtaskAssign.option("remoteOperations", false);
                        gridInstancegridSubtaskAssign.option("paging.enabled", true);
                        gridInstancegridSubtaskAssign.option("paging.pageSize", gridConfiggridSubtaskAssign.pageSize);
                        gridInstancegridSubtaskAssign.option("pager.allowedPageSizes", gridConfiggridSubtaskAssign.allowedPageSizes);
                        gridInstancegridSubtaskAssign.pageIndex(0);
                        gridInstancegridSubtaskAssign.option("dataSource", sortedData);
                        gridInstancegridSubtaskAssign.endUpdate();
                        
                        // RESTORE FILTER STATE T? LOCALSTORAGE
                        setTimeout(function() {
                            const savedFilter = loadGridFilterState("sp_Task_MyWork_html", gridInstancegridSubtaskAssign);
                            if (savedFilter) {
                                console.log("[ReloadData] Restoring filter:", savedFilter);
                                applyGridFilterState(gridInstancegridSubtaskAssign, savedFilter);
                            } else {
                                console.log("[ReloadData] No filter to restore");
                            }
                        }, 100);
                    }
                );
            
                         if (obj) { window.currentRecordID_HeaderID = (obj.HeaderID !== undefined && obj.HeaderID !== null) ? obj.HeaderID : window.currentRecordID_HeaderID; } if (obj) { window.currentRecordID_HistoryID = (obj.HistoryID !== undefined && obj.HistoryID !== null) ? obj.HistoryID : window.currentRecordID_HistoryID; } if (obj) { window.currentRecordID_TaskID = (obj.TaskID !== undefined && obj.TaskID !== null) ? obj.TaskID : window.currentRecordID_TaskID; }
                        DataSource = results;
                        '
        +(select loadData from tblCommonControlType_Signed where UID = 'PDB2DB35885F14803A9A52961A7871972')
        +(select loadData from tblCommonControlType_Signed where UID = 'P870C076FA1FD48DDBDEDE2C2435B4DA9')
        +(select loadData from tblCommonControlType_Signed where UID = 'P777C87EE29F94C29A6EAABD16E31FDDC')
        +(select loadData from tblCommonControlType_Signed where UID = 'P2920410F91DB42948640CF1ABBDEE649')
        +(select loadData from tblCommonControlType_Signed where UID = 'PC98E2DFA331343BBAE22882BE3825C1A')
        +(select loadData from tblCommonControlType_Signed where UID = 'P02E6F18645BA47648567B32773A1B7B4')
        +(select loadData from tblCommonControlType_Signed where UID = 'P27C40759D9C94453AB9B2DFBCD661AE3') +N'
                    }
                })
            }
            ReloadData()
        })();
    </script>
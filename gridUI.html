<script>
    
                    // Thêm responsive styles cho grid header
                    const stylegridMyWork = document.createElement("style");
                    stylegridMyWork.textContent = `
                        /* =============== RESPONSIVE POPUP STYLES =============== */
                        .dx-popup.hpa-responsive {
                            max-width: 95vw !important;
                            max-height: 95vh !important;
                            width: 95vw !important;
                            left: 0 !important;
                            top: 0 !important;
                        }

                        .dx-popup.hpa-responsive .dx-popup-content {
                            height: calc(95vh - 120px) !important;
                            max-height: calc(95vh - 120px) !important;
                            overflow-y: auto !important;
                            padding: 8px !important;
                            display: flex !important;
                            flex-direction: column !important;
                        }

                        .dx-popup.hpa-responsive .dx-popup-content-scrollable {
                            flex: 1 !important;
                            min-height: 0 !important;
                            overflow: auto !important;
                        }

                        .dx-popup-content.dx-popup-content-scrollable {
                            height: auto !important;
                        }

                        .dx-popup.hpa-responsive .dx-toolbar-items {
                            padding: 4px 0 !important;
                            flex-wrap: wrap;
                        }

                        .dx-popup.hpa-responsive .dx-toolbar-item {
                            margin: 2px 2px !important;
                        }

                        /* =============== GRID HEADER STYLES =============== */
                        .dx-datagrid {
                            font-size: 14px;
                        }

                        .dx-datagrid-headers {
                            white-space: normal;
                            word-break: break-word;
                        }

                        .dx-datagrid-header-panel {
                            padding: 8px;
                        }

                        .dx-datagrid .dx-header-row {
                            height: auto;
                            min-height: 44px;
                        }

                        .dx-datagrid .dx-col-fixed {
                            z-index: 800 !important;
                        }

                        /* Group row - sát mép */
                        .dx-datagrid .dx-group-row {
                            padding: 0 !important;
                        }

                        .dx-datagrid .dx-group-row > td {
                            padding: 4px 6px !important;
                        }

                        .dx-datagrid .dx-group-row .dx-group-text {
                            padding: 0 !important;
                            margin: 0 !important;
                        }

                        /* Mobile responsive */
                        @media (max-width: 1024px) {
                            .dx-popup.hpa-responsive {
                                max-width: 90vw !important;
                                max-height: 90vh !important;
                                width: 90vw !important;
                                left: 5vw !important;
                            }
                            .dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable {
                                width: 90vw !important;
                                max-width: 90vw !important;
                            }
                            .dx-popup.hpa-responsive .dx-popup-content {
                                max-height: calc(95vh - 120px) !important;
                            }
                        }

                        @media (max-width: 768px) {
                            .dx-datagrid {
                                font-size: 12px;
                            }

                            .dx-datagrid-headers {
                                padding: 4px !important;
                            }

                            .dx-datagrid .dx-header-row {
                                height: auto;
                                min-height: 36px;
                                padding: 0 !important;
                            }

                            .dx-datagrid-text-content {
                                padding: 4px 2px !important;
                                font-size: 11px !important;
                                line-height: 1.3 !important;
                                overflow: visible !important;
                                white-space: normal !important;
                                word-break: break-word !important;
                            }

                            .dx-datagrid-text-content.dx-header-filter {
                                padding: 2px 1px !important;
                            }

                            .dx-checkbox {
                                width: 24px !important;
                                height: 24px !important;
                            }

                            .dx-datagrid-rowsview {
                                padding: 0 !important;
                            }

                            .dx-datagrid .dx-row {
                                height: auto;
                                min-height: 36px !important;
                                padding: 0 !important;
                            }

                            .dx-datagrid .dx-data-row > td {
                                padding: 0 !important;
                                white-space: normal !important;
                                word-break: break-word !important;
                                vertical-align: middle !important;
                            }

                            .dx-datagrid .dx-group-row > td {
                                padding: 4px 2px !important;
                            }

                            .dx-pager {
                                padding: 4px 0 !important;
                            }

                            .dx-pager-page,
                            .dx-pager-navigation {
                                padding: 2px 4px !important;
                                font-size: 11px !important;
                            }

                            .dx-searchbox {
                                width: 100% !important;
                                max-width: none !important;
                            }

                            .dx-searchbox .dx-texteditor-input {
                                padding: 4px !important;
                                font-size: 12px !important;
                                height: 32px !important;
                            }

                            .dx-popup.hpa-responsive {
                                max-width: 95vw !important;
                                max-height: 85vh !important;
                                width: 95vw !important;
                                left: 2.5vw !important;
                                top: 5vh !important;
                            }
                            .dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable {
                                width: 95vw !important;
                                max-width: 95vw !important;
                                height: auto !important;
                                max-height: 85vh !important;
                            }
                            .dx-popup.hpa-responsive .dx-overlay-wrapper {
                                position: fixed !important;
                            }
                            .dx-popup.hpa-responsive .dx-popup-content {
                                height: calc(95vh - 120px) !important;
                                max-height: calc(95vh - 120px) !important;
                                font-size: 13px !important;
                                padding: 6px !important;
                                display: flex !important;
                                flex-direction: column !important;
                            }

                            .dx-popup.hpa-responsive .dx-popup-content-scrollable {
                                flex: 1 !important;
                                min-height: 0 !important;
                                overflow: auto !important;
                            }

                            .dx-popup-content.dx-popup-content-scrollable {
                                height: auto !important;
                            }
                            /* Toolbar buttons */
                            .dx-popup.hpa-responsive .dx-toolbar-item .dx-button {
                                padding: 6px 12px !important;
                                font-size: 12px !important;
                                min-height: 36px !important;
                                width: auto !important;
                            }
                            .dx-popup.hpa-responsive .dx-toolbar-item .dx-button .dx-button-text {
                                font-size: 12px !important;
                            }
                            .dx-popup.hpa-responsive .dx-button {
                                padding: 6px 12px !important;
                                font-size: 12px !important;
                                min-height: 36px !important;
                                width: auto !important;
                            }
                            .dx-popup.hpa-responsive .dx-button .dx-button-text {
                                font-size: 12px !important;
                            }
                            .dx-popup.hpa-responsive .dx-datagrid {
                                font-size: 11px !important;
                            }
                            .dx-popup.hpa-responsive .dx-datagrid .dx-data-row td {
                                padding: 4px 2px !important;
                            }
                        }

                        @media (max-width: 480px) {
                            .dx-datagrid {
                                font-size: 12px;
                            }

                            .dx-datagrid-headers {
                                padding: 2px !important;
                            }

                            .dx-datagrid .dx-header-row {
                                min-height: 32px;
                            }

                            .dx-datagrid-text-content {
                                padding: 2px 1px !important;
                                font-size: 12px !important;
                            }

                            .dx-checkbox {
                                width: 20px !important;
                                height: 20px !important;
                            }

                            .dx-datagrid .dx-row {
                                min-height: 32px;
                            }

                            .dx-datagrid .dx-data-row > td {
                                padding: 2px 1px !important;
                                font-size: 12px !important;
                            }

                            .dx-pager-page,
                            .dx-pager-navigation {
                                padding: 1px 2px !important;
                                font-size: 12px !important;
                            }

                            .dx-popup.hpa-responsive {
                                max-width: 98vw !important;
                                max-height: 80vh !important;
                                width: 98vw !important;
                                left: 1vw !important;
                                top: 10vh !important;
                            }
                            .dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable {
                                width: 98vw !important;
                                max-width: 98vw !important;
                                height: auto !important;
                                max-height: 80vh !important;
                            }
                            .dx-popup.hpa-responsive .dx-overlay-wrapper {
                                position: fixed !important;
                            }
                            .dx-popup.hpa-responsive .dx-popup-content {
                                height: calc(95vh - 120px) !important;
                                max-height: calc(95vh - 120px) !important;
                                font-size: 12px !important;
                                padding: 4px !important;
                                display: flex !important;
                                flex-direction: column !important;
                            }

                            .dx-popup.hpa-responsive .dx-popup-content-scrollable {
                                flex: 1 !important;
                                min-height: 0 !important;
                                overflow: auto !important;
                            }

                            .dx-popup-content.dx-popup-content-scrollable {
                                height: auto !important;
                            }
                            /* Toolbar buttons */
                            .dx-popup.hpa-responsive .dx-toolbar-item .dx-button {
                                padding: 4px 8px !important;
                                font-size: 11px !important;
                                min-height: 32px !important;
                                width: auto !important;
                            }
                            .dx-popup.hpa-responsive .dx-toolbar-item .dx-button .dx-button-text {
                                font-size: 11px !important;
                            }
                            .dx-popup.hpa-responsive .dx-button {
                                padding: 4px 8px !important;
                                font-size: 11px !important;
                                min-height: 32px !important;
                                width: auto !important;
                            }
                            .dx-popup.hpa-responsive .dx-button .dx-button-text {
                                font-size: 11px !important;
                            }
                            .dx-popup.hpa-responsive .dx-datagrid {
                                font-size: 10px !important;
                            }
                            .dx-popup.hpa-responsive .dx-datagrid .dx-data-row td {
                                padding: 2px 1px !important;
                                font-size: 10px !important;
                            }
                            .dx-popup.hpa-responsive .dx-datagrid .dx-header-row {
                                min-height: 28px !important;
                            }
                            .dx-popup.hpa-responsive .dx-checkbox {
                                width: 18px !important;
                                height: 18px !important;
                            }
                        }
                    `;
                    document.head.appendChild(stylegridMyWork);

                    window.InstancegridMyWork = $("#gridMyWork").dxDataGrid({
                        dataSource: [],
                        keyExpr: "TaskID",
                        height: "100%",
                        width: "100%",
                        remoteOperations: false,
                        showBorders: true,
                        showRowLines: true,
                        rowAlternationEnabled: false,
                        hoverStateEnabled: true,
                        columnAutoWidth: true,
                        allowColumnReordering: false,
                        allowColumnResizing: false,
                        columnResizingMode: "widget",
                        wordWrapEnabled: true,

                        scrolling: {
                            mode: "virtual",
                            rowRenderingMode: "virtual",
                            showScrollbar: "onHover"
                        },

                        paging: {
                            enabled: true,
                            pageSize: 10
                        },

                        pager: {
                            visible: true,
                            allowedPageSizes: [5, 10, 50, 100],
                            showPageSizeSelector: true,
                            showInfo: true,
                            showNavigationButtons: true
                        },

                        selection: {
                            mode: "single",
                            showCheckBoxesMode: "none",
                            allowSelectAll: false
                        },

                        searchPanel: {
                            visible: true,
                            width: 240,
                            placeholder: "Tìm kiếm..."
                        },

                        headerFilter: { visible: true },

                        columnChooser: {
                            enabled: true,
                            mode: "select",
                            title: "Chọn cột hiển thị"
                        },

                        stateStoring: {
                            enabled: false,
                            type: "localStorage",
                            storageKey: "gridState_Grid_View"
                        },

                        grouping: {
                            autoExpandAll: true,
                            contextMenuEnabled: false,
                            allowCollapsing: true
                        },

                        groupPanel: { visible: false },
                        columnFixing: { enabled: true },

                        editing: {
                            mode: "cell",
                            allowUpdating: true
                        },

                        rowDragging: {
                            allowReordering: true,
                            showDragIcons: true,
                            onReorder: function(e) {
                                let dataSource = e.component.option("dataSource");
                                const item = dataSource[e.fromIndex];
                                dataSource.splice(e.fromIndex, 1);
                                dataSource.splice(e.toIndex, 0, item);
                                e.component.option("dataSource", dataSource);
                            }
                        },

                        noDataText: "Không có dữ liệu",

                        columns: [
        {
            dataField: "TaskName",
            caption: "Tên công việc",
            width: 200,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_TaskName"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
            if (!$("head").find("#hpa-inherit-font-style").length) $("head").append("<style id=\"hpa-inherit-font-style\">.dx-widget{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;border-radius:inherit!important}.dx-texteditor, .dx-texteditor-input{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;box-sizing:border-box!important;}</style>");
            const $containerTaskName = $(cellElement);

            let TaskNameOriginalValue = "";
            let TaskNameIsEditing   = false;
            let TaskNameTextDisplay = null;
            let TaskNameMouseDownInside = false;
            let _cancelingSaveTaskName = false;
            let _justSavedTaskName = false;
            let _savingTaskName = false;
            window.TaskNameRealInstance = null;

            /* =============== Popup Save/Cancel =============== */
            let actionPopupTaskName     = null;
            let currentFieldIdTaskName  = null;
            let saveCallbackTaskName    = null;
            let cancelCallbackTaskName  = null;

            function initActionPopupTaskName() {
                if (actionPopupTaskName) return;
                actionPopupTaskName = $("<div>").appendTo("body").dxPopup({
                    width: "auto",
                    height: "auto",
                    showTitle: false,
                    visible: false,
                    shading: false,
                    dragEnabled: false,
                    hideOnOutsideClick: false,
                    animation: null,
                    showCloseButton: false,
                    position: { at: "bottom right", my: "top right", offset: "0 4" },
                    onShown: function(e) {
                        $(e.component.content()).closest(".dx-overlay-wrapper").css("z-index", "9999");
                    },
                    contentTemplate: () => {
                        return $("<div class=\"d-flex\" style=\"gap: 6px; padding: 6px; min-height: fit-content; display: flex; align-items: center; justify-content: center; \">").append(
                            $("<div>").dxButton({
                                icon: "check",
                                type: "success",
                                stylingMode: "contained",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _justSavedTaskName = true;
                                        _savingTaskName = true;
                                    });
                                },
                                onClick: async function() {
                                    if (saveCallbackTaskName) {
                                        await saveCallbackTaskName(true); // Pass true để báo từ button
                                    }

                                    actionPopupTaskName.hide();

                                    setTimeout(function(){
                                        _justSavedTaskName = false;
                                        _savingTaskName = false;
                                    }, 300);
                                }
                            }),
                            $("<div>").dxButton({
                                icon: "close",
                                stylingMode: "outlined",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _cancelingSaveTaskName = true;
                                    });
                                },
                                onClick: function() {
                                    if (cancelCallbackTaskName) {
                                        cancelCallbackTaskName();
                                    }

                                    actionPopupTaskName.hide();

                                    setTimeout(function(){
                                        _cancelingSaveTaskName = false;
                                    }, 300);
                                }
                            })
                        );
                    },
                    onHiding: function() {
                        currentFieldIdTaskName = saveCallbackTaskName = cancelCallbackTaskName = null;
                    }
                }).dxPopup("instance");
            }

            function showActionPopupTaskName(inputElement, fieldId, onSave, onCancel) {
                if (!actionPopupTaskName) initActionPopupTaskName();

                if (currentFieldIdTaskName && currentFieldIdTaskName !== fieldId && cancelCallbackTaskName) {
                    cancelCallbackTaskName();
                }

                currentFieldIdTaskName = fieldId;
                saveCallbackTaskName   = onSave;
                cancelCallbackTaskName = onCancel;

                const updatePos = () => {
                    if (!actionPopupTaskName?.option("visible")) return;
                    const $input = $(inputElement).find("input");
                    if ($input.length === 0) return;
                    actionPopupTaskName.option({
                        position: {
                            my: "top right",
                            at: "bottom right",
                            of: $input,
                            offset: "0 4"
                        }
                    });
                    actionPopupTaskName.repaint();
                };

                actionPopupTaskName.show();
                setTimeout(updatePos, 10);

                $(window).off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);
                $(window).off("resize.ap" + fieldId).on("resize.ap" + fieldId, updatePos);
                $(".dx-scrollable").off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);

                const intervalId = setInterval(() => {
                    if (actionPopupTaskName?.option("visible")) updatePos();
                    else clearInterval(intervalId);
                }, 100);

                actionPopupTaskName.option("onHiding", function() {
                    clearInterval(intervalId);
                    $(window).off("scroll.ap" + fieldId);
                    $(window).off("resize.ap" + fieldId);
                    $(".dx-scrollable").off("scroll.ap" + fieldId);
                    currentFieldIdTaskName = saveCallbackTaskName = cancelCallbackTaskName = null;
                });
            }

            /* =============== Inline Edit logic =============== */
            function exitEditTaskName(cancel = false) {
                if (!TaskNameIsEditing) return;
                TaskNameIsEditing = false;
                TaskNameMouseDownInside = false;
                $(document).off("mousedown.editTaskName");
                $(document).off("mouseup.editTaskName");

                if (cancel) {
                    TaskNameRealInstance.option("value", TaskNameOriginalValue);
                } else {
                    TaskNameOriginalValue = TaskNameRealInstance.option("value");
                }

                if (actionPopupTaskName && actionPopupTaskName.option("visible")) {
                    actionPopupTaskName.option("visible", false);
                }

                $containerTaskName.find(".dx-texteditor").hide();
                TaskNameTextDisplay.text(TaskNameOriginalValue || "").show();
            }

            async function saveValueTaskName(fromButton = false) {
                if (_cancelingSaveTaskName) {
                    _cancelingSaveTaskName = false;
                    exitEditTaskName(true);
                    return;
                }

                // Chỉ check flag _saving khi KHÔNG phải từ button
                // Vì khi từ button thì flag đã được set ở mousedown
                if (!fromButton && _savingTaskName) {
                    return;
                }

                const newVal = TaskNameRealInstance.option("value");

                if (newVal === TaskNameOriginalValue) {
                    exitEditTaskName();
                    _savingTaskName = false;
                    _justSavedTaskName = false;
                    return;
                }

                try {
                    // Chỉ set flag nếu chưa được set (từ button đã set rồi)
                    if (!fromButton) {
                        _savingTaskName = true;
                    }

                    const dataJSON = JSON.stringify(["-1233093056", ["TaskName"], [newVal]]);

                    let currentRecordIDValue = [
                        currentRecordID_TaskID
                    ];

                    let currentRecordID = [
                        "TaskID"
                    ];

                    // chỉ nối khi ColumnIDName2 có thật
                    if ("" && "".trim() !== "") {
                        currentRecordIDValue.push(currentRecordID_);
                        currentRecordID.push("");
                    }

                    const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                    const json = await saveFunction(dataJSON, idValsJSON);

                    const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        _savingTaskName = false;
                        _justSavedTaskName = false;
                        return;
                    }

                    TaskNameOriginalValue = newVal;
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                    }

                    exitEditTaskName();

                    if (cellInfo && cellInfo.component) {
                        try {
                            const grid = cellInfo.component;
                            const rowKey = cellInfo.key || cellInfo.data["TaskID"];

                            // Cập nhật cell value trong grid
                            grid.cellValue(cellInfo.rowIndex, "TaskName", newVal);

                            // Refresh cell để hiển thị giá trị mới
                            grid.repaint();

                        } catch (syncErr) {
                            console.warn("[Grid Sync] Không thể sync grid:", syncErr);
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                } finally {
                    setTimeout(function(){
                        _savingTaskName = false;
                        _justSavedTaskName = false;
                    }, 100);
                }
            }

            /* =============== Handle Click Outside =============== */
            function handleMouseDownTaskName(e) {
                if (!TaskNameIsEditing) return;

                // Nếu đang save hoặc cancel thì không xử lý
                if (_savingTaskName || _cancelingSaveTaskName) return;

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerTaskName).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                if (isInsideControl || isInsidePopup) {
                    TaskNameMouseDownInside = true;
                } else {
                    TaskNameMouseDownInside = false;
                }
            }

            function handleMouseUpTaskName(e) {
                if (!TaskNameIsEditing) return;

                // Nếu đang save, cancel hoặc vừa save xong thì không xử lý
                if (_savingTaskName || _cancelingSaveTaskName || _justSavedTaskName) {
                    TaskNameMouseDownInside = false;
                    return;
                }

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerTaskName).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                // Chỉ save khi cả mousedown và mouseup đều ở ngoài
                if (!TaskNameMouseDownInside && !isInsideControl && !isInsidePopup) {
                    saveValueTaskName();
                }

                TaskNameMouseDownInside = false;
            }

            /* =============== Create UI =============== */
            TaskNameTextDisplay = $("<div>").css({
                "padding": "1px 8px",
                "cursor": "text",
                "min-height": "20px",
                "line-height": "1.5",
                "word-break": "break-word",
                "border": "1px solid transparent",
                "border-radius": "inherit !important",
                "transition": "border-color 0.2s"
            }).appendTo($containerTaskName);

            // Hover effect
            TaskNameTextDisplay.hover(
                function() {
                    if (!TaskNameIsEditing) {
                        $(this).css("border-color", "#ddd");
                    }
                },
                function() {
                    if (!TaskNameIsEditing) {
                        $(this).css("border-color", "transparent");
                    }
                }
            );

            TaskNameTextDisplay.on("click", function() {
                if (TaskNameIsEditing) return;
                TaskNameIsEditing = true;
                TaskNameMouseDownInside = false;
                TaskNameOriginalValue = TaskNameRealInstance.option("value");
                TaskNameTextDisplay.hide();

                $containerTaskName.find(".dx-texteditor").show();

                const $input = $containerTaskName.find("input");
                setTimeout(() => {
                    $input.focus();
                    const len = $input.val().length;
                    $input[0].setSelectionRange(len, len);
                }, 10);

                $input.css({
                    "border-color": "#1c975e",
                    "padding": "1px 8px",
                    "max-height": "100%",
                    "cursor": "text",
                    "border-radius": "inherit !important",
                    "font-size": "inherit",
                    "font-weight": "inherit",
                    "box-sizing": "border-box"
                });

                showActionPopupTaskName(
                    $containerTaskName,
                    "TaskName",
                    async (fromButton) => { await saveValueTaskName(fromButton); },
                    () => exitEditTaskName(true)
                );

                // Bind events sau khi mở edit mode
                setTimeout(() => {
                    $(document).on("mousedown.editTaskName", handleMouseDownTaskName);
                    $(document).on("mouseup.editTaskName", handleMouseUpTaskName);
                }, 100);
            });

            window.TaskNameRealInstance = $("<div>")
                .appendTo($containerTaskName)
                .dxTextBox({
                    value: "",
                    width: "100%",
                    inputAttr: { style: "max-height: 100%; line-height: 1.5; font-size: inherit; font-weight: inherit; padding: 1px 8px; box-sizing: border-box;" },
                    onKeyDown: function(e) {
                        if (!TaskNameIsEditing) return;

                        if (e.event.key === "Enter") {
                            e.event.preventDefault();
                            // Cập nhật value từ input element trước khi save
                            const $input = $containerTaskName.find("input");
                            const currentValue = $input.val();
                            TaskNameRealInstance.option("value", currentValue);
                            saveValueTaskName();
                        }

                        if (e.event.key === "Tab") {
                            e.event.preventDefault();
                            // Tab cũng lưu giống Enter
                            const $input = $containerTaskName.find("input");
                            const currentValue = $input.val();
                            TaskNameRealInstance.option("value", currentValue);
                            saveValueTaskName();
                        }

                        if (e.event.key === "Escape") {
                            e.event.preventDefault();
                            exitEditTaskName(true);
                        }
                    },
                    onFocusOut: function(e) {
                        // Kiểm tra các flag để tránh save trùng
                        if (_cancelingSaveTaskName) {
                            _cancelingSaveTaskName = false;
                            return;
                        }
                        if (_justSavedTaskName) {
                            _justSavedTaskName = false;
                            return;
                        }
                        if (_savingTaskName) {
                            return;
                        }

                        // Auto-save khi mất focus
                        if (TaskNameIsEditing) {
                            const $input = $containerTaskName.find("input");
                            if ($input.val() !== TaskNameOriginalValue) {
                                const currentValue = $input.val();
                                TaskNameRealInstance.option("value", currentValue);
                                saveValueTaskName();
                            } else {
                                exitEditTaskName(false);
                            }
                        }
                    }
                })
                .dxTextBox("instance");

            $containerTaskName.find(".dx-texteditor").hide();

            /* =============== Public API =============== */
            let InstanceTaskName = {
                setValue: function(val) {
                    TaskNameOriginalValue = val || "";
                    TaskNameRealInstance.option("value", val || "");
                    TaskNameTextDisplay.text(val || "");
                },
                getValue: function() {
                    return TaskNameRealInstance.option("value");
                },
                option: function(name, value) {
                    if (value !== undefined) {
                        TaskNameRealInstance.option(name, value);
                        if (name === "value") {
                            TaskNameOriginalValue = value || "";
                            TaskNameTextDisplay.text(value || "");
                        }
                    } else {
                        return TaskNameRealInstance.option(name);
                    }
                },
                repaint: function() {
                    TaskNameRealInstance.repaint();
                },
                _suppressValueChangeAction: function() {
                    if (TaskNameRealInstance._suppressValueChangeAction) {
                        TaskNameRealInstance._suppressValueChangeAction();
                    }
                },
                _resumeValueChangeAction: function() {
                    if (TaskNameRealInstance._resumeValueChangeAction) {
                        TaskNameRealInstance._resumeValueChangeAction();
                    }
                }
            };
        
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceTaskName) {
                        InstanceTaskName.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceTaskName && InstanceTaskName.setCellInfo) {
                        InstanceTaskName.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceTaskName");
                    }
                },
        },
            
        {
            dataField: "Status",
            caption: "Trạng thái",
            width: 180,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_Status"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
		window["DataSource_Status"] = window["DataSource_Status"] || [];

		let StatusDataSourceSP = "";
        let StatusIsLoading = false;
        let StatusIsDataLoaded = false;
        let StatusCellInfo = null; // Biến lưu cellInfo để sync Grid

        function highlightTextStatus(text, search) {
            if (!search || !text) return text;
            const regex = new RegExp("(" + search.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
            return text.replace(regex, "<mark class=\"bg-warning fw-bold px-1 rounded\">$1</mark>");
        }

		window.InstanceStatus = $(cellElement).dxSelectBox({
			dataSource: window["DataSource_Status"],
            valueExpr: "ID",
            displayExpr: "Name",
            placeholder: "Tìm kiếm hoặc chọn...",
            searchEnabled: true,
            searchMode: "contains",
            searchExpr: ["Name", "Code", "Description"],
            searchTimeout: 300,
            minSearchLength: 0,
            showDataBeforeSearch: true,
            showClearButton: false,
            stylingMode: "outlined",
            dropDownOptions: {
                showTitle: false,
                closeOnOutsideClick: true,
                height: "auto",
                maxHeight: 400,
                minWidth: 280,
                onShowing: function(e) {
                    if (!StatusIsDataLoaded && StatusDataSourceSP && StatusDataSourceSP !== "") {
                        // Sử dụng hàm loadDataSourceCommon từ sptblCommonControlType_Signed
                        loadDataSourceCommon("Status", StatusDataSourceSP, function(data) {
                            StatusIsDataLoaded = true;
                            InstanceStatus.option("dataSource", data);
                        });
                    }
                }
            },
            itemTemplate: function(data, index) {
                const $item = $("<div>")
                    .addClass("d-flex align-items-center gap-3 px-3 py-2 my-1 mx-2 rounded")
                    .css({
                        cursor: "pointer",
                        transition: "all 0.2s ease",
                        border: "1px solid transparent"
                    });

                $item.on("mouseenter", function() {
                    $(this).css({
                        transform: "translateX(4px)",
                        borderColor: "#90caf9",
                        boxShadow: "0 2px 8px rgba(0,0,0,0.08)"
                    });
                }).on("mouseleave", function() {
                    $(this).css({
                        background: "",
                        transform: "",
                        borderColor: "transparent",
                        boxShadow: ""
                    });
                });

                const $content = $("<div>").addClass("flex-fill").css("minWidth", "0");
                const searchValue = InstanceStatus.option("searchValue") || "";

                $("<div>")
                    .addClass("fw-semibold")
                    .css({
                        fontSize: "14px",
                        lineHeight: "1.4",
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                        whiteSpace: "nowrap"
                    })
                    .html(highlightTextStatus(data.Name || "", searchValue))
                    .appendTo($content);

                if (data.Description || data.Code) {
                    $("<div>")
                        .addClass("small text-muted")
                        .css({
                            fontSize: "12px",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            whiteSpace: "nowrap"
                        })
                        .text(data.Code || data.Description)
                        .appendTo($content);
                }

                $content.appendTo($item);

                if (data.Status) {
                    const badgeClass = data.Status === "Active" ? "bg-success" : "bg-secondary";
                    $("<span>")
                        .addClass("badge " + badgeClass + " text-uppercase")
                        .css({
                            fontSize: "9px",
                            padding: "4px 8px",
                            letterSpacing: "0.5px",
                            flexShrink: "0"
                        })
                        .text(data.Status)
                        .appendTo($item);
                }

                setTimeout(() => {
                    $item.css({
                        opacity: "0",
                        transform: "translateX(-10px)"
                    }).animate({
                        opacity: 1
                    }, {
                        duration: 300,
                        step: function(now) {
                            $(this).css("transform", "translateX(" + (-10 + (now * 10)) + "px)");
                        },
                        delay: index * 30
                    });
                }, 10);

                return $item;
            },
            onOpened: function(e) {
                $(e.component._popup.content()).parent()
                    .addClass("shadow-lg border rounded hpa-responsive")
                    .css({
                        borderRadius: "12px",
                        padding: "8px 0",
                        borderColor: "#dee2e6"
                    });
            },
            onFocusIn: function(e) {
                InstanceStatus.option("showClearButton", true);
            },
            onFocusOut: function(e) {
                InstanceStatus.option("showClearButton", false);
            },
            onKeyDown: function(e) {
                if (e.key === "Enter" || e.key === "Tab") {
                    InstanceStatus.option("showClearButton", false);
                }
            },
            onValueChanged: async function(e) {
                if (!e.event) return;

                // Nếu người dùng tìm kiếm rỗng và kết quả trả về là 0/empty/null,
                // không thực hiện lưu và giữ lại giá trị hiện tại.
                if (e.value === "" || e.value == null || e.value === 0 || e.value === "0") {
                    InstanceStatus.option("value", _initialStatus);
                    return;
                }

                $(cellElement).find(".dx-texteditor-input").blur();
                if (InstanceStatus && InstanceStatus.blur) InstanceStatus.blur();

                const $el = $(e.element);
                $el.css({
                    transform: "scale(1.02)",
                    boxShadow: "0 0 0 3px rgba(28, 151, 94, 0.2)",
                    transition: "all 0.2s ease"
                });
                setTimeout(() => {
                    $el.css({
                        transform: "",
                        boxShadow: ""
                    });
                }, 300);

                // Gọi hàm callback onSelectBoxChanged nếu có
                if (typeof window["onSelectBoxChanged_Status"] === "function") {
                    console.log("Calling onSelectBoxChanged_Status callback");
                    window["onSelectBoxChanged_Status"](e.value, InstanceStatus, e);
                }

				const val = e.value;
				const dataJSON = JSON.stringify(["-1518142557", ["Status"], [val || ""]]);
				
				let currentRecordIDValue = [currentRecordID_HistoryID];
                let currentRecordID = ["HistoryID"];

				if ("" && "".trim() !== "") {
					currentRecordIDValue.push(currentRecordID_);
					currentRecordID.push("");
				}
				const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);
				
				try {
					const json = await saveFunction(dataJSON, idValsJSON);
					const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        InstanceStatus.option("value", _initialStatus);
                    } else {
                        // SYNC GRID: Cập nhật lại giá trị trong Grid sau khi save thành công
                        if (StatusCellInfo && StatusCellInfo.component) {
                            try {
                                const grid = StatusCellInfo.component;
                                const rowKey = StatusCellInfo.key || StatusCellInfo.data["HistoryID"];
                                
                                // Cập nhật cell value trong grid
                                grid.cellValue(StatusCellInfo.rowIndex, "Status", val);
                                
                                // Refresh cell để hiển thị giá trị mới
                                grid.repaint();
                                
                                console.log("[Grid Sync] SelectBox Status: Updated value =", val, "for row", rowKey);
                            } catch (syncErr) {
                                console.warn("[Grid Sync] SelectBox Status: Không thể sync grid:", syncErr);
                            }
                        }

                        if ("0" === "1") {
                            uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                    InstanceStatus.option("value", _initialStatus);
                    console.error("SelectBox Save Error:", err);
                }
			}
            }).dxSelectBox("instance");

            const _initialStatus = InstanceStatus.option("value");



        // Thêm method setCellInfo vào Instance để nhận cellInfo từ Grid
        InstanceStatus.setCellInfo = function(cellInfo) {
            StatusCellInfo = cellInfo;
            console.log("[SelectBox Status] Received cellInfo:", cellInfo);
        };
		
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceStatus) {
                        InstanceStatus.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceStatus && InstanceStatus.setCellInfo) {
                        InstanceStatus.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceStatus");
                    }
                },
        },
            
        {
            dataField: "AssignPriority",
            caption: "Ưu tiên",
            width: 180,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_AssignPriority"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
		window["DataSource_AssignPriority"] = window["DataSource_AssignPriority"] || [];

		let AssignPriorityDataSourceSP = "";
        let AssignPriorityIsLoading = false;
        let AssignPriorityIsDataLoaded = false;
        let AssignPriorityCellInfo = null; // Biến lưu cellInfo để sync Grid

        function highlightTextAssignPriority(text, search) {
            if (!search || !text) return text;
            const regex = new RegExp("(" + search.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
            return text.replace(regex, "<mark class=\"bg-warning fw-bold px-1 rounded\">$1</mark>");
        }

		window.InstanceAssignPriority = $(cellElement).dxSelectBox({
			dataSource: window["DataSource_AssignPriority"],
            valueExpr: "ID",
            displayExpr: "Name",
            placeholder: "Tìm kiếm hoặc chọn...",
            searchEnabled: true,
            searchMode: "contains",
            searchExpr: ["Name", "Code", "Description"],
            searchTimeout: 300,
            minSearchLength: 0,
            showDataBeforeSearch: true,
            showClearButton: false,
            stylingMode: "outlined",
            dropDownOptions: {
                showTitle: false,
                closeOnOutsideClick: true,
                height: "auto",
                maxHeight: 400,
                minWidth: 280,
                onShowing: function(e) {
                    if (!AssignPriorityIsDataLoaded && AssignPriorityDataSourceSP && AssignPriorityDataSourceSP !== "") {
                        // Sử dụng hàm loadDataSourceCommon từ sptblCommonControlType_Signed
                        loadDataSourceCommon("AssignPriority", AssignPriorityDataSourceSP, function(data) {
                            AssignPriorityIsDataLoaded = true;
                            InstanceAssignPriority.option("dataSource", data);
                        });
                    }
                }
            },
            itemTemplate: function(data, index) {
                const $item = $("<div>")
                    .addClass("d-flex align-items-center gap-3 px-3 py-2 my-1 mx-2 rounded")
                    .css({
                        cursor: "pointer",
                        transition: "all 0.2s ease",
                        border: "1px solid transparent"
                    });

                $item.on("mouseenter", function() {
                    $(this).css({
                        transform: "translateX(4px)",
                        borderColor: "#90caf9",
                        boxShadow: "0 2px 8px rgba(0,0,0,0.08)"
                    });
                }).on("mouseleave", function() {
                    $(this).css({
                        background: "",
                        transform: "",
                        borderColor: "transparent",
                        boxShadow: ""
                    });
                });

                const $content = $("<div>").addClass("flex-fill").css("minWidth", "0");
                const searchValue = InstanceAssignPriority.option("searchValue") || "";

                $("<div>")
                    .addClass("fw-semibold")
                    .css({
                        fontSize: "14px",
                        lineHeight: "1.4",
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                        whiteSpace: "nowrap"
                    })
                    .html(highlightTextAssignPriority(data.Name || "", searchValue))
                    .appendTo($content);

                if (data.Description || data.Code) {
                    $("<div>")
                        .addClass("small text-muted")
                        .css({
                            fontSize: "12px",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            whiteSpace: "nowrap"
                        })
                        .text(data.Code || data.Description)
                        .appendTo($content);
                }

                $content.appendTo($item);

                if (data.Status) {
                    const badgeClass = data.Status === "Active" ? "bg-success" : "bg-secondary";
                    $("<span>")
                        .addClass("badge " + badgeClass + " text-uppercase")
                        .css({
                            fontSize: "9px",
                            padding: "4px 8px",
                            letterSpacing: "0.5px",
                            flexShrink: "0"
                        })
                        .text(data.Status)
                        .appendTo($item);
                }

                setTimeout(() => {
                    $item.css({
                        opacity: "0",
                        transform: "translateX(-10px)"
                    }).animate({
                        opacity: 1
                    }, {
                        duration: 300,
                        step: function(now) {
                            $(this).css("transform", "translateX(" + (-10 + (now * 10)) + "px)");
                        },
                        delay: index * 30
                    });
                }, 10);

                return $item;
            },
            onOpened: function(e) {
                $(e.component._popup.content()).parent()
                    .addClass("shadow-lg border rounded hpa-responsive")
                    .css({
                        borderRadius: "12px",
                        padding: "8px 0",
                        borderColor: "#dee2e6"
                    });
            },
            onFocusIn: function(e) {
                InstanceAssignPriority.option("showClearButton", true);
            },
            onFocusOut: function(e) {
                InstanceAssignPriority.option("showClearButton", false);
            },
            onKeyDown: function(e) {
                if (e.key === "Enter" || e.key === "Tab") {
                    InstanceAssignPriority.option("showClearButton", false);
                }
            },
            onValueChanged: async function(e) {
                if (!e.event) return;

                // Nếu người dùng tìm kiếm rỗng và kết quả trả về là 0/empty/null,
                // không thực hiện lưu và giữ lại giá trị hiện tại.
                if (e.value === "" || e.value == null || e.value === 0 || e.value === "0") {
                    InstanceAssignPriority.option("value", _initialAssignPriority);
                    return;
                }

                $(cellElement).find(".dx-texteditor-input").blur();
                if (InstanceAssignPriority && InstanceAssignPriority.blur) InstanceAssignPriority.blur();

                const $el = $(e.element);
                $el.css({
                    transform: "scale(1.02)",
                    boxShadow: "0 0 0 3px rgba(28, 151, 94, 0.2)",
                    transition: "all 0.2s ease"
                });
                setTimeout(() => {
                    $el.css({
                        transform: "",
                        boxShadow: ""
                    });
                }, 300);

                // Gọi hàm callback onSelectBoxChanged nếu có
                if (typeof window["onSelectBoxChanged_AssignPriority"] === "function") {
                    console.log("Calling onSelectBoxChanged_AssignPriority callback");
                    window["onSelectBoxChanged_AssignPriority"](e.value, InstanceAssignPriority, e);
                }

				const val = e.value;
				const dataJSON = JSON.stringify(["-1518142557", ["AssignPriority"], [val || ""]]);
				
				let currentRecordIDValue = [currentRecordID_HistoryID];
                let currentRecordID = ["HistoryID"];

				if ("" && "".trim() !== "") {
					currentRecordIDValue.push(currentRecordID_);
					currentRecordID.push("");
				}
				const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);
				
				try {
					const json = await saveFunction(dataJSON, idValsJSON);
					const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        InstanceAssignPriority.option("value", _initialAssignPriority);
                    } else {
                        // SYNC GRID: Cập nhật lại giá trị trong Grid sau khi save thành công
                        if (AssignPriorityCellInfo && AssignPriorityCellInfo.component) {
                            try {
                                const grid = AssignPriorityCellInfo.component;
                                const rowKey = AssignPriorityCellInfo.key || AssignPriorityCellInfo.data["HistoryID"];
                                
                                // Cập nhật cell value trong grid
                                grid.cellValue(AssignPriorityCellInfo.rowIndex, "AssignPriority", val);
                                
                                // Refresh cell để hiển thị giá trị mới
                                grid.repaint();
                                
                                console.log("[Grid Sync] SelectBox AssignPriority: Updated value =", val, "for row", rowKey);
                            } catch (syncErr) {
                                console.warn("[Grid Sync] SelectBox AssignPriority: Không thể sync grid:", syncErr);
                            }
                        }

                        if ("0" === "1") {
                            uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                    InstanceAssignPriority.option("value", _initialAssignPriority);
                    console.error("SelectBox Save Error:", err);
                }
			}
            }).dxSelectBox("instance");

            const _initialAssignPriority = InstanceAssignPriority.option("value");



        // Thêm method setCellInfo vào Instance để nhận cellInfo từ Grid
        InstanceAssignPriority.setCellInfo = function(cellInfo) {
            AssignPriorityCellInfo = cellInfo;
            console.log("[SelectBox AssignPriority] Received cellInfo:", cellInfo);
        };
		
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceAssignPriority) {
                        InstanceAssignPriority.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceAssignPriority && InstanceAssignPriority.setCellInfo) {
                        InstanceAssignPriority.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceAssignPriority");
                    }
                },
        },
            
        {
            dataField: "StartDate",
            caption: "Ngày giờ bắt đầu",
            width: 150,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const d = new Date(val);
                const txt = DevExpress.localization.formatDate(d, "dd/MM/yyyy HH:mm");
                $("<div>").text(txt).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
        let InstanceStartDate, StartDateTimeOut, StartDateCellInfo = null;

        async function DateboxSaveLogic() {
            let val = InstanceStartDate.option("value");
            // Sửa format lưu thành yyyy/MM/dd HH:mm để lấy cả giờ
            let valToSave = val ? DevExpress.localization.formatDate(new Date(val), "yyyy/MM/dd HH:mm") : null;

            const dataJSON = JSON.stringify(["-1518142557", ["StartDate"], [valToSave]]);
            let currentRecordIDValue = [currentRecordID_HistoryID];
            let currentRecordID = ["HistoryID"];

            if ("" && "".trim() !== "") {
                currentRecordIDValue.push(currentRecordID_);
                currentRecordID.push("");
            }

            const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);
            const json = await saveFunction(dataJSON, idValsJSON);
            const dtError = json.data[json.data.length - 1] || [];

            if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
            }

			// SYNC GRID: Cập nhật lại giá trị trong Grid sau khi save thành công
			if (StartDateCellInfo && StartDateCellInfo.component) {
				console.log("run update grid")
                try {
                    const grid = StartDateCellInfo.component;
                    const rowKey = StartDateCellInfo.key || StartDateCellInfo.data["HistoryID"];

                    // Cập nhật cell value trong grid
                    grid.cellValue(StartDateCellInfo.rowIndex, "StartDate", val);
                    console.log("run update grid val", val)
                    // Refresh cell để hiển thị giá trị mới
                    grid.repaint();

                    console.log("[Grid Sync] SelectBox StartDate: Updated value =", val, "for row", rowKey);
                } catch (syncErr) {
                    console.warn("[Grid Sync] SelectBox StartDate: Không thể sync grid:", syncErr);
                }
            }
        }

        InstanceStartDate = $(cellElement).dxDateBox({
            type: "datetime",  // Đổi từ date -> datetime
            displayFormat: "dd/MM/yyyy HH:mm", // Thêm hiển thị giờ
            useMaskBehavior: true,
            openOnFieldClick: true,
            showClearButton: false,
            dateSerializationFormat: "yyyy-MM-ddTHH:mm:ss", // Format chuẩn ISO có giờ
            width: "100%",
            elementAttr: { class: "hpa-dx-datebox-inline" },
            onValueChanged: async (e) => {
                clearTimeout(StartDateTimeOut);
                e.event && await DateboxSaveLogic();
            },
            onKeyUp: (e) => {
                clearTimeout(StartDateTimeOut);
                StartDateTimeOut = setTimeout(async () => DateboxSaveLogic(), 1000);
            }
        }).dxDateBox("instance");

		// Thêm method setCellInfo vào Instance để nhận cellInfo từ Grid
        InstanceStartDate.setCellInfo = function(cellInfo) {
            StartDateCellInfo = cellInfo;
            console.log("[SelectBox StartDate] Received cellInfo:", cellInfo);
        };
    
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceStartDate) {
                        InstanceStartDate.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceStartDate && InstanceStartDate.setCellInfo) {
                        InstanceStartDate.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceStartDate");
                    }
                },
        },
            
        {
            dataField: "EndDate",
            caption: "Ngày giờ kết thúc",
            width: 150,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const d = new Date(val);
                const txt = DevExpress.localization.formatDate(d, "dd/MM/yyyy HH:mm");
                $("<div>").text(txt).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
        let InstanceEndDate, EndDateTimeOut, EndDateCellInfo = null;

        async function DateboxSaveLogic() {
            let val = InstanceEndDate.option("value");
            // Sửa format lưu thành yyyy/MM/dd HH:mm để lấy cả giờ
            let valToSave = val ? DevExpress.localization.formatDate(new Date(val), "yyyy/MM/dd HH:mm") : null;

            const dataJSON = JSON.stringify(["-1518142557", ["EndDate"], [valToSave]]);
            let currentRecordIDValue = [currentRecordID_HistoryID];
            let currentRecordID = ["HistoryID"];

            if ("" && "".trim() !== "") {
                currentRecordIDValue.push(currentRecordID_);
                currentRecordID.push("");
            }

            const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);
            const json = await saveFunction(dataJSON, idValsJSON);
            const dtError = json.data[json.data.length - 1] || [];

            if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
            }

			// SYNC GRID: Cập nhật lại giá trị trong Grid sau khi save thành công
			if (EndDateCellInfo && EndDateCellInfo.component) {
				console.log("run update grid")
                try {
                    const grid = EndDateCellInfo.component;
                    const rowKey = EndDateCellInfo.key || EndDateCellInfo.data["HistoryID"];

                    // Cập nhật cell value trong grid
                    grid.cellValue(EndDateCellInfo.rowIndex, "EndDate", val);
                    console.log("run update grid val", val)
                    // Refresh cell để hiển thị giá trị mới
                    grid.repaint();

                    console.log("[Grid Sync] SelectBox EndDate: Updated value =", val, "for row", rowKey);
                } catch (syncErr) {
                    console.warn("[Grid Sync] SelectBox EndDate: Không thể sync grid:", syncErr);
                }
            }
        }

        InstanceEndDate = $(cellElement).dxDateBox({
            type: "datetime",  // Đổi từ date -> datetime
            displayFormat: "dd/MM/yyyy HH:mm", // Thêm hiển thị giờ
            useMaskBehavior: true,
            openOnFieldClick: true,
            showClearButton: false,
            dateSerializationFormat: "yyyy-MM-ddTHH:mm:ss", // Format chuẩn ISO có giờ
            width: "100%",
            elementAttr: { class: "hpa-dx-datebox-inline" },
            onValueChanged: async (e) => {
                clearTimeout(EndDateTimeOut);
                e.event && await DateboxSaveLogic();
            },
            onKeyUp: (e) => {
                clearTimeout(EndDateTimeOut);
                EndDateTimeOut = setTimeout(async () => DateboxSaveLogic(), 1000);
            }
        }).dxDateBox("instance");

		// Thêm method setCellInfo vào Instance để nhận cellInfo từ Grid
        InstanceEndDate.setCellInfo = function(cellInfo) {
            EndDateCellInfo = cellInfo;
            console.log("[SelectBox EndDate] Received cellInfo:", cellInfo);
        };
    
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceEndDate) {
                        InstanceEndDate.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceEndDate && InstanceEndDate.setCellInfo) {
                        InstanceEndDate.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceEndDate");
                    }
                },
        },
            
        {
            dataField: "Progress",
            caption: "Tiến độ (%)",
            width: 120,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_Progress"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
        let InstanceProgress, ProgressTimeOut, ProgressCellInfo = null;;

        async function NumberBoxSaveLogic() {
            let val = InstanceProgress.option("value");
            const dataJSON = JSON.stringify(["-1518142557", ["Progress"], [val]]);
            const idValuesJSON = JSON.stringify([[currentRecordID], "HistoryID"]);
            const json = await saveFunction(dataJSON, idValuesJSON);
            const dtError = json.data[json.data.length - 1] || [];
            if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
            }
            if (ProgressCellInfo && ProgressCellInfo.component) {
	            console.log("run update grid")
                try {
                    const grid = ProgressCellInfo.component;
                    const rowKey = ProgressCellInfo.key || ProgressCellInfo.data["HistoryID"];

                    // Cập nhật cell value trong grid
                    grid.cellValue(ProgressCellInfo.rowIndex, "Progress", val);
                    console.log("run update grid val", val)
                    // Refresh cell để hiển thị giá trị mới
                    grid.repaint();

                    console.log("[Grid Sync] SelectBox Progress: Updated value =", val, "for row", rowKey);
                } catch (syncErr) {
                    console.warn("[Grid Sync] SelectBox Progress: Không thể sync grid:", syncErr);
                }
            }
        }

       InstanceProgress = $(cellElement).dxNumberBox({
            format: "#,##0",
           showSpinButtons: false,
            showClearButton: false,
            width: "100%",
            elementAttr: { class: "hpa-dx-numberbox-inline" },
            onValueChanged: async (e) => {
                clearTimeout(ProgressTimeOut);
                e.event && await NumberBoxSaveLogic();
            },
            onKeyUp: (e) => {
                clearTimeout(ProgressTimeOut);
                ProgressTimeOut = setTimeout(async () => NumberBoxSaveLogic(), 1000);
            }
        }).dxNumberBox("instance");
    
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceProgress) {
                        InstanceProgress.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceProgress && InstanceProgress.setCellInfo) {
                        InstanceProgress.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceProgress");
                    }
                },
        },
            
        {
            dataField: "TaskID",
            caption: "Mã CV",
            width: 150,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_TaskID"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
            if (!$("head").find("#hpa-inherit-font-style").length) $("head").append("<style id=\"hpa-inherit-font-style\">.dx-widget{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;border-radius:inherit!important}.dx-texteditor, .dx-texteditor-input{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;box-sizing:border-box!important;}</style>");
            const $containerTaskID = $(cellElement);

            let TaskIDOriginalValue = "";
            let TaskIDIsEditing   = false;
            let TaskIDTextDisplay = null;
            let TaskIDMouseDownInside = false;
            let _cancelingSaveTaskID = false;
            let _justSavedTaskID = false;
            let _savingTaskID = false;
            window.TaskIDRealInstance = null;

            /* =============== Popup Save/Cancel =============== */
            let actionPopupTaskID     = null;
            let currentFieldIdTaskID  = null;
            let saveCallbackTaskID    = null;
            let cancelCallbackTaskID  = null;

            function initActionPopupTaskID() {
                if (actionPopupTaskID) return;
                actionPopupTaskID = $("<div>").appendTo("body").dxPopup({
                    width: "auto",
                    height: "auto",
                    showTitle: false,
                    visible: false,
                    shading: false,
                    dragEnabled: false,
                    hideOnOutsideClick: false,
                    animation: null,
                    showCloseButton: false,
                    position: { at: "bottom right", my: "top right", offset: "0 4" },
                    onShown: function(e) {
                        $(e.component.content()).closest(".dx-overlay-wrapper").css("z-index", "9999");
                    },
                    contentTemplate: () => {
                        return $("<div class=\"d-flex\" style=\"gap: 6px; padding: 6px; min-height: fit-content; display: flex; align-items: center; justify-content: center; \">").append(
                            $("<div>").dxButton({
                                icon: "check",
                                type: "success",
                                stylingMode: "contained",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _justSavedTaskID = true;
                                        _savingTaskID = true;
                                    });
                                },
                                onClick: async function() {
                                    if (saveCallbackTaskID) {
                                        await saveCallbackTaskID(true); // Pass true để báo từ button
                                    }

                                    actionPopupTaskID.hide();

                                    setTimeout(function(){
                                        _justSavedTaskID = false;
                                        _savingTaskID = false;
                                    }, 300);
                                }
                            }),
                            $("<div>").dxButton({
                                icon: "close",
                                stylingMode: "outlined",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _cancelingSaveTaskID = true;
                                    });
                                },
                                onClick: function() {
                                    if (cancelCallbackTaskID) {
                                        cancelCallbackTaskID();
                                    }

                                    actionPopupTaskID.hide();

                                    setTimeout(function(){
                                        _cancelingSaveTaskID = false;
                                    }, 300);
                                }
                            })
                        );
                    },
                    onHiding: function() {
                        currentFieldIdTaskID = saveCallbackTaskID = cancelCallbackTaskID = null;
                    }
                }).dxPopup("instance");
            }

            function showActionPopupTaskID(inputElement, fieldId, onSave, onCancel) {
                if (!actionPopupTaskID) initActionPopupTaskID();

                if (currentFieldIdTaskID && currentFieldIdTaskID !== fieldId && cancelCallbackTaskID) {
                    cancelCallbackTaskID();
                }

                currentFieldIdTaskID = fieldId;
                saveCallbackTaskID   = onSave;
                cancelCallbackTaskID = onCancel;

                const updatePos = () => {
                    if (!actionPopupTaskID?.option("visible")) return;
                    const $input = $(inputElement).find("input");
                    if ($input.length === 0) return;
                    actionPopupTaskID.option({
                        position: {
                            my: "top right",
                            at: "bottom right",
                            of: $input,
                            offset: "0 4"
                        }
                    });
                    actionPopupTaskID.repaint();
                };

                actionPopupTaskID.show();
                setTimeout(updatePos, 10);

                $(window).off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);
                $(window).off("resize.ap" + fieldId).on("resize.ap" + fieldId, updatePos);
                $(".dx-scrollable").off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);

                const intervalId = setInterval(() => {
                    if (actionPopupTaskID?.option("visible")) updatePos();
                    else clearInterval(intervalId);
                }, 100);

                actionPopupTaskID.option("onHiding", function() {
                    clearInterval(intervalId);
                    $(window).off("scroll.ap" + fieldId);
                    $(window).off("resize.ap" + fieldId);
                    $(".dx-scrollable").off("scroll.ap" + fieldId);
                    currentFieldIdTaskID = saveCallbackTaskID = cancelCallbackTaskID = null;
                });
            }

            /* =============== Inline Edit logic =============== */
            function exitEditTaskID(cancel = false) {
                if (!TaskIDIsEditing) return;
                TaskIDIsEditing = false;
                TaskIDMouseDownInside = false;
                $(document).off("mousedown.editTaskID");
                $(document).off("mouseup.editTaskID");

                if (cancel) {
                    TaskIDRealInstance.option("value", TaskIDOriginalValue);
                } else {
                    TaskIDOriginalValue = TaskIDRealInstance.option("value");
                }

                if (actionPopupTaskID && actionPopupTaskID.option("visible")) {
                    actionPopupTaskID.option("visible", false);
                }

                $containerTaskID.find(".dx-texteditor").hide();
                TaskIDTextDisplay.text(TaskIDOriginalValue || "").show();
            }

            async function saveValueTaskID(fromButton = false) {
                if (_cancelingSaveTaskID) {
                    _cancelingSaveTaskID = false;
                    exitEditTaskID(true);
                    return;
                }

                // Chỉ check flag _saving khi KHÔNG phải từ button
                // Vì khi từ button thì flag đã được set ở mousedown
                if (!fromButton && _savingTaskID) {
                    return;
                }

                const newVal = TaskIDRealInstance.option("value");

                if (newVal === TaskIDOriginalValue) {
                    exitEditTaskID();
                    _savingTaskID = false;
                    _justSavedTaskID = false;
                    return;
                }

                try {
                    // Chỉ set flag nếu chưa được set (từ button đã set rồi)
                    if (!fromButton) {
                        _savingTaskID = true;
                    }

                    const dataJSON = JSON.stringify(["-1518142557", ["TaskID"], [newVal]]);

                    let currentRecordIDValue = [
                        currentRecordID_HistoryID
                    ];

                    let currentRecordID = [
                        "HistoryID"
                    ];

                    // chỉ nối khi ColumnIDName2 có thật
                    if ("" && "".trim() !== "") {
                        currentRecordIDValue.push(currentRecordID_);
                        currentRecordID.push("");
                    }

                    const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                    const json = await saveFunction(dataJSON, idValsJSON);

                    const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        _savingTaskID = false;
                        _justSavedTaskID = false;
                        return;
                    }

                    TaskIDOriginalValue = newVal;
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                    }

                    exitEditTaskID();

                    if (cellInfo && cellInfo.component) {
                        try {
                            const grid = cellInfo.component;
                            const rowKey = cellInfo.key || cellInfo.data["HistoryID"];

                            // Cập nhật cell value trong grid
                            grid.cellValue(cellInfo.rowIndex, "TaskID", newVal);

                            // Refresh cell để hiển thị giá trị mới
                            grid.repaint();

                        } catch (syncErr) {
                            console.warn("[Grid Sync] Không thể sync grid:", syncErr);
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                } finally {
                    setTimeout(function(){
                        _savingTaskID = false;
                        _justSavedTaskID = false;
                    }, 100);
                }
            }

            /* =============== Handle Click Outside =============== */
            function handleMouseDownTaskID(e) {
                if (!TaskIDIsEditing) return;

                // Nếu đang save hoặc cancel thì không xử lý
                if (_savingTaskID || _cancelingSaveTaskID) return;

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerTaskID).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                if (isInsideControl || isInsidePopup) {
                    TaskIDMouseDownInside = true;
                } else {
                    TaskIDMouseDownInside = false;
                }
            }

            function handleMouseUpTaskID(e) {
                if (!TaskIDIsEditing) return;

                // Nếu đang save, cancel hoặc vừa save xong thì không xử lý
                if (_savingTaskID || _cancelingSaveTaskID || _justSavedTaskID) {
                    TaskIDMouseDownInside = false;
                    return;
                }

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerTaskID).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                // Chỉ save khi cả mousedown và mouseup đều ở ngoài
                if (!TaskIDMouseDownInside && !isInsideControl && !isInsidePopup) {
                    saveValueTaskID();
                }

                TaskIDMouseDownInside = false;
            }

            /* =============== Create UI =============== */
            TaskIDTextDisplay = $("<div>").css({
                "padding": "1px 8px",
                "cursor": "text",
                "min-height": "20px",
                "line-height": "1.5",
                "word-break": "break-word",
                "border": "1px solid transparent",
                "border-radius": "inherit !important",
                "transition": "border-color 0.2s"
            }).appendTo($containerTaskID);

            // Hover effect
            TaskIDTextDisplay.hover(
                function() {
                    if (!TaskIDIsEditing) {
                        $(this).css("border-color", "#ddd");
                    }
                },
                function() {
                    if (!TaskIDIsEditing) {
                        $(this).css("border-color", "transparent");
                    }
                }
            );

            TaskIDTextDisplay.on("click", function() {
                if (TaskIDIsEditing) return;
                TaskIDIsEditing = true;
                TaskIDMouseDownInside = false;
                TaskIDOriginalValue = TaskIDRealInstance.option("value");
                TaskIDTextDisplay.hide();

                $containerTaskID.find(".dx-texteditor").show();

                const $input = $containerTaskID.find("input");
                setTimeout(() => {
                    $input.focus();
                    const len = $input.val().length;
                    $input[0].setSelectionRange(len, len);
                }, 10);

                $input.css({
                    "border-color": "#1c975e",
                    "padding": "1px 8px",
                    "max-height": "100%",
                    "cursor": "text",
                    "border-radius": "inherit !important",
                    "font-size": "inherit",
                    "font-weight": "inherit",
                    "box-sizing": "border-box"
                });

                showActionPopupTaskID(
                    $containerTaskID,
                    "TaskID",
                    async (fromButton) => { await saveValueTaskID(fromButton); },
                    () => exitEditTaskID(true)
                );

                // Bind events sau khi mở edit mode
                setTimeout(() => {
                    $(document).on("mousedown.editTaskID", handleMouseDownTaskID);
                    $(document).on("mouseup.editTaskID", handleMouseUpTaskID);
                }, 100);
            });

            window.TaskIDRealInstance = $("<div>")
                .appendTo($containerTaskID)
                .dxTextBox({
                    value: "",
                    width: "100%",
                    inputAttr: { style: "max-height: 100%; line-height: 1.5; font-size: inherit; font-weight: inherit; padding: 1px 8px; box-sizing: border-box;" },
                    onKeyDown: function(e) {
                        if (!TaskIDIsEditing) return;

                        if (e.event.key === "Enter") {
                            e.event.preventDefault();
                            // Cập nhật value từ input element trước khi save
                            const $input = $containerTaskID.find("input");
                            const currentValue = $input.val();
                            TaskIDRealInstance.option("value", currentValue);
                            saveValueTaskID();
                        }

                        if (e.event.key === "Tab") {
                            e.event.preventDefault();
                            // Tab cũng lưu giống Enter
                            const $input = $containerTaskID.find("input");
                            const currentValue = $input.val();
                            TaskIDRealInstance.option("value", currentValue);
                            saveValueTaskID();
                        }

                        if (e.event.key === "Escape") {
                            e.event.preventDefault();
                            exitEditTaskID(true);
                        }
                    },
                    onFocusOut: function(e) {
                        // Kiểm tra các flag để tránh save trùng
                        if (_cancelingSaveTaskID) {
                            _cancelingSaveTaskID = false;
                            return;
                        }
                        if (_justSavedTaskID) {
                            _justSavedTaskID = false;
                            return;
                        }
                        if (_savingTaskID) {
                            return;
                        }

                        // Auto-save khi mất focus
                        if (TaskIDIsEditing) {
                            const $input = $containerTaskID.find("input");
                            if ($input.val() !== TaskIDOriginalValue) {
                                const currentValue = $input.val();
                                TaskIDRealInstance.option("value", currentValue);
                                saveValueTaskID();
                            } else {
                                exitEditTaskID(false);
                            }
                        }
                    }
                })
                .dxTextBox("instance");

            $containerTaskID.find(".dx-texteditor").hide();

            /* =============== Public API =============== */
            let InstanceTaskID = {
                setValue: function(val) {
                    TaskIDOriginalValue = val || "";
                    TaskIDRealInstance.option("value", val || "");
                    TaskIDTextDisplay.text(val || "");
                },
                getValue: function() {
                    return TaskIDRealInstance.option("value");
                },
                option: function(name, value) {
                    if (value !== undefined) {
                        TaskIDRealInstance.option(name, value);
                        if (name === "value") {
                            TaskIDOriginalValue = value || "";
                            TaskIDTextDisplay.text(value || "");
                        }
                    } else {
                        return TaskIDRealInstance.option(name);
                    }
                },
                repaint: function() {
                    TaskIDRealInstance.repaint();
                },
                _suppressValueChangeAction: function() {
                    if (TaskIDRealInstance._suppressValueChangeAction) {
                        TaskIDRealInstance._suppressValueChangeAction();
                    }
                },
                _resumeValueChangeAction: function() {
                    if (TaskIDRealInstance._resumeValueChangeAction) {
                        TaskIDRealInstance._resumeValueChangeAction();
                    }
                }
            };
        
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceTaskID) {
                        InstanceTaskID.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceTaskID && InstanceTaskID.setCellInfo) {
                        InstanceTaskID.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceTaskID");
                    }
                },
        },
            
        {
            dataField: "IsOverdue",
            caption: "Trạng thái hạn",
            width: 150,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_IsOverdue"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
            if (!$("head").find("#hpa-inherit-font-style").length) $("head").append("<style id=\"hpa-inherit-font-style\">.dx-widget{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;border-radius:inherit!important}.dx-texteditor, .dx-texteditor-input{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;box-sizing:border-box!important;}</style>");
            const $containerIsOverdue = $(cellElement);

            let IsOverdueOriginalValue = "";
            let IsOverdueIsEditing   = false;
            let IsOverdueTextDisplay = null;
            let IsOverdueMouseDownInside = false;
            let _cancelingSaveIsOverdue = false;
            let _justSavedIsOverdue = false;
            let _savingIsOverdue = false;
            window.IsOverdueRealInstance = null;

            /* =============== Popup Save/Cancel =============== */
            let actionPopupIsOverdue     = null;
            let currentFieldIdIsOverdue  = null;
            let saveCallbackIsOverdue    = null;
            let cancelCallbackIsOverdue  = null;

            function initActionPopupIsOverdue() {
                if (actionPopupIsOverdue) return;
                actionPopupIsOverdue = $("<div>").appendTo("body").dxPopup({
                    width: "auto",
                    height: "auto",
                    showTitle: false,
                    visible: false,
                    shading: false,
                    dragEnabled: false,
                    hideOnOutsideClick: false,
                    animation: null,
                    showCloseButton: false,
                    position: { at: "bottom right", my: "top right", offset: "0 4" },
                    onShown: function(e) {
                        $(e.component.content()).closest(".dx-overlay-wrapper").css("z-index", "9999");
                    },
                    contentTemplate: () => {
                        return $("<div class=\"d-flex\" style=\"gap: 6px; padding: 6px; min-height: fit-content; display: flex; align-items: center; justify-content: center; \">").append(
                            $("<div>").dxButton({
                                icon: "check",
                                type: "success",
                                stylingMode: "contained",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _justSavedIsOverdue = true;
                                        _savingIsOverdue = true;
                                    });
                                },
                                onClick: async function() {
                                    if (saveCallbackIsOverdue) {
                                        await saveCallbackIsOverdue(true); // Pass true để báo từ button
                                    }

                                    actionPopupIsOverdue.hide();

                                    setTimeout(function(){
                                        _justSavedIsOverdue = false;
                                        _savingIsOverdue = false;
                                    }, 300);
                                }
                            }),
                            $("<div>").dxButton({
                                icon: "close",
                                stylingMode: "outlined",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _cancelingSaveIsOverdue = true;
                                    });
                                },
                                onClick: function() {
                                    if (cancelCallbackIsOverdue) {
                                        cancelCallbackIsOverdue();
                                    }

                                    actionPopupIsOverdue.hide();

                                    setTimeout(function(){
                                        _cancelingSaveIsOverdue = false;
                                    }, 300);
                                }
                            })
                        );
                    },
                    onHiding: function() {
                        currentFieldIdIsOverdue = saveCallbackIsOverdue = cancelCallbackIsOverdue = null;
                    }
                }).dxPopup("instance");
            }

            function showActionPopupIsOverdue(inputElement, fieldId, onSave, onCancel) {
                if (!actionPopupIsOverdue) initActionPopupIsOverdue();

                if (currentFieldIdIsOverdue && currentFieldIdIsOverdue !== fieldId && cancelCallbackIsOverdue) {
                    cancelCallbackIsOverdue();
                }

                currentFieldIdIsOverdue = fieldId;
                saveCallbackIsOverdue   = onSave;
                cancelCallbackIsOverdue = onCancel;

                const updatePos = () => {
                    if (!actionPopupIsOverdue?.option("visible")) return;
                    const $input = $(inputElement).find("input");
                    if ($input.length === 0) return;
                    actionPopupIsOverdue.option({
                        position: {
                            my: "top right",
                            at: "bottom right",
                            of: $input,
                            offset: "0 4"
                        }
                    });
                    actionPopupIsOverdue.repaint();
                };

                actionPopupIsOverdue.show();
                setTimeout(updatePos, 10);

                $(window).off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);
                $(window).off("resize.ap" + fieldId).on("resize.ap" + fieldId, updatePos);
                $(".dx-scrollable").off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);

                const intervalId = setInterval(() => {
                    if (actionPopupIsOverdue?.option("visible")) updatePos();
                    else clearInterval(intervalId);
                }, 100);

                actionPopupIsOverdue.option("onHiding", function() {
                    clearInterval(intervalId);
                    $(window).off("scroll.ap" + fieldId);
                    $(window).off("resize.ap" + fieldId);
                    $(".dx-scrollable").off("scroll.ap" + fieldId);
                    currentFieldIdIsOverdue = saveCallbackIsOverdue = cancelCallbackIsOverdue = null;
                });
            }

            /* =============== Inline Edit logic =============== */
            function exitEditIsOverdue(cancel = false) {
                if (!IsOverdueIsEditing) return;
                IsOverdueIsEditing = false;
                IsOverdueMouseDownInside = false;
                $(document).off("mousedown.editIsOverdue");
                $(document).off("mouseup.editIsOverdue");

                if (cancel) {
                    IsOverdueRealInstance.option("value", IsOverdueOriginalValue);
                } else {
                    IsOverdueOriginalValue = IsOverdueRealInstance.option("value");
                }

                if (actionPopupIsOverdue && actionPopupIsOverdue.option("visible")) {
                    actionPopupIsOverdue.option("visible", false);
                }

                $containerIsOverdue.find(".dx-texteditor").hide();
                IsOverdueTextDisplay.text(IsOverdueOriginalValue || "").show();
            }

            async function saveValueIsOverdue(fromButton = false) {
                if (_cancelingSaveIsOverdue) {
                    _cancelingSaveIsOverdue = false;
                    exitEditIsOverdue(true);
                    return;
                }

                // Chỉ check flag _saving khi KHÔNG phải từ button
                // Vì khi từ button thì flag đã được set ở mousedown
                if (!fromButton && _savingIsOverdue) {
                    return;
                }

                const newVal = IsOverdueRealInstance.option("value");

                if (newVal === IsOverdueOriginalValue) {
                    exitEditIsOverdue();
                    _savingIsOverdue = false;
                    _justSavedIsOverdue = false;
                    return;
                }

                try {
                    // Chỉ set flag nếu chưa được set (từ button đã set rồi)
                    if (!fromButton) {
                        _savingIsOverdue = true;
                    }

                    const dataJSON = JSON.stringify(["0", ["IsOverdue"], [newVal]]);

                    let currentRecordIDValue = [
                        currentRecordID_TaskID
                    ];

                    let currentRecordID = [
                        "TaskID"
                    ];

                    // chỉ nối khi ColumnIDName2 có thật
                    if ("" && "".trim() !== "") {
                        currentRecordIDValue.push(currentRecordID_);
                        currentRecordID.push("");
                    }

                    const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                    const json = await saveFunction(dataJSON, idValsJSON);

                    const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        _savingIsOverdue = false;
                        _justSavedIsOverdue = false;
                        return;
                    }

                    IsOverdueOriginalValue = newVal;
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                    }

                    exitEditIsOverdue();

                    if (cellInfo && cellInfo.component) {
                        try {
                            const grid = cellInfo.component;
                            const rowKey = cellInfo.key || cellInfo.data["TaskID"];

                            // Cập nhật cell value trong grid
                            grid.cellValue(cellInfo.rowIndex, "IsOverdue", newVal);

                            // Refresh cell để hiển thị giá trị mới
                            grid.repaint();

                        } catch (syncErr) {
                            console.warn("[Grid Sync] Không thể sync grid:", syncErr);
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                } finally {
                    setTimeout(function(){
                        _savingIsOverdue = false;
                        _justSavedIsOverdue = false;
                    }, 100);
                }
            }

            /* =============== Handle Click Outside =============== */
            function handleMouseDownIsOverdue(e) {
                if (!IsOverdueIsEditing) return;

                // Nếu đang save hoặc cancel thì không xử lý
                if (_savingIsOverdue || _cancelingSaveIsOverdue) return;

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerIsOverdue).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                if (isInsideControl || isInsidePopup) {
                    IsOverdueMouseDownInside = true;
                } else {
                    IsOverdueMouseDownInside = false;
                }
            }

            function handleMouseUpIsOverdue(e) {
                if (!IsOverdueIsEditing) return;

                // Nếu đang save, cancel hoặc vừa save xong thì không xử lý
                if (_savingIsOverdue || _cancelingSaveIsOverdue || _justSavedIsOverdue) {
                    IsOverdueMouseDownInside = false;
                    return;
                }

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerIsOverdue).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                // Chỉ save khi cả mousedown và mouseup đều ở ngoài
                if (!IsOverdueMouseDownInside && !isInsideControl && !isInsidePopup) {
                    saveValueIsOverdue();
                }

                IsOverdueMouseDownInside = false;
            }

            /* =============== Create UI =============== */
            IsOverdueTextDisplay = $("<div>").css({
                "padding": "1px 8px",
                "cursor": "text",
                "min-height": "20px",
                "line-height": "1.5",
                "word-break": "break-word",
                "border": "1px solid transparent",
                "border-radius": "inherit !important",
                "transition": "border-color 0.2s"
            }).appendTo($containerIsOverdue);

            // Hover effect
            IsOverdueTextDisplay.hover(
                function() {
                    if (!IsOverdueIsEditing) {
                        $(this).css("border-color", "#ddd");
                    }
                },
                function() {
                    if (!IsOverdueIsEditing) {
                        $(this).css("border-color", "transparent");
                    }
                }
            );

            IsOverdueTextDisplay.on("click", function() {
                if (IsOverdueIsEditing) return;
                IsOverdueIsEditing = true;
                IsOverdueMouseDownInside = false;
                IsOverdueOriginalValue = IsOverdueRealInstance.option("value");
                IsOverdueTextDisplay.hide();

                $containerIsOverdue.find(".dx-texteditor").show();

                const $input = $containerIsOverdue.find("input");
                setTimeout(() => {
                    $input.focus();
                    const len = $input.val().length;
                    $input[0].setSelectionRange(len, len);
                }, 10);

                $input.css({
                    "border-color": "#1c975e",
                    "padding": "1px 8px",
                    "max-height": "100%",
                    "cursor": "text",
                    "border-radius": "inherit !important",
                    "font-size": "inherit",
                    "font-weight": "inherit",
                    "box-sizing": "border-box"
                });

                showActionPopupIsOverdue(
                    $containerIsOverdue,
                    "IsOverdue",
                    async (fromButton) => { await saveValueIsOverdue(fromButton); },
                    () => exitEditIsOverdue(true)
                );

                // Bind events sau khi mở edit mode
                setTimeout(() => {
                    $(document).on("mousedown.editIsOverdue", handleMouseDownIsOverdue);
                    $(document).on("mouseup.editIsOverdue", handleMouseUpIsOverdue);
                }, 100);
            });

            window.IsOverdueRealInstance = $("<div>")
                .appendTo($containerIsOverdue)
                .dxTextBox({
                    value: "",
                    width: "100%",
                    inputAttr: { style: "max-height: 100%; line-height: 1.5; font-size: inherit; font-weight: inherit; padding: 1px 8px; box-sizing: border-box;" },
                    onKeyDown: function(e) {
                        if (!IsOverdueIsEditing) return;

                        if (e.event.key === "Enter") {
                            e.event.preventDefault();
                            // Cập nhật value từ input element trước khi save
                            const $input = $containerIsOverdue.find("input");
                            const currentValue = $input.val();
                            IsOverdueRealInstance.option("value", currentValue);
                            saveValueIsOverdue();
                        }

                        if (e.event.key === "Tab") {
                            e.event.preventDefault();
                            // Tab cũng lưu giống Enter
                            const $input = $containerIsOverdue.find("input");
                            const currentValue = $input.val();
                            IsOverdueRealInstance.option("value", currentValue);
                            saveValueIsOverdue();
                        }

                        if (e.event.key === "Escape") {
                            e.event.preventDefault();
                            exitEditIsOverdue(true);
                        }
                    },
                    onFocusOut: function(e) {
                        // Kiểm tra các flag để tránh save trùng
                        if (_cancelingSaveIsOverdue) {
                            _cancelingSaveIsOverdue = false;
                            return;
                        }
                        if (_justSavedIsOverdue) {
                            _justSavedIsOverdue = false;
                            return;
                        }
                        if (_savingIsOverdue) {
                            return;
                        }

                        // Auto-save khi mất focus
                        if (IsOverdueIsEditing) {
                            const $input = $containerIsOverdue.find("input");
                            if ($input.val() !== IsOverdueOriginalValue) {
                                const currentValue = $input.val();
                                IsOverdueRealInstance.option("value", currentValue);
                                saveValueIsOverdue();
                            } else {
                                exitEditIsOverdue(false);
                            }
                        }
                    }
                })
                .dxTextBox("instance");

            $containerIsOverdue.find(".dx-texteditor").hide();

            /* =============== Public API =============== */
            let InstanceIsOverdue = {
                setValue: function(val) {
                    IsOverdueOriginalValue = val || "";
                    IsOverdueRealInstance.option("value", val || "");
                    IsOverdueTextDisplay.text(val || "");
                },
                getValue: function() {
                    return IsOverdueRealInstance.option("value");
                },
                option: function(name, value) {
                    if (value !== undefined) {
                        IsOverdueRealInstance.option(name, value);
                        if (name === "value") {
                            IsOverdueOriginalValue = value || "";
                            IsOverdueTextDisplay.text(value || "");
                        }
                    } else {
                        return IsOverdueRealInstance.option(name);
                    }
                },
                repaint: function() {
                    IsOverdueRealInstance.repaint();
                },
                _suppressValueChangeAction: function() {
                    if (IsOverdueRealInstance._suppressValueChangeAction) {
                        IsOverdueRealInstance._suppressValueChangeAction();
                    }
                },
                _resumeValueChangeAction: function() {
                    if (IsOverdueRealInstance._resumeValueChangeAction) {
                        IsOverdueRealInstance._resumeValueChangeAction();
                    }
                }
            };
        
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceIsOverdue) {
                        InstanceIsOverdue.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceIsOverdue && InstanceIsOverdue.setCellInfo) {
                        InstanceIsOverdue.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceIsOverdue");
                    }
                },
        },
            
        {
            dataField: "EmployeeID",
            caption: "Người thực hiện",
            width: 220,
            allowSorting: true,
            allowFiltering: true,
            cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_EmployeeID"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
            window.GlobalEmployeeAvatarCache = window.GlobalEmployeeAvatarCache || {};
            window.GlobalEmployeeAvatarLoading = window.GlobalEmployeeAvatarLoading || {};

            function loadGlobalAvatarIfNeededEmployeeID(employeeId, storeImgName, paramImg, callbackFn) {
                const idStr = String(employeeId);

                if (window.GlobalEmployeeAvatarCache[idStr]) {
                    if (callbackFn) callbackFn(window.GlobalEmployeeAvatarCache[idStr]);
                    return window.GlobalEmployeeAvatarCache[idStr];
                }

                if (window.GlobalEmployeeAvatarLoading[idStr]) {
                    if (callbackFn) {
                        window.GlobalEmployeeAvatarLoading[idStr].callbacks = 
                            window.GlobalEmployeeAvatarLoading[idStr].callbacks || [];
                        window.GlobalEmployeeAvatarLoading[idStr].callbacks.push(callbackFn);
                    }
                    return null;
                }

                if (!storeImgName) {
                    return null;
                }

                window.GlobalEmployeeAvatarLoading[idStr] = {
                    loading: true,
                    callbacks: callbackFn ? [callbackFn] : []
                };

                let paramArray = [];
                if (paramImg) {
                    try {
                        const decoded = decodeURIComponent(paramImg);
                        paramArray = JSON.parse(decoded);
                    } catch (e) {
                        paramArray = [];
                    }
                }

                AjaxHPAParadise({
                    data: {
                        name: storeImgName,
                        param: paramArray
                    },
                    xhrFields: { responseType: "blob" },
                    cache: true,
                    success: function (blob) {
                        const callbacks = window.GlobalEmployeeAvatarLoading[idStr]?.callbacks || [];
                        delete window.GlobalEmployeeAvatarLoading[idStr];

                        if (blob && blob.size > 0) {
                            const url = URL.createObjectURL(blob);
                            window.GlobalEmployeeAvatarCache[idStr] = url;
                            
                            callbacks.forEach(cb => {
                                try { cb(url); } catch (e) { console.error(e); }
                            });
                        } else {
                            callbacks.forEach(cb => {
                                try { cb(null); } catch (e) { console.error(e); }
                            });
                        }
                    },
                    error: function () {
                        const callbacks = window.GlobalEmployeeAvatarLoading[idStr]?.callbacks || [];
                        delete window.GlobalEmployeeAvatarLoading[idStr];
                        
                        callbacks.forEach(cb => {
                            try { cb(null); } catch (e) { console.error(e); }
                        });
                    }
                });

                return null;
            }

            window["DataSource_EmployeeID"] = window["DataSource_EmployeeID"] || [];
            let EmployeeIDDataSourceLoaded = false;
            let spNameDSEEmployeeID = "";

            
            // Sử dụng hàm loadDataSourceCommon từ sptblCommonControlType_Signed
            if (spNameDSEEmployeeID && spNameDSEEmployeeID.trim() !== "") {
                loadDataSourceCommon("EmployeeID", spNameDSEEmployeeID, function(data) {
                    window["DataSource_EmployeeID"] = data || [];
                });
            }

            window.InstanceEmployeeID = {};
            let EmployeeIDSelectedIds = [], EmployeeIDSelectedIdsOriginal = [];
            let EmployeeIDIsSaving = false;
            const MAX_VISIBLE_EmployeeID = 3;

            function getInitialsEmployeeID(name) {
                if (!name) return "?";
                const words = name.trim().split(/\s+/);
                if (words.length >= 2) return (words[0][0] + words[words.length - 1][0]).toUpperCase();
                return name.substring(0, 2).toUpperCase();
            }

            function getColorForIdEmployeeID(id) {
                const colors = [
                    { bg: "#e3f2fd", text: "#1976d2" },
                    { bg: "#f3e5f5", text: "#7b1fa2" },
                    { bg: "#e8f5e9", text: "#388e3c" },
                    { bg: "#fff3e0", text: "#f57c00" },
                    { bg: "#fce4ec", text: "#c2185b" }
                ];
                return colors[Math.abs(id) % colors.length];
            }

            function renderDisplayBoxEmployeeID() {
                const $displayBoxEmployeeID = $("#EmployeeID_display");
                if (!$displayBoxEmployeeID.length) return;
                $displayBoxEmployeeID.empty();

                const $wrapper = $("<div>").css({
                    border: "1px solid #dee2e6",
                    borderRadius: "8px",
                    padding: "10px 12px",
                    minHeight: "44px",
                    display: "flex",
                    alignItems: "center",
                    cursor: "pointer"
                }).hover(
                    () => $wrapper.css({ borderColor: "#0d6efd", boxShadow: "0 0 0 0.2rem rgba(13,110,253,.15)" }),
                    () => $wrapper.css({ borderColor: "#dee2e6", boxShadow: "none" })
                );

                if (EmployeeIDSelectedIds.length === 0) {
                    $wrapper.append($("<span>").addClass("text-muted").html("<i class=\"bi bi-person-plus me-2\"></i>Chọn nhân viên..."));
                } else {
                    const displayIds = EmployeeIDSelectedIds.slice(0, MAX_VISIBLE_EmployeeID);
                    const $group = $("<div>").css({ display: "flex", alignItems: "center" });

                    displayIds.forEach((id, index) => {
                        const item = window["DataSource_EmployeeID"].find(e => String(e.ID) === String(id));
                        if (!item) return;

                        const $chip = $("<div>").css({
                            width: "36px", height: "36px", borderRadius: "50%",
                            border: "3px solid #fff",
                            boxShadow: "0 2px 6px rgba(0,0,0,0.15)",
                            marginLeft: index === 0 ? "0" : "-10px",
                            zIndex: MAX_VISIBLE_EmployeeID - index,
                            display: "flex", alignItems: "center", justifyContent: "center",
                            fontWeight: "600", fontSize: "13px",
                            position: "relative", overflow: "hidden"
                        }).attr("title", item.Name || item.FullName || "");

                        const cachedUrl = window.GlobalEmployeeAvatarCache[String(id)];

                        if (cachedUrl) {
                            $chip.append($("<img>")
                                .attr("src", cachedUrl)
                                .css({ width: "100%", height: "100%", objectFit: "cover" })
                            );
                        } else if (item.storeImgName) {
                            loadGlobalAvatarIfNeededEmployeeID(id, item.storeImgName, item.paramImg, function(url) {
                                renderDisplayBoxEmployeeID();
                            });
                            
                            const color = getColorForIdEmployeeID(id);
                            const initials = getInitialsEmployeeID(item.Name || item.FullName);
                            $chip.css({ background: color.bg, color: color.text }).text(initials);
                        } else {
                            const color = getColorForIdEmployeeID(id);
                            const initials = getInitialsEmployeeID(item.Name || item.FullName);
                            $chip.css({ background: color.bg, color: color.text }).text(initials);
                        }

                        $group.append($chip);
                    });

                    if (EmployeeIDSelectedIds.length > MAX_VISIBLE_EmployeeID) {
                        const remaining = EmployeeIDSelectedIds.length - MAX_VISIBLE_EmployeeID;
                        $group.append($("<div>").css({
                            width: "36px", height: "36px", borderRadius: "50%",
                            border: "3px solid #fff", marginLeft: "-10px",
                            display: "flex", alignItems: "center", justifyContent: "center",
                            fontWeight: "700", fontSize: "12px"
                        }).text("+" + remaining).attr("title", "Còn " + remaining + " người nữa"));
                    }

                    $wrapper.append($group);
                }

                $displayBoxEmployeeID.append($wrapper);
                $wrapper.off("click").on("click", () => {
                    if (!popupEmployeeID) {
                        initPopupEmployeeID();
                        // Đợi popup init xong rồi mới show
                        setTimeout(() => {
                            popupEmployeeID.show();
                        }, 0);
                    } else {
                        popupEmployeeID.show();
                    }
                });
            }

            const $containerEmployeeID = $(cellElement);
            $containerEmployeeID.empty();
            const $displayBoxEmployeeID = $("<div>").attr("id", "EmployeeID_display");
            $containerEmployeeID.append($displayBoxEmployeeID);

            let popupEmployeeID;
            let popupEmployeeIDOnce = false;
            let EmployeeIDGridContainer = null;
            function initPopupEmployeeID() {
                if (popupEmployeeIDOnce) {
                    popupEmployeeID.show();
                    return;
                }
                popupEmployeeIDOnce = true;
                popupEmployeeID = $("<div>").attr("id", "EmployeeID_popup")
                    .appendTo(document.body)
                    .addClass("hpa-responsive")
                    .dxPopup({
                        width: 750,
                        height: "auto",
                        animation: null,
                        showTitle: true,
                        title: "Chọn nhân viên",
                        dragEnabled: true,
                        closeOnOutsideClick: true,
                        showCloseButton: true,
                        toolbarItems: [
                            {
                                widget: "dxButton",
                                location: "after",
                                toolbar: "bottom",
                                options: {
                                    text: "Hủy",
                                    onClick: () => {
                                        popupEmployeeID._isCancelling = true;
                                        EmployeeIDSelectedIds = [...EmployeeIDSelectedIdsOriginal];
                                        popupEmployeeID.hide();
                                    }
                                }
                            },
                            {
                                widget: "dxButton",
                                location: "after",
                                toolbar: "bottom",
                                options: {
                                    text: "Lưu",
                                    type: "success",
                                    onClick: async () => {
                                        await saveValueEmployeeID();
                                        popupEmployeeID.hide();
                                    }
                                }
                            }
                        ],
                        contentTemplate: function (contentElement) {
                            EmployeeIDGridContainer = $("<div>");
                            contentElement.append(EmployeeIDGridContainer);
                        },
                        onShown: () => {
                            setTimeout(() => {
                                const $popupContent = $("#EmployeeID_popup").closest(".dx-popup-wrapper");
                                $popupContent.off("mousedown.preventClose").on("mousedown.preventClose", function(e) {
                                    console.log("Preventing popup close on outside click");
                                    e.stopPropagation();
                                });
                            }, 100);

                            const sortedData = window["DataSource_EmployeeID"].sort((a, b) => {
                                const aSelected = EmployeeIDSelectedIds.includes(String(a.ID));
                                const bSelected = EmployeeIDSelectedIds.includes(String(b.ID));
                                return bSelected - aSelected;
                            });

                            try {
                                const existingInstance = EmployeeIDGridContainer.dxDataGrid("instance");
                                if (existingInstance) {
                                    existingInstance.dispose();
                                }
                            } catch (e) {
                                // Instance chưa tồn tại hoặc đã bị destroy
                            }

                            EmployeeIDGridContainer
                            .empty()
                            .dxDataGrid({
                                dataSource: sortedData,
                                keyExpr: "ID",
                                remoteOperations: false,
                                columnAutoWidth: true,
                                allowColumnResizing: true,
                                selection: { mode: "multiple", showCheckBoxesMode: "always" },
                                selectedRowKeys: EmployeeIDSelectedIds,
                                columns: [
                                    {
                                        caption: "Ảnh",
                                        width: 80,
                                        alignment: "center",
                                        cellTemplate: function(container, options) {
                                            const item = options.data;
                                            const $cell = $("<div>").css({
                                                display: "flex",
                                                justifyContent: "center",
                                                alignItems: "center",
                                                height: "100%"
                                            });

                                            const cachedUrl = window.GlobalEmployeeAvatarCache[String(item.ID)];

                                            if (cachedUrl) {
                                                $cell.append($("<img>")
                                                    .attr("src", cachedUrl)
                                                    .css({
                                                        width: "40px",
                                                        height: "40px",
                                                        borderRadius: "50%",
                                                        objectFit: "cover",
                                                        border: "2px solid #fff",
                                                        boxShadow: "0 2px 4px rgba(0,0,0,0.1)"
                                                    })
                                                );
                                            } else if (item.storeImgName) {
                                                loadGlobalAvatarIfNeededEmployeeID(item.ID, item.storeImgName, item.paramImg, function(url) {
                                                    EmployeeIDGridContainer.dxDataGrid("instance").refresh();
                                                });
                                                
                                                const initials = getInitialsEmployeeID(item.Name || item.FullName || "?");
                                                const color = getColorForIdEmployeeID(item.ID);
                                                $cell.append($("<div>")
                                                    .text(initials)
                                                    .css({
                                                        width: "40px",
                                                        height: "40px",
                                                        borderRadius: "50%",
                                                        background: color.bg,
                                                        color: color.text,
                                                        display: "flex",
                                                        justifyContent: "center",
                                                        alignItems: "center",
                                                        fontWeight: "600",
                                                        fontSize: "14px",
                                                        boxShadow: "0 2px 4px rgba(0,0,0,0.1)"
                                                    })
                                                );
                                            } else {
                                                const initials = getInitialsEmployeeID(item.Name || item.FullName || "?");
                                                const color = getColorForIdEmployeeID(item.ID);
                                                $cell.append($("<div>")
                                                    .text(initials)
                                                    .css({
                                                        width: "40px",
                                                        height: "40px",
                                                        borderRadius: "50%",
                                                        background: color.bg,
                                                        color: color.text,
                                                        display: "flex",
                                                        justifyContent: "center",
                                                        alignItems: "center",
                                                        fontWeight: "600",
                                                        fontSize: "14px",
                                                        boxShadow: "0 2px 4px rgba(0,0,0,0.1)"
                                                    })
                                                );
                                            }

                                            container.append($cell);
                                        }
                                    },
                                    { dataField: "Name", caption: "Họ tên" },
                                    { dataField: "Email", caption: "Email" },
                                    { dataField: "Position", caption: "Chức vụ" }
                                ],
                                searchPanel: { visible: true },
                                paging: { 
                                    enabled: true,
                                    pageSize: 5,
                                    pageIndex: 0
                                },
                                pager: {
                                    visible: true,
                                    allowedPageSizes: [5, 10],
                                    showPageSizeSelector: true,
                                    showInfo: true,
                                    showNavigationButtons: true
                                },
                                onSelectionChanged: e => EmployeeIDSelectedIds = e.selectedRowKeys || []
                            });
                        },
                        onHidden: () => {
                            const $popupContent = $("#EmployeeID_popup").closest(".dx-popup-wrapper");
                            $popupContent.off("mousedown.preventClose");
                            
                            // Dispose grid instance
                            try {
                                const gridInstance = EmployeeIDGridContainer.dxDataGrid("instance");
                                if (gridInstance) {
                                    gridInstance.dispose();
                                }
                            } catch (e) {
                                // Grid chưa được khởi tạo hoặc đã dispose
                            }
                            
                            // Reset position của popup về default
                            popupEmployeeID.option("position", { my: "center", at: "center", of: window });
                            
                            renderDisplayBoxEmployeeID();
                        }
                    }).dxPopup("instance");
                
                // Tự động save khi đóng popup (trừ khi bấm Hủy)
                popupEmployeeID.on("hiding", async function(e) {
                    // Skip nếu đang lưu hoặc đã hủy
                    if (EmployeeIDIsSaving || e.component._isCancelling) {
                        delete e.component._isCancelling;
                        return;
                    }
                    
                    const original = EmployeeIDSelectedIdsOriginal.slice().sort().join(",");
                    const current = EmployeeIDSelectedIds.slice().sort().join(",");
                    
                    if (original !== current) {
                        e.cancel = true;
                        await saveValueEmployeeID();
                        e.component.hide();
                    }
                });
            }

            async function saveValueEmployeeID() {
                const original = EmployeeIDSelectedIdsOriginal.slice().sort().join(",");
                const current = EmployeeIDSelectedIds.slice().sort().join(",");
                if (original === current || EmployeeIDIsSaving) return;

                EmployeeIDIsSaving = true;
                try {
                    const newValue = EmployeeIDSelectedIds.join(",");
                    const dataJSON = JSON.stringify(["-1518142557", ["EmployeeID"], [newValue || null]]);

                    let idValues = [currentRecordID_HistoryID];
                    let idFields = ["HistoryID"];
                    if ("" && "".trim() !== "") {
                        idValues.push(currentRecordID_);
                        idFields.push("");
                    }
                    const idValsJSON = JSON.stringify([idValues, idFields]);

                    const json = await saveFunction(dataJSON, idValsJSON);
                    const errors = json.data?.[json.data.length - 1] || [];
                    if (errors.length > 0 && errors[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: errors[0].Message || "Lưu thất bại" });
                        }
                        return;
                    }

                    // SYNC GRID: Cập nhật lại giá trị trong Grid sau khi save thành công
                    if (EmployeeIDCellInfo && EmployeeIDCellInfo.component) {
                        try {
                            const grid = EmployeeIDCellInfo.component;
                            const rowKey = EmployeeIDCellInfo.key || EmployeeIDCellInfo.data["HistoryID"];
                            
                            // Cập nhật cell value trong grid
                            grid.cellValue(EmployeeIDCellInfo.rowIndex, "EmployeeID", newValue);
                            
                            // Refresh cell để hiển thị giá trị mới
                            grid.repaint();

                            console.log("[Grid Sync] SelectBox EmployeeID: Updated value =", newValue, "for row", rowKey);
                        } catch (syncErr) {
                            console.warn("[Grid Sync] SelectBox EmployeeID: Không thể sync grid:", syncErr);
                        }
                    }

                    EmployeeIDSelectedIdsOriginal = [...EmployeeIDSelectedIds];
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                    }
                    renderDisplayBoxEmployeeID();
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi khi lưu" });
                    }
                }
            }

            window.InstanceEmployeeID = {
                setValue: function(val) {
                    if (typeof val === "string" && val.trim()) {
                        EmployeeIDSelectedIds = val.split(",").map(v => v.trim()).filter(v => v);
                    } else if (Array.isArray(val)) {
                        EmployeeIDSelectedIds = val.map(String);
                    } else {
                        EmployeeIDSelectedIds = [];
                    }
                    EmployeeIDSelectedIdsOriginal = [...EmployeeIDSelectedIds];
                    renderDisplayBoxEmployeeID();
                },
                getValue: () => EmployeeIDSelectedIds,
                getValueAsString: () => EmployeeIDSelectedIds.join(","),
                setDataSource: data => {
                    window["DataSource_EmployeeID"] = data || [];
                },
                repaint: renderDisplayBoxEmployeeID,
                option: function(name, value) {
                    if (arguments.length === 2 && name === "value") {
                        this.setValue(value);
                    } else if (arguments.length === 1) {
                        if (name === "value") return this.getValueAsString();
                        if (name === "dataSource") return window["DataSource_EmployeeID"];
                    }
                    return undefined;
                },
                _suppressValueChangeAction: function() {},
                _resumeValueChangeAction: function() {}
            };

            renderDisplayBoxEmployeeID();
        
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceEmployeeID) {
                        InstanceEmployeeID.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceEmployeeID && InstanceEmployeeID.setCellInfo) {
                        InstanceEmployeeID.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceEmployeeID");
                    }
                },
        },
            
        {
            dataField: "ParentTaskID",
            caption: "ID Task cha",
            width: 150,
            allowSorting: true,
            allowFiltering: true,
            groupIndex: 0, cellTemplate: function(container, cellInfo){
                const val = cellInfo.value;

                if (val === undefined || val === null || val === "") {
                    $("<div>").addClass("dx-placeholder").text("--").appendTo(container);
                    return;
                }

                const ds = window["DataSource_ParentTaskID"];
                if (ds && Array.isArray(ds)) {
                    const f = ds.find(x => x.id == val || x.ID == val);
                    if (f) {
            $("<div>").text(f.Text || f.Name || "").appendTo(container);
                        return;
                    }
                }

                $("<div>").text(cellInfo.displayValue ?? val).appendTo(container);
            },allowEditing: true,
                editCellTemplate: function(cellElement, cellInfo) {
                    if (cellInfo.key !== undefined && cellInfo.key !== null) {
                        currentRecordID_TaskID = cellInfo.key;
                        console.log(currentRecordID_TaskID)
                    } else if (cellInfo.data && cellInfo.data["TaskID"] !== undefined) {
                        currentRecordID_TaskID = cellInfo.data["TaskID"];
                        console.log(currentRecordID_TaskID)
                    }

                
            if (!$("head").find("#hpa-inherit-font-style").length) $("head").append("<style id=\"hpa-inherit-font-style\">.dx-widget{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;border-radius:inherit!important}.dx-texteditor, .dx-texteditor-input{font-size:inherit!important;font-weight:inherit!important;line-height:inherit!important;box-sizing:border-box!important;}</style>");
            const $containerParentTaskID = $(cellElement);

            let ParentTaskIDOriginalValue = "";
            let ParentTaskIDIsEditing   = false;
            let ParentTaskIDTextDisplay = null;
            let ParentTaskIDMouseDownInside = false;
            let _cancelingSaveParentTaskID = false;
            let _justSavedParentTaskID = false;
            let _savingParentTaskID = false;
            window.ParentTaskIDRealInstance = null;

            /* =============== Popup Save/Cancel =============== */
            let actionPopupParentTaskID     = null;
            let currentFieldIdParentTaskID  = null;
            let saveCallbackParentTaskID    = null;
            let cancelCallbackParentTaskID  = null;

            function initActionPopupParentTaskID() {
                if (actionPopupParentTaskID) return;
                actionPopupParentTaskID = $("<div>").appendTo("body").dxPopup({
                    width: "auto",
                    height: "auto",
                    showTitle: false,
                    visible: false,
                    shading: false,
                    dragEnabled: false,
                    hideOnOutsideClick: false,
                    animation: null,
                    showCloseButton: false,
                    position: { at: "bottom right", my: "top right", offset: "0 4" },
                    onShown: function(e) {
                        $(e.component.content()).closest(".dx-overlay-wrapper").css("z-index", "9999");
                    },
                    contentTemplate: () => {
                        return $("<div class=\"d-flex\" style=\"gap: 6px; padding: 6px; min-height: fit-content; display: flex; align-items: center; justify-content: center; \">").append(
                            $("<div>").dxButton({
                                icon: "check",
                                type: "success",
                                stylingMode: "contained",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _justSavedParentTaskID = true;
                                        _savingParentTaskID = true;
                                    });
                                },
                                onClick: async function() {
                                    if (saveCallbackParentTaskID) {
                                        await saveCallbackParentTaskID(true); // Pass true để báo từ button
                                    }

                                    actionPopupParentTaskID.hide();

                                    setTimeout(function(){
                                        _justSavedParentTaskID = false;
                                        _savingParentTaskID = false;
                                    }, 300);
                                }
                            }),
                            $("<div>").dxButton({
                                icon: "close",
                                stylingMode: "outlined",
                                width: 32, height: 32,
                                elementAttr: { style: "border-radius: 4px !important;" },
                                onInitialized: function(e) {
                                    // Bind mousedown để set flag sớm hơn onFocusOut
                                    $(e.element).on("mousedown", function() {
                                        _cancelingSaveParentTaskID = true;
                                    });
                                },
                                onClick: function() {
                                    if (cancelCallbackParentTaskID) {
                                        cancelCallbackParentTaskID();
                                    }

                                    actionPopupParentTaskID.hide();

                                    setTimeout(function(){
                                        _cancelingSaveParentTaskID = false;
                                    }, 300);
                                }
                            })
                        );
                    },
                    onHiding: function() {
                        currentFieldIdParentTaskID = saveCallbackParentTaskID = cancelCallbackParentTaskID = null;
                    }
                }).dxPopup("instance");
            }

            function showActionPopupParentTaskID(inputElement, fieldId, onSave, onCancel) {
                if (!actionPopupParentTaskID) initActionPopupParentTaskID();

                if (currentFieldIdParentTaskID && currentFieldIdParentTaskID !== fieldId && cancelCallbackParentTaskID) {
                    cancelCallbackParentTaskID();
                }

                currentFieldIdParentTaskID = fieldId;
                saveCallbackParentTaskID   = onSave;
                cancelCallbackParentTaskID = onCancel;

                const updatePos = () => {
                    if (!actionPopupParentTaskID?.option("visible")) return;
                    const $input = $(inputElement).find("input");
                    if ($input.length === 0) return;
                    actionPopupParentTaskID.option({
                        position: {
                            my: "top right",
                            at: "bottom right",
                            of: $input,
                            offset: "0 4"
                        }
                    });
                    actionPopupParentTaskID.repaint();
                };

                actionPopupParentTaskID.show();
                setTimeout(updatePos, 10);

                $(window).off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);
                $(window).off("resize.ap" + fieldId).on("resize.ap" + fieldId, updatePos);
                $(".dx-scrollable").off("scroll.ap" + fieldId).on("scroll.ap" + fieldId, updatePos);

                const intervalId = setInterval(() => {
                    if (actionPopupParentTaskID?.option("visible")) updatePos();
                    else clearInterval(intervalId);
                }, 100);

                actionPopupParentTaskID.option("onHiding", function() {
                    clearInterval(intervalId);
                    $(window).off("scroll.ap" + fieldId);
                    $(window).off("resize.ap" + fieldId);
                    $(".dx-scrollable").off("scroll.ap" + fieldId);
                    currentFieldIdParentTaskID = saveCallbackParentTaskID = cancelCallbackParentTaskID = null;
                });
            }

            /* =============== Inline Edit logic =============== */
            function exitEditParentTaskID(cancel = false) {
                if (!ParentTaskIDIsEditing) return;
                ParentTaskIDIsEditing = false;
                ParentTaskIDMouseDownInside = false;
                $(document).off("mousedown.editParentTaskID");
                $(document).off("mouseup.editParentTaskID");

                if (cancel) {
                    ParentTaskIDRealInstance.option("value", ParentTaskIDOriginalValue);
                } else {
                    ParentTaskIDOriginalValue = ParentTaskIDRealInstance.option("value");
                }

                if (actionPopupParentTaskID && actionPopupParentTaskID.option("visible")) {
                    actionPopupParentTaskID.option("visible", false);
                }

                $containerParentTaskID.find(".dx-texteditor").hide();
                ParentTaskIDTextDisplay.text(ParentTaskIDOriginalValue || "").show();
            }

            async function saveValueParentTaskID(fromButton = false) {
                if (_cancelingSaveParentTaskID) {
                    _cancelingSaveParentTaskID = false;
                    exitEditParentTaskID(true);
                    return;
                }

                // Chỉ check flag _saving khi KHÔNG phải từ button
                // Vì khi từ button thì flag đã được set ở mousedown
                if (!fromButton && _savingParentTaskID) {
                    return;
                }

                const newVal = ParentTaskIDRealInstance.option("value");

                if (newVal === ParentTaskIDOriginalValue) {
                    exitEditParentTaskID();
                    _savingParentTaskID = false;
                    _justSavedParentTaskID = false;
                    return;
                }

                try {
                    // Chỉ set flag nếu chưa được set (từ button đã set rồi)
                    if (!fromButton) {
                        _savingParentTaskID = true;
                    }

                    const dataJSON = JSON.stringify(["0", ["ParentTaskID"], [newVal]]);

                    let currentRecordIDValue = [
                        currentRecordID_TaskID
                    ];

                    let currentRecordID = [
                        "TaskID"
                    ];

                    // chỉ nối khi ColumnIDName2 có thật
                    if ("" && "".trim() !== "") {
                        currentRecordIDValue.push(currentRecordID_);
                        currentRecordID.push("");
                    }

                    const idValsJSON = JSON.stringify([currentRecordIDValue, currentRecordID]);

                    const json = await saveFunction(dataJSON, idValsJSON);

                    const dtError = json.data[json.data.length - 1] || [];
                    if (dtError.length > 0 && dtError[0].Status === "ERROR") {
                        if ("0" === "1") {
                            uiManager.showAlert({ type: "error", message: dtError[0]?.Message || "Lưu thất bại" });
                        }
                        _savingParentTaskID = false;
                        _justSavedParentTaskID = false;
                        return;
                    }

                    ParentTaskIDOriginalValue = newVal;
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "success", message: "Lưu thành công" });
                    }

                    exitEditParentTaskID();

                    if (cellInfo && cellInfo.component) {
                        try {
                            const grid = cellInfo.component;
                            const rowKey = cellInfo.key || cellInfo.data["TaskID"];

                            // Cập nhật cell value trong grid
                            grid.cellValue(cellInfo.rowIndex, "ParentTaskID", newVal);

                            // Refresh cell để hiển thị giá trị mới
                            grid.repaint();

                        } catch (syncErr) {
                            console.warn("[Grid Sync] Không thể sync grid:", syncErr);
                        }
                    }
                } catch (err) {
                    if ("0" === "1") {
                        uiManager.showAlert({ type: "error", message: "Có lỗi xảy ra khi lưu" });
                    }
                } finally {
                    setTimeout(function(){
                        _savingParentTaskID = false;
                        _justSavedParentTaskID = false;
                    }, 100);
                }
            }

            /* =============== Handle Click Outside =============== */
            function handleMouseDownParentTaskID(e) {
                if (!ParentTaskIDIsEditing) return;

                // Nếu đang save hoặc cancel thì không xử lý
                if (_savingParentTaskID || _cancelingSaveParentTaskID) return;

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerParentTaskID).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                if (isInsideControl || isInsidePopup) {
                    ParentTaskIDMouseDownInside = true;
                } else {
                    ParentTaskIDMouseDownInside = false;
                }
            }

            function handleMouseUpParentTaskID(e) {
                if (!ParentTaskIDIsEditing) return;

                // Nếu đang save, cancel hoặc vừa save xong thì không xử lý
                if (_savingParentTaskID || _cancelingSaveParentTaskID || _justSavedParentTaskID) {
                    ParentTaskIDMouseDownInside = false;
                    return;
                }

                const $t = $(e.target);
                const isInsideControl = $t.closest($containerParentTaskID).length > 0;
                const isInsidePopup = $t.closest(".dx-popup-wrapper").length > 0;

                // Chỉ save khi cả mousedown và mouseup đều ở ngoài
                if (!ParentTaskIDMouseDownInside && !isInsideControl && !isInsidePopup) {
                    saveValueParentTaskID();
                }

                ParentTaskIDMouseDownInside = false;
            }

            /* =============== Create UI =============== */
            ParentTaskIDTextDisplay = $("<div>").css({
                "padding": "1px 8px",
                "cursor": "text",
                "min-height": "20px",
                "line-height": "1.5",
                "word-break": "break-word",
                "border": "1px solid transparent",
                "border-radius": "inherit !important",
                "transition": "border-color 0.2s"
            }).appendTo($containerParentTaskID);

            // Hover effect
            ParentTaskIDTextDisplay.hover(
                function() {
                    if (!ParentTaskIDIsEditing) {
                        $(this).css("border-color", "#ddd");
                    }
                },
                function() {
                    if (!ParentTaskIDIsEditing) {
                        $(this).css("border-color", "transparent");
                    }
                }
            );

            ParentTaskIDTextDisplay.on("click", function() {
                if (ParentTaskIDIsEditing) return;
                ParentTaskIDIsEditing = true;
                ParentTaskIDMouseDownInside = false;
                ParentTaskIDOriginalValue = ParentTaskIDRealInstance.option("value");
                ParentTaskIDTextDisplay.hide();

                $containerParentTaskID.find(".dx-texteditor").show();

                const $input = $containerParentTaskID.find("input");
                setTimeout(() => {
                    $input.focus();
                    const len = $input.val().length;
                    $input[0].setSelectionRange(len, len);
                }, 10);

                $input.css({
                    "border-color": "#1c975e",
                    "padding": "1px 8px",
                    "max-height": "100%",
                    "cursor": "text",
                    "border-radius": "inherit !important",
                    "font-size": "inherit",
                    "font-weight": "inherit",
                    "box-sizing": "border-box"
                });

                showActionPopupParentTaskID(
                    $containerParentTaskID,
                    "ParentTaskID",
                    async (fromButton) => { await saveValueParentTaskID(fromButton); },
                    () => exitEditParentTaskID(true)
                );

                // Bind events sau khi mở edit mode
                setTimeout(() => {
                    $(document).on("mousedown.editParentTaskID", handleMouseDownParentTaskID);
                    $(document).on("mouseup.editParentTaskID", handleMouseUpParentTaskID);
                }, 100);
            });

            window.ParentTaskIDRealInstance = $("<div>")
                .appendTo($containerParentTaskID)
                .dxTextBox({
                    value: "",
                    width: "100%",
                    inputAttr: { style: "max-height: 100%; line-height: 1.5; font-size: inherit; font-weight: inherit; padding: 1px 8px; box-sizing: border-box;" },
                    onKeyDown: function(e) {
                        if (!ParentTaskIDIsEditing) return;

                        if (e.event.key === "Enter") {
                            e.event.preventDefault();
                            // Cập nhật value từ input element trước khi save
                            const $input = $containerParentTaskID.find("input");
                            const currentValue = $input.val();
                            ParentTaskIDRealInstance.option("value", currentValue);
                            saveValueParentTaskID();
                        }

                        if (e.event.key === "Tab") {
                            e.event.preventDefault();
                            // Tab cũng lưu giống Enter
                            const $input = $containerParentTaskID.find("input");
                            const currentValue = $input.val();
                            ParentTaskIDRealInstance.option("value", currentValue);
                            saveValueParentTaskID();
                        }

                        if (e.event.key === "Escape") {
                            e.event.preventDefault();
                            exitEditParentTaskID(true);
                        }
                    },
                    onFocusOut: function(e) {
                        // Kiểm tra các flag để tránh save trùng
                        if (_cancelingSaveParentTaskID) {
                            _cancelingSaveParentTaskID = false;
                            return;
                        }
                        if (_justSavedParentTaskID) {
                            _justSavedParentTaskID = false;
                            return;
                        }
                        if (_savingParentTaskID) {
                            return;
                        }

                        // Auto-save khi mất focus
                        if (ParentTaskIDIsEditing) {
                            const $input = $containerParentTaskID.find("input");
                            if ($input.val() !== ParentTaskIDOriginalValue) {
                                const currentValue = $input.val();
                                ParentTaskIDRealInstance.option("value", currentValue);
                                saveValueParentTaskID();
                            } else {
                                exitEditParentTaskID(false);
                            }
                        }
                    }
                })
                .dxTextBox("instance");

            $containerParentTaskID.find(".dx-texteditor").hide();

            /* =============== Public API =============== */
            let InstanceParentTaskID = {
                setValue: function(val) {
                    ParentTaskIDOriginalValue = val || "";
                    ParentTaskIDRealInstance.option("value", val || "");
                    ParentTaskIDTextDisplay.text(val || "");
                },
                getValue: function() {
                    return ParentTaskIDRealInstance.option("value");
                },
                option: function(name, value) {
                    if (value !== undefined) {
                        ParentTaskIDRealInstance.option(name, value);
                        if (name === "value") {
                            ParentTaskIDOriginalValue = value || "";
                            ParentTaskIDTextDisplay.text(value || "");
                        }
                    } else {
                        return ParentTaskIDRealInstance.option(name);
                    }
                },
                repaint: function() {
                    ParentTaskIDRealInstance.repaint();
                },
                _suppressValueChangeAction: function() {
                    if (ParentTaskIDRealInstance._suppressValueChangeAction) {
                        ParentTaskIDRealInstance._suppressValueChangeAction();
                    }
                },
                _resumeValueChangeAction: function() {
                    if (ParentTaskIDRealInstance._resumeValueChangeAction) {
                        ParentTaskIDRealInstance._resumeValueChangeAction();
                    }
                }
            };
        
                    // Set initial value
                    if (cellInfo.value !== undefined && cellInfo.value !== null && InstanceParentTaskID) {
                        InstanceParentTaskID.option("value", cellInfo.value);
                    }

                    // TRUYỀN cellInfo vào control để sync Grid sau khi save
                    if (InstanceParentTaskID && InstanceParentTaskID.setCellInfo) {
                        InstanceParentTaskID.setCellInfo(cellInfo);
                        console.log("[Grid Edit] Passed cellInfo to InstanceParentTaskID");
                    }
                },
        },
],

                        onCellClick: function(e) {
                            // Nếu multiSelect + isPopupDetailGrid, chỉ drag icon mới mở detail
                            if (0 === 0 && 0 === 0) {
                                // Không làm gì - chỉ cho drag
                                return;
                            } 
                            // Nếu isPopupDetailGrid, click bất kỳ dòng nào cũng mở detail
                            else if (0 === 1 && 0 === 0) {
                                const recordID = e.key || (e.data && e.data["TaskID"]);
                                if (recordID !== undefined && recordID !== null && recordID !== "") {
                                    if (typeof openDetailTaskID === "function") {
                                        console.log("[Grid Detail Popup] Mở detail từ dòng - recordID:", recordID);
                                        openDetailTaskID(recordID);
                                    }
                                }
                            } 
                            // Nếu không phải popup detail, chỉ click cột đầu (index 0) thì mở detail
                            else if (e.columnIndex === 0) {
                                const recordID = e.key || (e.data && e.data["TaskID"]);
                                console.log("[Grid Detail] Click mã - recordID:", recordID);
                                if (recordID !== undefined && recordID !== null && recordID !== "") {
                                    if (typeof openDetailTaskID === "function") {
                                        console.log("[Grid Detail] Mở detail bằng hàm openDetailTaskID");
                                        openDetailTaskID(recordID);
                                    }
                                }
                            }
                        },

                        onRowPrepared: function(e) {
                            if (e.rowType === "data") {
                                // Nếu multiSelect + isPopupDetailGrid, chỉ drag icon clickable
                                if (0 === 1 && 0 === 1) {
                                    // Không highlight hover - chỉ cho drag
                                    return;
                                }
                                // Nếu isPopupDetailGrid, toàn dòng là clickable
                                else if (0 === 1 || 0 === true) {
                                    e.rowElement.css({
                                        cursor: "pointer"
                                    }).hover(
                                        function() { $(this).css({ backgroundColor: "rgba(0, 0, 0, 0.04)" }); },
                                        function() { $(this).css({ backgroundColor: "" }); }
                                    );
                                } else {
                                    // Chỉ cột đầu là clickable
                                    const $firstCell = e.rowElement.find("td:first");
                                    if ($firstCell.length) {
                                        $firstCell.css({
                                            cursor: "pointer",
                                            color: "#1976d2",
                                            textDecoration: "none",
                                            fontWeight: "500"
                                        }).hover(
                                            function() { $(this).css({ textDecoration: "underline" }); },
                                            function() { $(this).css({ textDecoration: "none" }); }
                                        );
                                    }
                                }
                            }
                        },

                        onToolbarPreparing: function(e) {
                            let isReloading = false;
                            
                            e.toolbarOptions.items.unshift({
                                location: "after",
                                widget: "dxButton",
                                options: {
                                    icon: "refresh",
                                    hint: "Tải lại",
                                    onClick: function() {
                                        if (isReloading) {
                                            console.log("[Grid] Đang reload, vui lòng đợi...");
                                            return;
                                        }
                                        
                                        isReloading = true;
                                        this.option("disabled", true);
                                        
                                        ReloadData();
                                        
                                        setTimeout(() => {
                                            isReloading = false;
                                            this.option("disabled", false);
                                        }, 1000);
                                    }
                                }
                            });
                        }
                    }).dxDataGrid("instance");
                
</script>
<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>hpaControlEmployeeSelector - AutoSave Type 1</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            body {
                padding: 40px;
                background: #e3f2fd;
                font-family: system-ui, sans-serif;
            }
            h2 {
                color: #01579b;
            }
            .table {
                table-layout: fixed;
                width: 100%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            pre {
                background: #fff;
                border: 1px solid #bbdefb;
                border-radius: 8px;
            }
            :root {
                --border-color: #e6edf3;
                --task-primary: #01579b;
            }
            th.col-id {
                width: 80px;
            }
            th.col-emp {
                width: calc(100% - 80px);
            }
        </style>
    </head>
    <body>
        <h2 class="mb-4">hpaControlEmployeeSelector - Có AutoSave - Type 1 (Static + Search Local)</h2>
        <p>Multi select • Avatar • Chip đẹp • Tạo mới • Lưu ngay vào mảng</p>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-primary">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-emp">Nhân viên</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>

        <div class="mt-5">
            <h5>Dữ liệu mẫu hiện tại:</h5>
            <pre id="dataPreview" class="p-3 rounded shadow-sm"></pre>
        </div>

        <script>
            // DỮ LIỆU MẪU
            let records = [
                { TaskID: 1, Employees: ['1', '4'] },
                { TaskID: 2, Employees: [] },
                { TaskID: 3, Employees: ['3'] },
                { TaskID: 4, Employees: [] },
            ];

            let employees = [
                { EmployeeID: '1', FullName: 'Nguyễn Văn An', storeImgName: null, paramImg: null },
                { EmployeeID: '2', FullName: 'Trần Thị Bình', storeImgName: null, paramImg: null },
                { EmployeeID: '3', FullName: 'Lê Văn Cường', storeImgName: null, paramImg: null },
                { EmployeeID: '4', FullName: 'Phạm Thị Dung', storeImgName: null, paramImg: null },
                { EmployeeID: '5', FullName: 'Hoàng Văn Em', storeImgName: null, paramImg: null },
                { EmployeeID: '6', FullName: 'Vũ Minh Quân', storeImgName: null, paramImg: null },
                { EmployeeID: '7', FullName: 'Đỗ Thị Hoa', storeImgName: null, paramImg: null },
                { EmployeeID: '8', FullName: 'Bùi Văn Khánh', storeImgName: null, paramImg: null },
            ];

            // RENDER BẢNG
            function renderTasks() {
                const $body = $('#taskBody').empty();
                records.forEach((record) => {
                    $body.append(`
                        <tr>
                            <td>${record.TaskID}</td>
                            <td class="emp-selector" data-field="Employees"></td>
                        </tr>
                    `);
                });
                applySelectors();
                $('#dataPreview').text(JSON.stringify(records, null, 2));
            }

            // CONTROL EMPLOYEE SELECTOR - AUTOSAVE TYPE 1 (ĐÃ SỬA: dropdown absolute, scroll theo cha)
            function hpaControlEmployeeSelector(el) {
                const $el = $(el);

                // CSS đẹp chuẩn (đã cập nhật dropdown thành absolute)
                if (!window.__hpaEmpSelectorCSS) {
                    window.__hpaEmpSelectorCSS = true;
                    const style = document.createElement('style');
                    style.textContent = `
                        .hpa-emp-wrapper { position: relative; width: 100%; }
                        .hpa-emp-btn {
                            display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border: 1px solid #e6edf3; border-radius: 20px; cursor: pointer; background: #fff; box-shadow: 0 1px 2px rgba(16,24,40,0.04); width: 100%; font-size: 13px; min-height: 38px;
                        }
                        .hpa-emp-btn:hover { border-color: #c7d2da; }
                        .hpa-emp-chips { display: flex; align-items: center; gap: 0; flex: 1; min-width: 0; }
                        .hpa-emp-chip {
                            border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.12); margin-left: -8px; width: 32px; height: 32px; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 11px; color: #495057;
                        }
                        .hpa-emp-chip:first-child { margin-left: 0; }
                        .hpa-emp-chip img { width: 100%; height: 100%; object-fit: cover; }
                        .hpa-emp-count { font-weight: 600; color: #495057; margin-left: 4px; }
                        .hpa-emp-icon { margin-left: auto; color: #6c757d; }
                        .hpa-emp-btn.open .hpa-emp-icon { transform: rotate(180deg); }

                        /* Dropdown giờ là absolute, nằm trong wrapper */
                        .hpa-emp-dropdown {
                            position: absolute;
                            top: 100%;
                            left: 0;
                            margin-top: 4px;
                            z-index: 9999;
                            background: white;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                            width: 380px;
                            max-height: 400px;
                            overflow: hidden;
                            display: none;
                        }
                        .hpa-emp-dropdown.open {
                            display: block;
                        }
                        /* Khi mở lên trên */
                        .hpa-emp-dropdown.upward {
                            top: auto;
                            bottom: 100%;
                            margin-top: 0;
                            margin-bottom: 4px;
                        }

                        .hpa-emp-header { padding: 12px; border-bottom: 1px solid #dee2e6; background: #f8f9fa; }
                        .hpa-emp-search { width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; outline: none; }
                        .hpa-emp-search:focus { border-color: #01579b; box-shadow: 0 0 0 3px rgba(1,87,155,0.1); }
                        .hpa-emp-body { overflow-y: auto; max-height: 340px; }
                        .hpa-emp-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
                        .hpa-emp-item:hover { background: #e3f2fd; }
                        .hpa-emp-item.selected { background: #01579b; color: white; }

                        .hpa-emp-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: transparent; z-index: 9998; display: none; }
                        .hpa-emp-backdrop.open { display: block; }
                    `;
                    document.head.appendChild(style);
                }

                const uniqueId = 'emp_' + Date.now();
                const wrapper = $(`<div class="hpa-emp-wrapper"></div>`);
                const btn = $(
                    `<div class="hpa-emp-btn"><div class="hpa-emp-chips"></div><span class="hpa-emp-icon"><i class="bi bi-chevron-down"></i></span></div>`
                );
                const dropdown = $(`<div id="${uniqueId}_dropdown" class="hpa-emp-dropdown">
                    <div class="hpa-emp-header"><input type="text" class="hpa-emp-search" placeholder="Tìm kiếm nhân viên..."></div>
                    <div class="hpa-emp-body"><div class="hpa-emp-items"></div></div>
                </div>`);
                const backdrop = $(`<div id="${uniqueId}_backdrop" class="hpa-emp-backdrop"></div>`);

                // Chỉ append dropdown vào wrapper, backdrop vào body
                wrapper.append(btn).append(dropdown);
                $('body').append(backdrop);
                $el.empty().append(wrapper);

                let selected = [];

                function getInitials(name) {
                    const words = name.trim().split(/\s+/);
                    if (words.length >= 2) return (words[0][0] + words[words.length - 1][0]).toUpperCase();
                    return name.substring(0, 2).toUpperCase();
                }

                function renderButton() {
                    const $chips = btn.find('.hpa-emp-chips').empty();
                    if (selected.length === 0) {
                        $chips.html(`<span style="color:#78909c">Chọn nhân viên</span>`);
                    } else {
                        const visible = selected.slice(0, 3);
                        visible.forEach((id) => {
                            const emp = employees.find((e) => e.EmployeeID === id);
                            if (emp) {
                                const initials = getInitials(emp.FullName);
                                $chips.append(`<div class="hpa-emp-chip" title="${emp.FullName}">${initials}</div>`);
                            }
                        });
                        if (selected.length > 3) {
                            $chips.append(`<span class="hpa-emp-count">+${selected.length - 3}</span>`);
                        }
                    }
                }

                function renderList(filter = '') {
                    const $items = dropdown.find('.hpa-emp-items').empty();
                    let filtered = employees;
                    if (filter) {
                        const q = filter.toLowerCase();
                        filtered = employees.filter((e) => e.FullName.toLowerCase().includes(q));
                    }

                    filtered.forEach((emp) => {
                        const isSel = selected.includes(emp.EmployeeID);
                        const initials = getInitials(emp.FullName);
                        const item = $(`<div class="hpa-emp-item ${isSel ? 'selected' : ''}">
                            <div class="hpa-emp-chip">${initials}</div>
                            <span>${emp.FullName}</span>
                        </div>`);
                        item.on('click', () => {
                            const idx = selected.indexOf(emp.EmployeeID);
                            if (idx === -1) selected.push(emp.EmployeeID);
                            else selected.splice(idx, 1);
                            renderButton();
                            renderList(filter);

                            // AutoSave
                            const rowId = $el.closest('tr').find('td:first').text();
                            const record = records.find((r) => r.TaskID == rowId);
                            if (record) record.Employees = selected.slice();
                            renderTasks();
                            alert('Cập nhật nhân viên thành công!');
                        });
                        $items.append(item);
                    });

                    if (filter) {
                        const create = $(`<div class="hpa-emp-item" style="font-weight:600;color:#01579b">+ Thêm mới: "${filter}"</div>`);
                        create.on('click', () => {
                            const newId = 'new_' + Date.now();
                            const newEmp = { EmployeeID: newId, FullName: filter };
                            employees.unshift(newEmp);
                            selected.push(newId);
                            renderButton();
                            renderList(filter);
                            renderTasks();
                            alert('Đã tạo nhân viên mới!');
                        });
                        $items.prepend(create);
                    }
                }

                // Hàm kiểm tra và điều chỉnh hướng dropdown
                function adjustDropdownDirection() {
                    dropdown.removeClass('upward');
                    const wrapperRect = wrapper[0].getBoundingClientRect();
                    const spaceBelow = window.innerHeight - wrapperRect.bottom;
                    const dropdownHeight = dropdown.outerHeight() || 400;

                    if (spaceBelow < dropdownHeight + 20) {
                        dropdown.addClass('upward');
                    }
                }

                btn.on('click', (e) => {
                    e.stopPropagation();
                    $('.hpa-emp-dropdown').not(dropdown).removeClass('open').hide();
                    $('.hpa-emp-backdrop').not(backdrop).removeClass('open');
                    btn.toggleClass('open');

                    if (btn.hasClass('open')) {
                        adjustDropdownDirection();
                        dropdown.addClass('open').show();
                        backdrop.addClass('open');
                        dropdown.find('.hpa-emp-search').focus();
                        renderList('');
                        // Search handler
                        dropdown
                            .find('.hpa-emp-search')
                            .off('input')
                            .on('input', function () {
                                renderList($(this).val());
                            });
                    } else {
                        dropdown.removeClass('open').hide();
                        backdrop.removeClass('open');
                    }
                });

                backdrop.on('click', () => {
                    btn.removeClass('open');
                    dropdown.removeClass('open').hide();
                    backdrop.removeClass('open');
                });

                $(document).on('click', (e) => {
                    if (!wrapper.is(e.target) && wrapper.has(e.target).length === 0 && !dropdown.is(e.target) && dropdown.has(e.target).length === 0) {
                        btn.removeClass('open');
                        dropdown.removeClass('open').hide();
                        backdrop.removeClass('open');
                    }
                });

                // Load giá trị ban đầu
                const rowId = $el.closest('tr').find('td:first').text();
                const record = records.find((r) => r.TaskID == rowId);
                if (record && record.Employees) selected = record.Employees.slice();
                renderButton();
            }

            function applySelectors() {
                $('.emp-selector').each(function () {
                    hpaControlEmployeeSelector(this);
                });
            }

            $(document).ready(renderTasks);
        </script>
    </body>
</html>

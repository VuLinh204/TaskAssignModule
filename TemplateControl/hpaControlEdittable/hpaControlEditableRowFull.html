<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>hpaControlEditableRow - FULL (AutoSave + Dữ liệu mẫu)</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            body {
                padding: 40px;
                background: #f8f9fa;
                font-family: system-ui, -apple-system, sans-serif;
            }
            h2 {
                color: #155724;
            }
            .table {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                table-layout: fixed; /* QUAN TRỌNG: ép table tôn trọng width của th */
                width: 100%;
            }
            pre {
                background: #fff;
                border: 1px solid #dee2e6;
            }
            /* Phân bổ width hợp lý cho các cột */
            th.col-id {
                width: 80px;
            }
            th.col-name {
                width: 30%;
            }
            th.col-desc {
                width: 45%;
            }
            th.col-status {
                width: 25%;
            }

            /* Đảm bảo td theo đúng width của th */
            td {
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <h2 class="mb-4">hpaControlEditableRow - Phiên bản FULL (Đã sửa lỗi co cột)</h2>
        <p>Cột rộng đẹp • Ellipsis nội dung dài • Không min-width • AutoSave + allowAdd • UI/UX chuẩn như hệ thống thật</p>

        <table class="table table-bordered table-hover align-middle">
            <thead class="table-success">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-name">Tên Task</th>
                    <th class="col-desc">Mô tả (textarea)</th>
                    <th class="col-status">Trạng thái</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>

        <div class="mt-5">
            <h5>Dữ liệu mẫu hiện tại (cập nhật real-time):</h5>
            <pre id="dataPreview" class="p-3 rounded shadow-sm"></pre>
        </div>

        <script>
            // ==================== DỮ LIỆU MẪU ====================
            let tasks = [
                {
                    TaskID: 1,
                    TaskName: 'Thiết kế giao diện dashboard',
                    Description: 'Trang chủ mới với chart realtime và dark mode hỗ trợ responsive trên mọi thiết bị',
                    Status: 'Đang làm',
                },
                {
                    TaskID: 2,
                    TaskName: 'Viết API quản lý user',
                    Description: 'CRUD + phân quyền role admin/user, hỗ trợ JWT authentication và refresh token',
                    Status: 'Chưa làm',
                },
                { TaskID: 3, TaskName: 'Test chức năng thanh toán VNPay', Description: '', Status: 'Hoàn thành' },
                { TaskID: 4, TaskName: '', Description: '', Status: '' }, // Để test thêm mới
            ];

            let nextId = 5;

            // ==================== RENDER ====================
            function renderTasks() {
                const $body = $('#taskBody').empty();
                tasks.forEach((task) => {
                    const row = `
                    <tr>
                        <td>${task.TaskID || ''}</td>
                        <td class="editable" data-id="${task.TaskID}" data-col="TaskName">${task.TaskName || ''}</td>
                        <td class="editable" data-id="${task.TaskID}" data-col="Description">${task.Description || ''}</td>
                        <td class="editable" data-id="${task.TaskID}" data-col="Status">${task.Status || ''}</td>
                    </tr>`;
                    $body.append(row);
                });
                applyControls();
                updatePreview();
            }

            function updatePreview() {
                $('#dataPreview').text(JSON.stringify(tasks, null, 2));
            }

            // ==================== CONTROL - ĐÃ SỬA LAYOUT TABLE ====================
            function hpaControlEditableRow(el, config) {
                const $el = $(el);
                const cfg = {
                    type: config.type || 'input',
                    silent: config.silent || false,
                    allowAdd: config.allowAdd || true,
                    onSave: config.onSave || null,
                };

                // CSS chuẩn – quan trọng: display: table-cell để không phá layout table
                if (!window.__hpaEditableRowCSSInjected) {
                    const style = document.createElement('style');
                    style.textContent = `
                        .hpa-editable-row.control-editable { 
                            cursor: pointer; 
                            padding: 8px 4px; 
                            border-radius: 4px; 
                            transition: all 0.2s; 
                            display: table-cell !important; /* QUAN TRỌNG: giữ layout table */
                            vertical-align: middle; 
                            box-sizing: border-box; 
                            min-height: 1.5em; 
                            width: 100%;
                        }
                        .hpa-editable-row.control-editable:hover { background: #e8f5e9; }
                        .hpa-editable-row.control-editable.editing { 
                            padding: 4px 8px; 
                            z-index: 100 !important; 
                            background: white; 
                            display: table-cell !important;
                        }
                        .hpa-editable-row.control-editable.editing input,
                        .hpa-editable-row.control-editable.editing textarea { 
                            width: 100% !important; 
                            font-size: inherit; 
                            font-weight: inherit; 
                            padding: 6px 10px; 
                            border: 1px solid #1c975e !important; 
                            box-sizing: border-box; 
                        }
                        .hpa-editable-row.control-editable .edit-actions { 
                            position: absolute; 
                            top: 110%; 
                            left: 0; 
                            right: 0; 
                            display: flex; 
                            justify-content: flex-end;
                            gap: 4px; 
                            align-items: center; 
                            z-index: 100 !important; 
                            background: white; 
                            padding: 6px 8px; 
                            border: 1px solid #ddd; 
                            border-radius: 6px; 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                        }
                        .hpa-editable-row.control-editable .btn-edit { 
                            width: 28px; 
                            height: 28px; 
                            padding: 0; 
                            display: inline-flex; 
                            align-items: center; 
                            justify-content: center; 
                            border-radius: 4px; 
                            border: 1px solid #e8eaed; 
                            background: white; 
                            cursor: pointer; 
                            transition: all 0.2s; 
                            font-size: 14px; 
                        }
                        .hpa-editable-row.control-editable .btn-edit:hover { transform: scale(1.1); }
                        .hpa-editable-row.control-editable .btn-edit.btn-save { background: #2E7D32; color: white; border-color: #2E7D32; }
                        .hpa-editable-row.control-editable .btn-edit.btn-save:hover { background: #1c975e; }
                        .hpa-editable-row.control-editable .btn-edit.btn-cancel { background: #fff; color: #676879; }
                        .hpa-editable-row.control-editable .btn-edit.btn-cancel:hover { background: #f5f5f5; color: #E53935; }
                        /* Ellipsis đẹp khi không edit */
                        .hpa-editable-row.control-editable:not(.editing) { 
                            white-space: nowrap; 
                            overflow: hidden; 
                            text-overflow: ellipsis; 
                        }
                    `;
                    document.head.appendChild(style);
                    window.__hpaEditableRowCSSInjected = true;
                }

                $el.addClass('hpa-editable-row control-editable');

                $el.off('click.control-editable').on('click.control-editable', function (e) {
                    $('.hpa-editable-row.editing').not($el).find('.btn-save').trigger('click');

                    e.stopPropagation();
                    e.preventDefault();
                    if ($el.hasClass('editing')) return;

                    const curVal = $el.text().trim();
                    $el.css({ 'white-space': 'normal', overflow: 'visible' });

                    const $input =
                        cfg.type === 'textarea'
                            ? $(`<textarea class="form-control form-control-sm" rows="3">`).val(curVal)
                            : $(`<input type="text" class="form-control form-control-sm">`).val(curVal);

                    let isAddMode = false;
                    let recordId = $el.data('id');

                    const $save = $(`<button class="btn-edit btn-save" title="Lưu"><i class="bi bi-check-lg"></i></button>`);
                    const $cancel = $(`<button class="btn-edit btn-cancel" title="Hủy"><i class="bi bi-x-lg"></i></button>`);

                    const updateButtonState = () => {
                        const isEmpty = $input.val().trim().length === 0;
                        if (cfg.allowAdd && isEmpty && !isAddMode) {
                            isAddMode = true;
                            recordId = null;
                            $save.html(`<i class="bi bi-plus-lg"></i>`).attr('title', 'Thêm mới');
                        }
                    };

                    const $actions = $(`<div class="edit-actions"></div>`).append($save).append($cancel);
                    const $wrap = $(`<div class="position-relative w-100"></div>`).append($input).append($actions);

                    $el.addClass('editing').html('').append($wrap);

                    setTimeout(() => {
                        const inputEl = $input[0];
                        inputEl.focus();
                        inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length);
                    }, 50);

                    const finish = (saveIt) => {
                        const newVal = $input.val().trim();

                        // Cleanup
                        $save.off('click');
                        $cancel.off('click');
                        $input.off();
                        $(document).off('click.hpaEditable');
                        $el.removeClass('editing');

                        if (!saveIt || (newVal === curVal && !isAddMode)) {
                            $el.text(curVal);
                            return;
                        }

                        $el.text('Đang lưu...');
                        setTimeout(() => {
                            let currentId = recordId || $el.data('id');

                            if (isAddMode) {
                                currentId = nextId++;
                                tasks.push({ TaskID: currentId, TaskName: '', Description: '', Status: '' });
                            }

                            const col = $el.data('col');
                            const task = tasks.find((t) => t.TaskID == currentId);
                            if (task) task[col] = newVal;

                            renderTasks();

                            if (!cfg.silent) alert(isAddMode ? 'Thêm mới thành công!' : 'Cập nhật thành công!');
                            if (cfg.onSave) cfg.onSave(newVal, isAddMode, currentId);
                        }, 800);
                    };

                    $save.on('click', (e) => {
                        e.stopPropagation();
                        finish(true);
                    });
                    $cancel.on('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        finish(false);
                    });
                    $input.on('input', updateButtonState);
                    $input.on('keydown', (e) => {
                        if (e.key === 'Enter' && cfg.type !== 'textarea') {
                            e.preventDefault();
                            finish(true);
                        }
                        if (e.key === 'Escape') finish(false);
                    });
                    $(document).one('click.hpaEditable', (e) => !$(e.target).closest($el).length && finish(true));
                });
            }

            // ==================== ÁP DỤNG ====================
            function applyControls() {
                $('.editable').each(function () {
                    const type = $(this).data('col') === 'Description' ? 'textarea' : 'input';
                    hpaControlEditableRow(this, { type: type });
                });
            }

            $(document).ready(renderTasks);
        </script>
    </body>
</html>
